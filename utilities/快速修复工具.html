<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€Ÿä¿®å¤å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .intro {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border-left: 4px solid #667eea;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .section h2 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section p {
      color: #6c757d;
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-warning {
      background: #ffc107;
      color: #000;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    
    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin: 10px 0;
    }
    
    .emoji {
      font-size: 24px;
    }
  </style>
  <link rel="stylesheet" href="modern-theme.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ YouTubeå·¥å…·å¿«é€Ÿä¿®å¤</h1>
    
    <div class="intro">
      <strong>æ­¤å·¥å…·å¯ä»¥å¸®åŠ©æ‚¨å¿«é€Ÿè§£å†³å·¥å…·ä½¿ç”¨ä¸­é‡åˆ°çš„é—®é¢˜ã€‚</strong>
      <br><br>
      è¯·æ ¹æ®é‡åˆ°çš„é—®é¢˜é€‰æ‹©ç›¸åº”çš„ä¿®å¤æ–¹æ¡ˆã€‚å¦‚æœä¸ç¡®å®šï¼Œå¯ä»¥ä¾æ¬¡å°è¯•ã€‚
    </div>
    
    <!-- è¯Šæ–­ä¿¡æ¯ -->
    <div class="section">
      <h2><span class="emoji">ğŸ”</span> ç³»ç»Ÿè¯Šæ–­</h2>
      <p>é¦–å…ˆè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å½“å‰çŠ¶æ€ï¼š</p>
      <button class="btn" onclick="runDiagnostics()">è¿è¡Œè¯Šæ–­</button>
      <div id="diagnosticsResult" class="status"></div>
    </div>
    
    <!-- å¸¸è§„ä¿®å¤ -->
    <div class="section">
      <h2><span class="emoji">ğŸ”„</span> å¸¸è§„ä¿®å¤</h2>
      <p>è¿™äº›æ“ä½œä¸ä¼šåˆ é™¤æ•°æ®ï¼Œå¯ä»¥å®‰å…¨å°è¯•ã€‚</p>
      
      <button class="btn" onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
      <button class="btn" onclick="hardRefresh()">å¼ºåˆ¶åˆ·æ–°</button>
      <button class="btn btn-success" onclick="migrateData()">æ‰‹åŠ¨è¿ç§»æ•°æ®</button>
      
      <div id="normalFixResult" class="status"></div>
    </div>
    
    <!-- localStorage æ¸…ç† -->
    <div class="section">
      <h2><span class="emoji">ğŸ—‘ï¸</span> æ¸…ç†æ—§æ•°æ®</h2>
      <p>æ¸…ç† localStorage ä¸­çš„æ—§æ•°æ®ï¼ˆIndexedDB æ•°æ®ä¸å—å½±å“ï¼‰</p>
      
      <button class="btn btn-warning" onclick="clearLocalStorageData()">æ¸…ç† localStorage</button>
      
      <div id="cleanResult" class="status"></div>
    </div>
    
    <!-- æ•°æ®åº“é‡ç½® -->
    <div class="section">
      <h2><span class="emoji">âš ï¸</span> æ•°æ®åº“é‡ç½®</h2>
      <p><strong>è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼</strong><br>
      è¯·å…ˆåœ¨åšä¸»ç®¡ç†å·¥å…·ä¸­å¯¼å‡ºæ•°æ®å¤‡ä»½ã€‚</p>
      
      <button class="btn btn-danger" onclick="resetIndexedDB()">é‡ç½® IndexedDB</button>
      <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      
      <div id="resetResult" class="status"></div>
    </div>
    
    <!-- æ‰‹åŠ¨æ“ä½œæŒ‡å— -->
    <div class="section">
      <h2><span class="emoji">ğŸ“</span> æ‰‹åŠ¨æ“ä½œ</h2>
      <p>å¦‚æœè‡ªåŠ¨ä¿®å¤æ— æ•ˆï¼Œå¯ä»¥å°è¯•è¿™äº›æ‰‹åŠ¨æ“ä½œï¼š</p>
      
      <h3 style="margin-top: 15px; color: #495057;">åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼ˆæŒ‰ F12 æ‰“å¼€ï¼‰ï¼š</h3>
      
      <p><strong>1. å®Œå…¨é‡ç½®ï¼ˆåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰ï¼š</strong></p>
      <div class="code-block">indexedDB.deleteDatabase('YouTubeToolDB');<br>localStorage.clear();<br>location.reload();</div>
      
      <p><strong>2. åªæ¸…é™¤ IndexedDBï¼š</strong></p>
      <div class="code-block">indexedDB.deleteDatabase('YouTubeToolDB');<br>location.reload();</div>
      
      <p><strong>3. æ£€æŸ¥å­˜å‚¨é…é¢ï¼š</strong></p>
      <div class="code-block">navigator.storage.estimate().then(e => {<br>  console.log('å·²ç”¨:', (e.usage/1024/1024).toFixed(2), 'MB');<br>  console.log('æ€»è®¡:', (e.quota/1024/1024).toFixed(2), 'MB');<br>});</div>
      
      <p><strong>4. æŸ¥çœ‹ localStorage æ•°æ®ï¼š</strong></p>
      <div class="code-block">console.log('API Key:', localStorage.getItem('youtubeApiKey'));<br>console.log('åšä¸»æ•°æ®:', localStorage.getItem('youtubeChannels'));</div>
    </div>
    
    <!-- å¸®åŠ©ä¿¡æ¯ -->
    <div class="section">
      <h2><span class="emoji">â„¹ï¸</span> éœ€è¦æ›´å¤šå¸®åŠ©ï¼Ÿ</h2>
      <p>
        1. æŸ¥çœ‹ <strong>../docs/æ•…éšœæ’é™¤æŒ‡å—.md</strong> è·å–è¯¦ç»†è¯´æ˜<br>
        2. ä½¿ç”¨ <strong>å­˜å‚¨çŠ¶æ€æ£€æŸ¥.html</strong> æŸ¥çœ‹è¯¦ç»†çŠ¶æ€<br>
        3. è®°å½•æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ä¸­çš„é”™è¯¯ä¿¡æ¯
      </p>
    </div>
  </div>
  
  <script>
    // è¿è¡Œè¯Šæ–­
    async function runDiagnostics() {
      const result = document.getElementById('diagnosticsResult');
      result.className = 'status info';
      result.innerHTML = 'æ­£åœ¨è¯Šæ–­...';
      
      const diagnostics = [];
      
      try {
        // æ£€æŸ¥ IndexedDB æ”¯æŒ
        if (!window.indexedDB) {
          diagnostics.push('âŒ æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB');
        } else {
          diagnostics.push('âœ… IndexedDB æ”¯æŒæ­£å¸¸');
        }
        
        // æ£€æŸ¥ localStorage
        try {
          localStorage.setItem('test', 'test');
          localStorage.removeItem('test');
          diagnostics.push('âœ… localStorage å¯ç”¨');
        } catch (e) {
          diagnostics.push('âŒ localStorage ä¸å¯ç”¨: ' + e.message);
        }
        
        // æ£€æŸ¥ç°æœ‰æ•°æ®
        const hasLocalStorage = localStorage.getItem('youtubeChannels') !== null;
        diagnostics.push(hasLocalStorage ? 
          'âš ï¸ æ£€æµ‹åˆ° localStorage æ—§æ•°æ®' : 
          'âœ… localStorage æ— æ—§æ•°æ®');
        
        // æ£€æŸ¥ IndexedDB
        const dbRequest = indexedDB.open('YouTubeToolDB', 2);
        
        dbRequest.onsuccess = () => {
          const db = dbRequest.result;
          const hasSettings = db.objectStoreNames.contains('settings');
          const hasChannels = db.objectStoreNames.contains('channels');
          
          diagnostics.push(hasSettings ? 
            'âœ… settings å­˜å‚¨å­˜åœ¨' : 
            'âŒ settings å­˜å‚¨ä¸å­˜åœ¨');
          diagnostics.push(hasChannels ? 
            'âœ… channels å­˜å‚¨å­˜åœ¨' : 
            'âš ï¸ channels å­˜å‚¨ä¸å­˜åœ¨');
          
          db.close();
          
          result.className = 'status success';
          result.innerHTML = '<strong>è¯Šæ–­å®Œæˆï¼š</strong><br>' + diagnostics.join('<br>');
        };
        
        dbRequest.onerror = () => {
          diagnostics.push('âŒ IndexedDB æ‰“å¼€å¤±è´¥: ' + dbRequest.error);
          result.className = 'status error';
          result.innerHTML = '<strong>è¯Šæ–­å®Œæˆï¼š</strong><br>' + diagnostics.join('<br>');
        };
        
      } catch (error) {
        result.className = 'status error';
        result.innerHTML = 'è¯Šæ–­å¤±è´¥: ' + error.message;
      }
    }
    
    // åˆ·æ–°é¡µé¢
    function refreshPage() {
      location.reload();
    }
    
    // å¼ºåˆ¶åˆ·æ–°
    function hardRefresh() {
      location.reload(true);
    }
    
    // æ‰‹åŠ¨è¿ç§»æ•°æ®
    async function migrateData() {
      const result = document.getElementById('normalFixResult');
      result.className = 'status info';
      result.innerHTML = 'æ­£åœ¨è¿ç§»æ•°æ®...';
      
      try {
        const oldApiKey = localStorage.getItem('youtubeApiKey');
        const oldChannels = localStorage.getItem('youtubeChannels');
        
        if (!oldApiKey && !oldChannels) {
          result.className = 'status info';
          result.innerHTML = 'æ²¡æœ‰å‘ç°éœ€è¦è¿ç§»çš„æ•°æ®';
          return;
        }
        
        // æ‰“å¼€æ•°æ®åº“
        const dbRequest = indexedDB.open('YouTubeToolDB', 2);
        
        dbRequest.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('settings')) {
            db.createObjectStore('settings', { keyPath: 'key' });
          }
          if (!db.objectStoreNames.contains('channels')) {
            const channelStore = db.createObjectStore('channels', { keyPath: 'channelId' });
            channelStore.createIndex('addedAt', 'addedAt', { unique: false });
            channelStore.createIndex('name', 'name', { unique: false });
          }
        };
        
        dbRequest.onsuccess = async () => {
          const db = dbRequest.result;
          let migrated = [];
          
          // è¿ç§» API Key
          if (oldApiKey) {
            const tx1 = db.transaction(['settings'], 'readwrite');
            tx1.objectStore('settings').put({ key: 'youtubeApiKey', value: oldApiKey });
            await new Promise(resolve => tx1.oncomplete = resolve);
            migrated.push('API Key');
          }
          
          // è¿ç§»é¢‘é“æ•°æ®
          if (oldChannels) {
            const channels = JSON.parse(oldChannels);
            const tx2 = db.transaction(['channels'], 'readwrite');
            const store = tx2.objectStore('channels');
            for (const channel of channels) {
              store.put(channel);
            }
            await new Promise(resolve => tx2.oncomplete = resolve);
            migrated.push(`${channels.length} ä¸ªåšä¸»`);
          }
          
          db.close();
          
          result.className = 'status success';
          result.innerHTML = `âœ… è¿ç§»æˆåŠŸï¼å·²è¿ç§»: ${migrated.join(', ')}<br><br>å»ºè®®æ¸…ç† localStorage æ—§æ•°æ®`;
        };
        
        dbRequest.onerror = () => {
          result.className = 'status error';
          result.innerHTML = 'è¿ç§»å¤±è´¥: ' + dbRequest.error;
        };
        
      } catch (error) {
        result.className = 'status error';
        result.innerHTML = 'è¿ç§»å¤±è´¥: ' + error.message;
      }
    }
    
    // æ¸…ç† localStorage
    function clearLocalStorageData() {
      const result = document.getElementById('cleanResult');
      
      try {
        const hadApiKey = localStorage.getItem('youtubeApiKey') !== null;
        const hadChannels = localStorage.getItem('youtubeChannels') !== null;
        
        localStorage.removeItem('youtubeApiKey');
        localStorage.removeItem('youtubeChannels');
        
        if (!hadApiKey && !hadChannels) {
          result.className = 'status info';
          result.innerHTML = 'localStorage ä¸­æ²¡æœ‰æ•°æ®';
        } else {
          result.className = 'status success';
          result.innerHTML = 'âœ… localStorage å·²æ¸…ç†<br>IndexedDB æ•°æ®æœªå—å½±å“';
        }
      } catch (error) {
        result.className = 'status error';
        result.innerHTML = 'æ¸…ç†å¤±è´¥: ' + error.message;
      }
    }
    
    // é‡ç½® IndexedDB
    async function resetIndexedDB() {
      if (!confirm('âš ï¸ æ­¤æ“ä½œå°†åˆ é™¤ IndexedDB ä¸­çš„æ‰€æœ‰æ•°æ®ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }
      
      if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤å—ï¼Ÿ\n\nå»ºè®®å…ˆå¯¼å‡ºæ•°æ®å¤‡ä»½ï¼')) {
        return;
      }
      
      const result = document.getElementById('resetResult');
      result.className = 'status info';
      result.innerHTML = 'æ­£åœ¨é‡ç½®æ•°æ®åº“...';
      
      try {
        const deleteRequest = indexedDB.deleteDatabase('YouTubeToolDB');
        
        deleteRequest.onsuccess = () => {
          result.className = 'status success';
          result.innerHTML = 'âœ… IndexedDB å·²é‡ç½®<br><br>è¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°æ‰“å¼€å·¥å…·';
        };
        
        deleteRequest.onerror = () => {
          result.className = 'status error';
          result.innerHTML = 'åˆ é™¤å¤±è´¥: ' + deleteRequest.error;
        };
        
        deleteRequest.onblocked = () => {
          result.className = 'status error';
          result.innerHTML = 'âš ï¸ æ“ä½œè¢«é˜»æ­¢<br>è¯·å…³é—­æ‰€æœ‰å·¥å…·æ ‡ç­¾é¡µåé‡è¯•';
        };
        
      } catch (error) {
        result.className = 'status error';
        result.innerHTML = 'é‡ç½®å¤±è´¥: ' + error.message;
      }
    }
    
    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    async function clearAllData() {
      if (!confirm('âš ï¸ æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆlocalStorage + IndexedDBï¼‰ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }
      
      if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      
      const result = document.getElementById('resetResult');
      result.className = 'status info';
      result.innerHTML = 'æ­£åœ¨æ¸…ç©ºæ‰€æœ‰æ•°æ®...';
      
      try {
        // æ¸…ç† localStorage
        localStorage.clear();
        
        // åˆ é™¤ IndexedDB
        const deleteRequest = indexedDB.deleteDatabase('YouTubeToolDB');
        
        deleteRequest.onsuccess = () => {
          result.className = 'status success';
          result.innerHTML = 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º<br><br>å°†åœ¨ 3 ç§’ååˆ·æ–°é¡µé¢...';
          setTimeout(() => location.reload(), 3000);
        };
        
        deleteRequest.onerror = () => {
          result.className = 'status error';
          result.innerHTML = 'æ¸…ç©ºå¤±è´¥: ' + deleteRequest.error;
        };
        
      } catch (error) {
        result.className = 'status error';
        result.innerHTML = 'æ¸…ç©ºå¤±è´¥: ' + error.message;
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæç¤º
    window.onload = () => {
      console.log('YouTubeå·¥å…·å¿«é€Ÿä¿®å¤å·²å°±ç»ª');
      console.log('å»ºè®®å…ˆè¿è¡Œè¯Šæ–­ï¼Œäº†è§£å½“å‰çŠ¶æ€');
    };
  </script>
</body>
</html>

