<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­˜å‚¨çŠ¶æ€æ£€æŸ¥å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      max-width: 800px;
      width: 100%;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .section h2 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .label {
      font-weight: 600;
      color: #495057;
    }
    
    .value {
      color: #212529;
      font-family: monospace;
    }
    
    .value.success {
      color: #28a745;
    }
    
    .value.warning {
      color: #ffc107;
    }
    
    .value.error {
      color: #dc3545;
    }
    
    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #6c757d;
    }
  </style>
  <link rel="stylesheet" href="modern-theme.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ” å­˜å‚¨çŠ¶æ€æ£€æŸ¥å·¥å…·</h1>
    
    <div class="alert alert-info">
      æ­¤å·¥å…·å¸®åŠ©æ‚¨æ£€æŸ¥ YouTube å·¥å…·çš„å­˜å‚¨çŠ¶æ€ï¼ŒåŒ…æ‹¬ localStorage å’Œ IndexedDB çš„ä½¿ç”¨æƒ…å†µã€‚
    </div>
    
    <div id="loadingDiv" class="loading">
      æ­£åœ¨æ£€æŸ¥å­˜å‚¨çŠ¶æ€...
    </div>
    
    <div id="resultDiv" style="display: none;">
      <!-- localStorage çŠ¶æ€ -->
      <div class="section">
        <h2>ğŸ“¦ localStorage çŠ¶æ€</h2>
        <div class="info-item">
          <span class="label">API Key (æ—§æ•°æ®):</span>
          <span class="value" id="localApiKey">-</span>
        </div>
        <div class="info-item">
          <span class="label">åšä¸»æ•°æ® (æ—§æ•°æ®):</span>
          <span class="value" id="localChannels">-</span>
        </div>
        <div class="info-item">
          <span class="label">localStorage æ€»å¤§å°:</span>
          <span class="value" id="localStorageSize">-</span>
        </div>
        <button class="btn btn-danger btn-sm" onclick="clearLocalStorage()">æ¸…ç† localStorage æ—§æ•°æ®</button>
      </div>
      
      <!-- IndexedDB çŠ¶æ€ -->
      <div class="section">
        <h2>ğŸ’¾ IndexedDB çŠ¶æ€</h2>
        <div class="info-item">
          <span class="label">æ•°æ®åº“çŠ¶æ€:</span>
          <span class="value" id="dbStatus">-</span>
        </div>
        <div class="info-item">
          <span class="label">æ•°æ®åº“ç‰ˆæœ¬:</span>
          <span class="value" id="dbVersion">-</span>
        </div>
        <div class="info-item">
          <span class="label">API Key (æ—§ç‰ˆ):</span>
          <span class="value" id="idbApiKey">-</span>
        </div>
        <div class="info-item">
          <span class="label">APIæ± æ•°é‡:</span>
          <span class="value" id="apiPoolCount">-</span>
        </div>
        <div class="info-item">
          <span class="label">åšä¸»æ•°é‡:</span>
          <span class="value" id="idbChannelCount">-</span>
        </div>
        <div class="info-item">
          <span class="label">æ•°æ®å¤§å° (ä¼°ç®—):</span>
          <span class="value" id="idbDataSize">-</span>
        </div>
        <button class="btn btn-secondary" onclick="checkStorage()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
        <button class="btn btn-danger" onclick="clearIndexedDB()">æ¸…ç©º IndexedDB</button>
        <button class="btn btn-danger" onclick="resetDatabase()">ğŸ”§ é‡ç½®æ•°æ®åº“</button>
      </div>
      
      <!-- å­˜å‚¨é…é¢ä¿¡æ¯ -->
      <div class="section">
        <h2>ğŸ’¿ æµè§ˆå™¨å­˜å‚¨é…é¢</h2>
        <div class="info-item">
          <span class="label">å·²ä½¿ç”¨ç©ºé—´:</span>
          <span class="value" id="usedQuota">-</span>
        </div>
        <div class="info-item">
          <span class="label">å¯ç”¨é…é¢:</span>
          <span class="value" id="totalQuota">-</span>
        </div>
        <div class="info-item">
          <span class="label">ä½¿ç”¨ç™¾åˆ†æ¯”:</span>
          <span class="value" id="quotaPercentage">-</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let db;
    
    // åˆå§‹åŒ–IndexedDBï¼ˆåªè¯»å–ï¼Œä¸å‡çº§ç‰ˆæœ¬ï¼‰
    function initDB() {
      return new Promise((resolve, reject) => {
        // ä¸æŒ‡å®šç‰ˆæœ¬å·ï¼Œæ‰“å¼€å½“å‰ç‰ˆæœ¬
        const request = indexedDB.open('YouTubeToolDB');
        
        request.onerror = () => {
          console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', request.error);
          reject(request.error);
        };
        
        request.onsuccess = () => {
          db = request.result;
          console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          // è¯Šæ–­å·¥å…·ä¸åº”è¯¥ä¿®æ”¹æ•°æ®åº“ç»“æ„
          console.warn('æ„å¤–è§¦å‘äº†æ•°æ®åº“å‡çº§ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿ');
          const db = event.target.result;
          
          // å¦‚æœæ˜¯å…¨æ–°æ•°æ®åº“ï¼Œåˆ›å»ºåŸºæœ¬ç»“æ„
          if (!db.objectStoreNames.contains('settings')) {
            db.createObjectStore('settings', { keyPath: 'key' });
          }
          
          // åˆ›å»ºchannelså­˜å‚¨
          if (!db.objectStoreNames.contains('channels')) {
            const channelStore = db.createObjectStore('channels', { keyPath: 'channelId' });
            channelStore.createIndex('addedAt', 'addedAt', { unique: false });
            channelStore.createIndex('name', 'name', { unique: false });
          }
          
          // åˆ›å»ºapiPoolå­˜å‚¨
          if (!db.objectStoreNames.contains('apiPool')) {
            const apiStore = db.createObjectStore('apiPool', { keyPath: 'id', autoIncrement: true });
            apiStore.createIndex('apiKey', 'apiKey', { unique: true });
            apiStore.createIndex('addedAt', 'addedAt', { unique: false });
          }
        };
      });
    }
    
    // ä»IndexedDBè¯»å–
    function getFromDB(key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['settings'], 'readonly');
        const store = transaction.objectStore('settings');
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result?.value);
        request.onerror = () => reject(request.error);
      });
    }
    
    // è·å–æ‰€æœ‰é¢‘é“
    function getAllChannels() {
      return new Promise((resolve, reject) => {
        try {
          // æ£€æŸ¥channelså­˜å‚¨æ˜¯å¦å­˜åœ¨
          if (!db.objectStoreNames.contains('channels')) {
            resolve([]);
            return;
          }
          
          const transaction = db.transaction(['channels'], 'readonly');
          const store = transaction.objectStore('channels');
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result || []);
          request.onerror = () => reject(request.error);
        } catch (error) {
          console.error('è·å–é¢‘é“æ•°æ®å¤±è´¥:', error);
          resolve([]);
        }
      });
    }
    
    // è·å–æ‰€æœ‰APIæ± 
    function getAllApiPool() {
      return new Promise((resolve, reject) => {
        try {
          // æ£€æŸ¥apiPoolå­˜å‚¨æ˜¯å¦å­˜åœ¨
          if (!db.objectStoreNames.contains('apiPool')) {
            resolve([]);
            return;
          }
          
          const transaction = db.transaction(['apiPool'], 'readonly');
          const store = transaction.objectStore('apiPool');
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result || []);
          request.onerror = () => reject(request.error);
        } catch (error) {
          console.error('è·å–APIæ± æ•°æ®å¤±è´¥:', error);
          resolve([]);
        }
      });
    }
    
    // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
    async function checkStorage() {
      document.getElementById('loadingDiv').style.display = 'block';
      document.getElementById('resultDiv').style.display = 'none';
      
      try {
        console.log('å¼€å§‹æ£€æŸ¥å­˜å‚¨çŠ¶æ€...');
        
        // åˆå§‹åŒ–æ•°æ®åº“
        await initDB();
        console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ');
        
        // æ£€æŸ¥localStorage
        const localApiKey = localStorage.getItem('youtubeApiKey');
        const localChannels = localStorage.getItem('youtubeChannels');
        
        document.getElementById('localApiKey').textContent = localApiKey ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨';
        document.getElementById('localApiKey').className = 'value ' + (localApiKey ? 'warning' : 'success');
        
        if (localChannels) {
          const channels = JSON.parse(localChannels);
          document.getElementById('localChannels').textContent = `${channels.length} ä¸ªåšä¸»`;
          document.getElementById('localChannels').className = 'value warning';
        } else {
          document.getElementById('localChannels').textContent = 'âŒ ä¸å­˜åœ¨';
          document.getElementById('localChannels').className = 'value success';
        }
        
        // è®¡ç®—localStorageå¤§å°
        let localStorageSize = 0;
        for (let key in localStorage) {
          if (localStorage.hasOwnProperty(key)) {
            localStorageSize += localStorage[key].length + key.length;
          }
        }
        document.getElementById('localStorageSize').textContent = formatBytes(localStorageSize * 2); // UTF-16
        
        // æ£€æŸ¥IndexedDB
        document.getElementById('dbStatus').textContent = 'âœ… å·²è¿æ¥';
        document.getElementById('dbStatus').className = 'value success';
        
        // æ˜¾ç¤ºæ•°æ®åº“ç‰ˆæœ¬
        document.getElementById('dbVersion').textContent = `v${db.version}`;
        document.getElementById('dbVersion').className = 'value success';
        
        const idbApiKey = await getFromDB('youtubeApiKey');
        document.getElementById('idbApiKey').textContent = idbApiKey ? 'âœ… å·²ä¿å­˜ (æ—§ç‰ˆ)' : 'âŒ æœªä¿å­˜';
        document.getElementById('idbApiKey').className = 'value ' + (idbApiKey ? 'warning' : 'success');
        
        // æ£€æŸ¥APIæ± 
        const apiPool = await getAllApiPool();
        document.getElementById('apiPoolCount').textContent = `${apiPool.length} ä¸ª`;
        document.getElementById('apiPoolCount').className = 'value ' + (apiPool.length > 0 ? 'success' : 'error');
        console.log('APIæ± æ•°æ®:', apiPool);
        
        const channels = await getAllChannels();
        document.getElementById('idbChannelCount').textContent = `${channels.length} ä¸ª`;
        document.getElementById('idbChannelCount').className = 'value ' + (channels.length > 0 ? 'success' : 'error');
        
        const totalData = { channels, apiPool };
        const dataSize = new Blob([JSON.stringify(totalData)]).size;
        document.getElementById('idbDataSize').textContent = formatBytes(dataSize);
        
        // æ£€æŸ¥å­˜å‚¨é…é¢
        if (navigator.storage && navigator.storage.estimate) {
          const estimate = await navigator.storage.estimate();
          document.getElementById('usedQuota').textContent = formatBytes(estimate.usage || 0);
          document.getElementById('totalQuota').textContent = formatBytes(estimate.quota || 0);
          const percentage = estimate.quota ? ((estimate.usage / estimate.quota) * 100).toFixed(2) : 0;
          document.getElementById('quotaPercentage').textContent = percentage + '%';
          document.getElementById('quotaPercentage').className = 'value ' + (percentage > 80 ? 'error' : (percentage > 50 ? 'warning' : 'success'));
        } else {
          document.getElementById('usedQuota').textContent = 'ä¸æ”¯æŒ';
          document.getElementById('totalQuota').textContent = 'ä¸æ”¯æŒ';
          document.getElementById('quotaPercentage').textContent = 'ä¸æ”¯æŒ';
        }
        
      } catch (error) {
        console.error('âŒ æ£€æŸ¥å¤±è´¥:', error);
        
        let errorMsg = 'æ£€æŸ¥å¤±è´¥: ' + error.message;
        
        // æ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„æç¤º
        if (error.name === 'VersionError') {
          errorMsg += '\n\nå¯èƒ½åŸå› ï¼šæ•°æ®åº“ç‰ˆæœ¬å†²çª\nè§£å†³æ–¹æ¡ˆï¼šç‚¹å‡»"é‡ç½®æ•°æ®åº“"æŒ‰é’®';
        } else if (error.message.includes('blocked')) {
          errorMsg += '\n\nå¯èƒ½åŸå› ï¼šæœ‰å…¶ä»–æ ‡ç­¾é¡µæ­£åœ¨ä½¿ç”¨æ•°æ®åº“\nè§£å†³æ–¹æ¡ˆï¼šå…³é—­æ‰€æœ‰YouTubeå·¥å…·æ ‡ç­¾é¡µååˆ·æ–°';
        }
        
        alert(errorMsg);
        
        // å³ä½¿å‡ºé”™ä¹Ÿæ˜¾ç¤ºç»“æœåŒºåŸŸ
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('resultDiv').style.display = 'block';
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        document.getElementById('dbStatus').textContent = 'âŒ é”™è¯¯: ' + error.message;
        document.getElementById('dbStatus').className = 'value error';
      } finally {
        document.getElementById('loadingDiv').style.display = 'none';
      }
    }
    
    // æ¸…ç†localStorage
    function clearLocalStorage() {
      if (confirm('ç¡®å®šè¦æ¸…ç† localStorage ä¸­çš„æ—§æ•°æ®å—ï¼Ÿ\n\nè¯·ç¡®ä¿æ•°æ®å·²ç»è¿ç§»åˆ° IndexedDBï¼')) {
        localStorage.removeItem('youtubeApiKey');
        localStorage.removeItem('youtubeChannels');
        alert('âœ… localStorage æ—§æ•°æ®å·²æ¸…ç†');
        checkStorage();
      }
    }
    
    // æ¸…ç©ºIndexedDB
    async function clearIndexedDB() {
      if (confirm('ç¡®å®šè¦æ¸…ç©º IndexedDB çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼è¯·å…ˆå¯¼å‡ºæ•°æ®å¤‡ä»½ï¼')) {
        if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
          try {
            const stores = [];
            if (db.objectStoreNames.contains('settings')) stores.push('settings');
            if (db.objectStoreNames.contains('channels')) stores.push('channels');
            if (db.objectStoreNames.contains('apiPool')) stores.push('apiPool');
            
            if (stores.length === 0) {
              alert('æ²¡æœ‰å¯æ¸…ç©ºçš„æ•°æ®');
              return;
            }
            
            const transaction = db.transaction(stores, 'readwrite');
            const promises = stores.map(storeName => {
              return new Promise((resolve, reject) => {
                const req = transaction.objectStore(storeName).clear();
                req.onsuccess = resolve;
                req.onerror = reject;
              });
            });
            
            await Promise.all(promises);
            alert('âœ… IndexedDB æ•°æ®å·²æ¸…ç©º');
            checkStorage();
          } catch (error) {
            alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
            console.error('æ¸…ç©ºé”™è¯¯:', error);
          }
        }
      }
    }
    
    // é‡ç½®æ•°æ®åº“ï¼ˆåˆ é™¤å¹¶é‡å»ºï¼‰
    async function resetDatabase() {
      if (confirm('âš ï¸ æ­¤æ“ä½œå°†å®Œå…¨åˆ é™¤å¹¶é‡å»ºæ•°æ®åº“ï¼\n\næ‰€æœ‰æ•°æ®å°†ä¸¢å¤±ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦é‡ç½®æ•°æ®åº“å—ï¼Ÿ\n\nå»ºè®®å…ˆåœ¨åšä¸»ç®¡ç†å·¥å…·ä¸­å¯¼å‡ºæ•°æ®ï¼')) {
          try {
            // å…³é—­å½“å‰è¿æ¥
            if (db) {
              db.close();
            }
            
            // åˆ é™¤æ•°æ®åº“
            const deleteRequest = indexedDB.deleteDatabase('YouTubeToolDB');
            
            deleteRequest.onsuccess = async () => {
              console.log('æ•°æ®åº“å·²åˆ é™¤');
              alert('âœ… æ•°æ®åº“å·²é‡ç½®ï¼\n\nè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°æ‰“å¼€å·¥å…·ã€‚');
              
              // é‡æ–°åˆå§‹åŒ–
              await initDB();
              checkStorage();
            };
            
            deleteRequest.onerror = () => {
              console.error('åˆ é™¤æ•°æ®åº“å¤±è´¥:', deleteRequest.error);
              alert('åˆ é™¤æ•°æ®åº“å¤±è´¥: ' + deleteRequest.error);
            };
            
            deleteRequest.onblocked = () => {
              console.warn('æ•°æ®åº“åˆ é™¤è¢«é˜»æ­¢ï¼Œå¯èƒ½æœ‰å…¶ä»–æ ‡ç­¾é¡µåœ¨ä½¿ç”¨');
              alert('âš ï¸ æ•°æ®åº“åˆ é™¤è¢«é˜»æ­¢\n\nè¯·å…³é—­æ‰€æœ‰ä½¿ç”¨æ­¤å·¥å…·çš„æ ‡ç­¾é¡µï¼Œç„¶åé‡è¯•ã€‚');
            };
            
          } catch (error) {
            console.error('é‡ç½®æ•°æ®åº“å¤±è´¥:', error);
            alert('é‡ç½®å¤±è´¥: ' + error.message);
          }
        }
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    window.onload = checkStorage;
  </script>
</body>
</html>

