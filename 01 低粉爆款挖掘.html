<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube AIè§†é¢‘çˆ†æ¬¾åˆ†æå·¥å…·</title>
  <link rel="stylesheet" href="youtube-tools-p5-refined.css">
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <div class="logo">
        <a href="01 ä½ç²‰çˆ†æ¬¾æŒ–æ˜ .html">PHANTOM RADAR</a>
      </div>
      <div class="nav-menu">
        <ul>
          <li><a href="01 ä½ç²‰çˆ†æ¬¾æŒ–æ˜ .html" class="active">çˆ†æ¬¾æŒ–æ˜</a></li>
          <li><a href="02 YouTubeåšä¸»ç®¡ç†å·¥å…·.html">åšä¸»ç®¡ç†</a></li>
          <li><a href="03 è§†é¢‘ç›‘æ§å·¥å…·.html">è§†é¢‘ç›‘æ§</a></li>
          <li><a href="04 æ ‡ç­¾ç®¡ç†å·¥å…·.html">æ ‡ç­¾ç®¡ç†</a></li>
          <li><a href="APIæ± ç®¡ç†å·¥å…·.html">APIç®¡ç†</a></li>
        </ul>
      </div>
      <button class="mobile-menu-btn" aria-label="æ‰“å¼€ä¸»èœå•" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
  
  <div class="container">
    <div class="header">
      <h1>ğŸ¯ YouTube AIè§†é¢‘çˆ†æ¬¾åˆ†æå·¥å…·</h1>
      <p>å‘ç°ä¼˜è´¨å¯¹æ ‡è´¦å· | æŒ–æ˜ä½ç²‰çˆ†æ¬¾åˆ›ä½œè€…</p>
    </div>
    
    <div class="config-section card">
      <div class="input-group">
        <label for="apiKey">APIæ± çŠ¶æ€</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <div style="background: #0f0f13; padding: 12px 16px; border-radius: 6px; border: 1px solid #2a2a33; flex: 1;">
            <span style="color: #a7adb8; font-size: 14px;">APIæ± : </span>
            <span id="apiPoolStatus" style="color: var(--p5r-yellow); font-weight: 600; font-size: 14px;">0 å¯ç”¨</span>
            <span style="color: #a7adb8; font-size: 14px; margin-left: 8px;">|</span>
            <span id="currentApiInfo" style="color: #7ef29a; font-size: 14px; margin-left: 8px;">æ— å¯ç”¨API</span>
          </div>
        </div>
      </div>
      
      <div class="input-group">
        <label for="searchMode">æœç´¢æ¨¡å¼</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <button class="btn btn-secondary" id="singleModeBtn" onclick="switchSearchMode('single')" style="flex: 1;">å•æ ‡ç­¾æœç´¢</button>
          <button class="btn btn-primary" id="batchModeBtn" onclick="switchSearchMode('batch')" style="flex: 1;">æ‰¹é‡æ ‡ç­¾æœç´¢</button>
        </div>
      </div>
      
      <div class="input-group" id="singleSearchGroup">
        <label for="searchQuery">æœç´¢å…³é”®è¯</label>
        <input type="text" id="searchQuery" value="AI" placeholder="ä¾‹å¦‚: AI">
      </div>
      
      <div class="input-group" id="batchSearchGroup" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label for="batchSearchQuery">æ‰¹é‡æœç´¢æ ‡ç­¾ï¼ˆç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰</label>
          <div style="display: flex; gap: 8px;">
            <select id="tagGroupSelect" onchange="loadSelectedTagGroup()" style="padding: 6px 10px; background: #0f0f13; border: 1px solid #2a2a33; border-radius: 4px; color: #a7adb8; font-size: 13px;">
              <option value="">-- é€‰æ‹©æ ‡ç­¾ç»„ --</option>
            </select>
            <button class="btn btn-secondary" onclick="saveCurrentTagGroup()" style="padding: 6px 12px; font-size: 13px;">ğŸ’¾ ä¿å­˜æ ‡ç­¾ç»„</button>
            <button class="btn btn-secondary" onclick="manageTagGroups()" style="padding: 6px 12px; font-size: 13px;">ğŸ“‹ ç®¡ç†</button>
          </div>
        </div>
        <textarea id="batchSearchQuery" rows="4" placeholder="ä¾‹å¦‚:&#10;AI&#10;ChatGPT&#10;äººå·¥æ™ºèƒ½&#10;æˆ–: AI, ChatGPT, äººå·¥æ™ºèƒ½" style="width: 100%; padding: 10px; background: #0f0f13; border: 1px solid #2a2a33; border-radius: 6px; color: #e6e6e9; font-size: 14px; font-family: inherit; resize: vertical;">AI, ChatGPT, æœºå™¨å­¦ä¹ , æ·±åº¦å­¦ä¹ </textarea>
        <div style="margin-top: 12px; display: flex; gap: 20px; align-items: center;">
          <div style="flex: 1;">
            <label style="font-size: 12px; color: #a7adb8; margin-right: 8px;">æ¯ä¸ªæ ‡ç­¾ç»“æœæ•°:</label>
            <input type="number" id="resultsPerTag" value="10" min="5" max="50" style="width: 80px; padding: 6px 8px; background: #0f0f13; border: 1px solid #2a2a33; border-radius: 4px; color: #e6e6e9; font-size: 13px;">
          </div>
          <div style="flex: 1;">
            <label style="font-size: 12px; color: #a7adb8; display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="deduplicateVideos" checked style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
              <span>è‡ªåŠ¨å»é‡</span>
            </label>
          </div>
          <div style="flex: 1; font-size: 12px; color: #a7adb8;">
            <span id="tagCount">å·²è¾“å…¥ 0 ä¸ªæ ‡ç­¾</span>
          </div>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-analyze" onclick="fetchVideos()">ğŸ” å¼€å§‹åˆ†æ</button>
        <button class="btn btn-secondary" onclick="window.location.href='APIæ± ç®¡ç†å·¥å…·.html'">ğŸ”‘ APIç®¡ç†</button>
        <button id="switchApiBtn" class="btn btn-secondary" onclick="switchNextApi()">ğŸ”„ åˆ‡æ¢API</button>
        <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        <button id="selectionModeBtn" class="btn btn-secondary" onclick="toggleSelectionMode()">ğŸ§° è¿›å…¥é€‰æ‹©æ¨¡å¼</button>
        <button class="btn btn-secondary" onclick="testWeChatPush()">ğŸ“± æµ‹è¯•æ¨é€</button>
      </div>
    </div>
    
    <div class="filter-section card">
      <h3>ğŸ“Š ç­›é€‰æ¡ä»¶</h3>
      <div class="filter-grid">
        <div class="filter-item">
          <label>æœ€å¤§ç²‰ä¸æ•°</label>
          <input type="number" id="maxSubscribers" value="100000" placeholder="ä¾‹å¦‚: 100000">
        </div>
        <div class="filter-item">
          <label>æœ€å°è§‚çœ‹æ•°</label>
          <input type="number" id="minViews" value="10000" placeholder="ä¾‹å¦‚: 10000">
        </div>
        <div class="filter-item">
          <label>åœ°åŒº</label>
          <select id="regionFilter">
            <option value="">å…¨éƒ¨åœ°åŒº</option>
            <option value="US">ç¾å›½</option>
            <option value="CN">ä¸­å›½</option>
            <option value="JP">æ—¥æœ¬</option>
            <option value="KR">éŸ©å›½</option>
            <option value="GB">è‹±å›½</option>
            <option value="DE">å¾·å›½</option>
            <option value="FR">æ³•å›½</option>
          </select>
        </div>
        <div class="filter-item">
          <label>å‘å¸ƒæ—¶é—´</label>
          <select id="publishedAfter">
            <option value="day">æœ€è¿‘24å°æ—¶</option>
            <option value="week">æœ€è¿‘ä¸€å‘¨</option>
            <option value="month">æœ€è¿‘ä¸€æœˆ</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
      </div>
    </div>
    
    <div class="selection-toolbar" id="selectionToolbar">
      <div class="selection-info" id="selectionInfo">å·²é€‰æ‹© 0 ä¸ªè§†é¢‘</div>
      <div class="selection-actions">
        <button class="btn btn-primary" onclick="getSelectedChannels()">ğŸ“‹ è·å–åšä¸»é“¾æ¥</button>
        <button class="btn btn-secondary" onclick="selectAllVisible()">ğŸ”˜ å…¨é€‰å¯è§</button>
        <button class="btn btn-secondary" onclick="clearSelection()">âœ• å–æ¶ˆé€‰æ‹©</button>
        <button class="btn btn-secondary" onclick="toggleSelectionMode(false)">âœ… å®Œæˆé€‰æ‹©</button>
      </div>
    </div>
    
    <div class="stats-section" id="statsSection" style="display: none;">
      <div class="stat-card">
        <div class="number" id="totalVideos">0</div>
        <div class="label">æ€»è§†é¢‘æ•°</div>
      </div>
      <div class="stat-card">
        <div class="number" id="totalChannels">0</div>
        <div class="label">é¢‘é“æ•°</div>
      </div>
      <div class="stat-card">
        <div class="number" id="avgViews">0</div>
        <div class="label">å¹³å‡è§‚çœ‹</div>
      </div>
      <div class="stat-card">
        <div class="number" id="hotVideos">0</div>
        <div class="label">çˆ†æ¬¾è§†é¢‘</div>
      </div>
      <div class="stat-card" id="tagStatsCard" style="display: none; grid-column: 1 / -1; cursor: pointer;" onclick="toggleTagStats()">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div class="label" style="margin-bottom: 8px;">æ ‡ç­¾åŒ¹é…ç»Ÿè®¡</div>
            <div id="tagStatsPreview" style="font-size: 13px; color: #a7adb8;"></div>
          </div>
          <div id="tagStatsToggle" style="font-size: 20px; color: var(--p5r-yellow);">â–¼</div>
        </div>
        <div id="tagStatsDetail" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #2a2a33;"></div>
      </div>
    </div>
    
    <div class="results-section card">
      <div id="loadingDiv" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p id="loadingText">æ­£åœ¨è·å–æ•°æ®...</p>
        <div id="progressBar" style="width: 80%; max-width: 400px; height: 8px; background: #2a2a33; border-radius: 4px; margin: 16px auto 8px; overflow: hidden; display: none;">
          <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, var(--p5r-yellow), #7ef29a); width: 0%; transition: width 0.3s;"></div>
        </div>
        <p id="progressInfo" style="font-size: 13px; color: #a7adb8; margin-top: 8px; display: none;"></p>
      </div>
      
      <div id="errorDiv" style="display: none;"></div>
      
      <div id="resultsDiv" class="video-grid"></div>
    </div>
    
    <div class="channel-links-section card" id="channelLinksSection">
      <div class="channel-links-header">
        <h3>ğŸ”— åšä¸»é“¾æ¥åˆ—è¡¨</h3>
        <button class="btn btn-secondary" onclick="copyAllLinks()">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
        <button class="btn btn-primary" onclick="window.location.href='02 YouTubeåšä¸»ç®¡ç†å·¥å…·.html'">ğŸ“Š åšä¸»ç®¡ç†å·¥å…·</button>
      </div>
      <div id="channelLinksList"></div>
    </div>
  </div>
  
  <!-- æ ‡ç­¾ç»„ç®¡ç†å¼¹çª— -->
  <div id="tagGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: #1a1a1f; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid #2a2a33;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; color: #e6e6e9;">ğŸ“‹ æ ‡ç­¾ç»„ç®¡ç†</h3>
        <button onclick="closeTagGroupModal()" style="background: none; border: none; color: #a7adb8; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
      </div>
      <div id="tagGroupsList"></div>
    </div>
  </div>
  
  <script>
    let allVideos = [];
    let filteredVideos = [];
    let selectedVideos = new Set();
    let selectionMode = false;
    let db;
    let searchMode = 'batch'; // 'single' or 'batch'
    let currentSearchTags = []; // å½“å‰æœç´¢ä½¿ç”¨çš„æ ‡ç­¾åˆ—è¡¨
    let tagStats = {}; // æ ‡ç­¾ç»Ÿè®¡ä¿¡æ¯ {tagName: count}
    
    // ==========================================
    // ğŸš€ å¹¶å‘æ§åˆ¶å™¨
    // ==========================================
    /**
     * å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œé™åˆ¶åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡
     * @param {Array<Function>} tasks - è¿”å›Promiseçš„å‡½æ•°æ•°ç»„
     * @param {number} limit - æœ€å¤§å¹¶å‘æ•°
     * @param {Function} onProgress - è¿›åº¦å›è°ƒå‡½æ•° (completed, total, result)
     * @returns {Promise<Array>} æ‰€æœ‰ä»»åŠ¡çš„ç»“æœæ•°ç»„
     */
    async function promiseConcurrency(tasks, limit, onProgress) {
      const results = new Array(tasks.length);
      const executing = [];
      let completed = 0;
      
      for (let index = 0; index < tasks.length; index++) {
        const task = tasks[index];
        
        const promise = (async () => {
          try {
            const result = await task();
            results[index] = { success: true, data: result, index };
            completed++;
            if (onProgress) {
              onProgress(completed, tasks.length, results[index]);
            }
            return result;
          } catch (error) {
            results[index] = { success: false, error, index };
            completed++;
            if (onProgress) {
              onProgress(completed, tasks.length, results[index]);
            }
            throw error;
          }
        })();
        
        executing.push(promise);
        
        // å½“è¾¾åˆ°å¹¶å‘é™åˆ¶æ—¶ï¼Œç­‰å¾…ä»»æ„ä¸€ä¸ªå®Œæˆ
        if (executing.length >= limit) {
          await Promise.race(executing).catch(() => {});
          // ç§»é™¤å·²å®Œæˆçš„promise
          const completedIndex = executing.findIndex(p => {
            let isSettled = false;
            p.then(() => { isSettled = true; }).catch(() => { isSettled = true; });
            return isSettled;
          });
          if (completedIndex !== -1) {
            executing.splice(completedIndex, 1);
          }
        }
      }
      
      // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
      await Promise.allSettled(executing);
      
      return results;
    }
    
    // ==========================================
    // ğŸ”‘ APIæ± ç®¡ç† - ä»IndexedDBåŠ è½½
    // ==========================================
    // è¯´æ˜ï¼š
    // 1. APIæ± ç°åœ¨ç»Ÿä¸€å­˜å‚¨åœ¨IndexedDBä¸­
    // 2. è¯·ä½¿ç”¨"APIæ± ç®¡ç†å·¥å…·.html"æ¥ç®¡ç†æ‰€æœ‰API Key
    // 3. æ”¯æŒæ‰‹åŠ¨æ·»åŠ ã€æ‰¹é‡å¯¼å…¥ã€çŠ¶æ€ç®¡ç†
    // 4. ä¸‰ä¸ªå·¥å…·å…±äº«åŒä¸€ä¸ªAPIæ± 
    // ==========================================
    
    let API_POOL = []; // å°†ä»IndexedDBåŠ¨æ€åŠ è½½
    let currentApiIndex = 0;
    
    // åˆå§‹åŒ–IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('YouTubeToolDB', 5);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          console.log('æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          console.log(`æ•°æ®åº“å‡çº§: ${event.oldVersion} -> ${event.newVersion}`);
          
          // settings å­˜å‚¨
          if (!db.objectStoreNames.contains('settings')) {
            console.log('åˆ›å»º settings å­˜å‚¨');
            db.createObjectStore('settings', { keyPath: 'key' });
          }
          
          // apiPool å­˜å‚¨
          if (!db.objectStoreNames.contains('apiPool')) {
            console.log('åˆ›å»º apiPool å­˜å‚¨');
            const apiStore = db.createObjectStore('apiPool', { keyPath: 'id', autoIncrement: true });
            apiStore.createIndex('apiKey', 'apiKey', { unique: true });
            apiStore.createIndex('addedAt', 'addedAt', { unique: false });
          }
          
          // channels å­˜å‚¨ï¼ˆç”¨äºåšä¸»ç®¡ç†å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('channels')) {
            console.log('åˆ›å»º channels å­˜å‚¨');
            const channelStore = db.createObjectStore('channels', { keyPath: 'channelId' });
            channelStore.createIndex('addedAt', 'addedAt', { unique: false });
            channelStore.createIndex('name', 'name', { unique: false });
          }
          
          // monitorChannels å­˜å‚¨ï¼ˆç”¨äºè§†é¢‘ç›‘æ§å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('monitorChannels')) {
            console.log('åˆ›å»º monitorChannels å­˜å‚¨');
            const monitorChannelStore = db.createObjectStore('monitorChannels', { keyPath: 'channelId' });
            monitorChannelStore.createIndex('addedAt', 'addedAt', { unique: false });
          }
          
          // monitorVideos å­˜å‚¨ï¼ˆç”¨äºè§†é¢‘ç›‘æ§å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('monitorVideos')) {
            console.log('åˆ›å»º monitorVideos å­˜å‚¨');
            const videoStore = db.createObjectStore('monitorVideos', { keyPath: 'videoId' });
            videoStore.createIndex('channelId', 'channelId', { unique: false });
            videoStore.createIndex('publishedAt', 'publishedAt', { unique: false });
          }
          
          // tagGroups å­˜å‚¨ï¼ˆç”¨äºæ‰¹é‡æ ‡ç­¾æœç´¢ï¼‰
          if (!db.objectStoreNames.contains('tagGroups')) {
            console.log('åˆ›å»º tagGroups å­˜å‚¨');
            const tagGroupStore = db.createObjectStore('tagGroups', { keyPath: 'id', autoIncrement: true });
            tagGroupStore.createIndex('name', 'name', { unique: false });
            tagGroupStore.createIndex('createdAt', 'createdAt', { unique: false });
            tagGroupStore.createIndex('lastUsed', 'lastUsed', { unique: false });
          }
          
          console.log('æ•°æ®åº“ç»“æ„åˆ›å»ºå®Œæˆ');
        };
      });
    }
    
    // ä»IndexedDBåŠ è½½APIæ± 
    function loadApiPool() {
      return new Promise((resolve, reject) => {
        if (!db.objectStoreNames.contains('apiPool')) {
          API_POOL = [];
          resolve();
          return;
        }
        
        const transaction = db.transaction(['apiPool'], 'readonly');
        const store = transaction.objectStore('apiPool');
        const request = store.getAll();
        
        request.onsuccess = () => {
          const allApis = request.result || [];
          // åªåŠ è½½çŠ¶æ€ä¸ºactiveçš„API
          API_POOL = allApis
            .filter(api => api.status === 'active')
            .map(api => api.apiKey);
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }
    
    // åˆå§‹åŒ–é»˜è®¤APIï¼ˆå¦‚æœæ± ä¸ºç©ºï¼‰
    async function initDefaultApi() {
      if (API_POOL.length > 0) {
        console.log('APIæ± å·²æœ‰æ•°æ®ï¼Œè·³è¿‡æ·»åŠ é»˜è®¤API');
        return;
      }
      
      console.log('ğŸ“¦ APIæ± ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å…è´¹API...');
      
      const defaultApiKey = 'AIzaSyDfDnHWoisuG3Xc8oF9YR_CgSmu43i6P48';
      
      // ç›´æ¥ä¿å­˜åˆ°IndexedDB
      const defaultApi = {
        apiKey: defaultApiKey,
        status: 'active',
        addedAt: new Date().toISOString(),
        usageCount: 0,
        lastUsed: null,
        note: 'å®˜æ–¹æä¾›ï¼ˆå…è´¹ï¼‰',
        isDefault: true
      };
      
      // ä¿å­˜åˆ°æ•°æ®åº“
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['apiPool'], 'readwrite');
        const store = transaction.objectStore('apiPool');
        
        // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const index = store.index('apiKey');
        const checkRequest = index.get(defaultApiKey);
        
        checkRequest.onsuccess = () => {
          if (!checkRequest.result) {
            // ä¸å­˜åœ¨ï¼Œæ·»åŠ 
            store.add(defaultApi);
          }
        };
        
        transaction.oncomplete = async () => {
          // é‡æ–°åŠ è½½APIæ± 
          await loadApiPool();
          updateApiStatus();
          console.log('âœ… é»˜è®¤APIå·²æ·»åŠ å¹¶åŠ è½½');
          resolve();
        };
        
        transaction.onerror = () => reject(transaction.error);
      });
    }
    
    // æ ‡è®°APIä¸ºexhaustedçŠ¶æ€
    async function markApiAsExhaustedInDB(apiKey) {
      return new Promise((resolve, reject) => {
        if (!db.objectStoreNames.contains('apiPool')) {
          resolve();
          return;
        }
        
        const transaction = db.transaction(['apiPool'], 'readwrite');
        const store = transaction.objectStore('apiPool');
        const index = store.index('apiKey');
        const request = index.get(apiKey);
        
        request.onsuccess = () => {
          const api = request.result;
          if (api) {
            api.status = 'exhausted';
            api.lastUsed = new Date().toISOString();
            store.put(api);
          }
        };
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }
    
    // è·å–å½“å‰åº”è¯¥ä½¿ç”¨çš„API Key (åªä½¿ç”¨APIæ± )
    function getCurrentApiKey() {
      // API_POOLä¸­çš„æ‰€æœ‰APIéƒ½æ˜¯å¯ç”¨çš„ï¼ˆä»IndexedDBåŠ è½½æ—¶å·²è¿‡æ»¤ï¼‰
      if (API_POOL.length > 0) {
        // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
        currentApiIndex = currentApiIndex % API_POOL.length;
        return API_POOL[currentApiIndex];
      }
      
      // æ‰€æœ‰APIéƒ½ä¸å¯ç”¨
      return null;
    }
    
    // æ‰‹åŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªAPI
    function switchNextApi() {
      // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„API
      if (API_POOL.length === 0) {
        showMessage('å½“å‰æ²¡æœ‰å¯ç”¨çš„APIï¼Œè¯·åœ¨APIç®¡ç†å·¥å…·ä¸­æ·»åŠ ', 'error');
        return;
      }
      
      if (API_POOL.length === 1) {
        showMessage('åªæœ‰ä¸€ä¸ªå¯ç”¨çš„APIï¼Œæ— éœ€åˆ‡æ¢', 'warning');
        return;
      }
      
      // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªAPIï¼ˆAPI_POOLä¸­çš„æ‰€æœ‰APIéƒ½æ˜¯å¯ç”¨çš„ï¼‰
      currentApiIndex = (currentApiIndex + 1) % API_POOL.length;
      
      updateApiStatus();
      showMessage(`å·²åˆ‡æ¢åˆ°API #${currentApiIndex + 1}`, 'success');
    }
    
    // æ ‡è®°å½“å‰APIä¸ºé…é¢ç”¨å°½
    async function markApiAsExhausted() {
      const currentApiKey = API_POOL[currentApiIndex];
      console.log(`âš ï¸ API #${currentApiIndex + 1} å·²æ ‡è®°ä¸ºé…é¢ç”¨å°½: ${currentApiKey.substring(0, 10)}...`);
      
      // æ›´æ–°IndexedDBä¸­çš„çŠ¶æ€
      await markApiAsExhaustedInDB(currentApiKey);
      
      // ä»å½“å‰æ± ä¸­ç§»é™¤ï¼ˆé‡æ–°åŠ è½½APIæ± ï¼‰
      await loadApiPool();
      
      // è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨API
      if (API_POOL.length > 0) {
        currentApiIndex = 0; // é‡ç½®åˆ°ç¬¬ä¸€ä¸ª
        showMessage(`âš ï¸ APIå·²æ ‡è®°ä¸ºé…é¢ç”¨å°½\nâœ… å·²è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨API`, 'warning');
        updateApiStatus();
        return true;
      } else {
        showMessage('âš ï¸ æ‰€æœ‰APIé…é¢éƒ½å·²ç”¨å°½ï¼\nè¯·åœ¨"APIæ± ç®¡ç†å·¥å…·"ä¸­æ·»åŠ æ–°çš„APIæˆ–é‡ç½®é…é¢', 'error');
        updateApiStatus();
        return false;
      }
    }
    
    // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
    function updateApiStatus() {
      const availableCount = API_POOL.length;
      
      const statusEl = document.getElementById('apiPoolStatus');
      const infoEl = document.getElementById('currentApiInfo');
      const switchBtn = document.getElementById('switchApiBtn');
      
      statusEl.textContent = `${availableCount} å¯ç”¨`;
      
      if (API_POOL.length > 0) {
        infoEl.textContent = `ä½¿ç”¨API #${currentApiIndex + 1}`;
        infoEl.style.color = '#7ef29a';
        if (switchBtn) {
          switchBtn.textContent = API_POOL.length > 1 ? 'ğŸ”„ åˆ‡æ¢ä¸‹ä¸€ä¸ªAPI' : 'ğŸ”„ åˆ‡æ¢API';
          switchBtn.title = API_POOL.length > 1 ? 'åˆ‡æ¢åˆ°APIæ± ä¸­çš„ä¸‹ä¸€ä¸ªAPI' : 'å½“å‰åªæœ‰ä¸€ä¸ªå¯ç”¨API';
        }
      } else {
        infoEl.textContent = 'æ— å¯ç”¨API';
        infoEl.style.color = '#ff98a3';
        if (switchBtn) {
          switchBtn.textContent = 'ğŸ”„ åˆ‡æ¢API';
          switchBtn.title = 'æ²¡æœ‰å¯ç”¨çš„APIï¼Œè¯·åœ¨APIç®¡ç†å·¥å…·ä¸­æ·»åŠ ';
        }
      }
      
      // æ ¹æ®å¯ç”¨æ•°é‡æ”¹å˜é¢œè‰²
      if (availableCount === 0) {
        statusEl.style.color = '#ff98a3'; // çº¢è‰²
      } else if (availableCount <= 2) {
        statusEl.style.color = '#ffe600'; // é»„è‰²
      } else {
        statusEl.style.color = 'var(--p5r-yellow)'; // æ­£å¸¸é¢œè‰²
      }
    }
    
    // åˆå§‹åŒ–åŠ è½½
    window.onload = async function() {
      try {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
        
        // åˆå§‹åŒ–æ•°æ®åº“
        await initDB();
        console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
        
        // åŠ è½½APIæ± 
        await loadApiPool();
        console.log(`ğŸ“¦ APIæ± åŠ è½½å®Œæˆï¼Œå½“å‰æ•°é‡: ${API_POOL.length}`);
        
        // å¦‚æœAPIæ± ä¸ºç©ºï¼Œè‡ªåŠ¨æ·»åŠ é»˜è®¤API
        if (API_POOL.length === 0) {
          console.log('âš ï¸ APIæ± ä¸ºç©ºï¼Œå°è¯•æ·»åŠ é»˜è®¤API...');
          await initDefaultApi();
        }
        
        // åˆå§‹åŒ–APIçŠ¶æ€æ˜¾ç¤º
        updateApiStatus();
        console.log('âœ… APIçŠ¶æ€æ›´æ–°å®Œæˆ');
        
        // åŠ è½½æ ‡ç­¾ç»„åˆ—è¡¨
        await loadTagGroupsToSelect();
        
        // åˆå§‹åŒ–æœç´¢æ¨¡å¼ä¸ºæ‰¹é‡æ¨¡å¼
        switchSearchMode('batch');
        
        // ç›‘å¬æ‰¹é‡æœç´¢è¾“å…¥æ¡†å˜åŒ–
        const batchInput = document.getElementById('batchSearchQuery');
        if (batchInput) {
          batchInput.addEventListener('input', updateTagCount);
          updateTagCount();
        }
        
        // å°è¯•æ¢å¤ä¸Šæ¬¡æŸ¥è¯¢ç»“æœ
        const cacheLoaded = await loadSearchCache();
        
        // æç¤ºç”¨æˆ·
        if (!cacheLoaded) {
          if (API_POOL.length === 0) {
            showMessage(
              'âš ï¸ å½“å‰æ²¡æœ‰å¯ç”¨çš„API Keyï¼\n' +
              'è¯·ç‚¹å‡»"APIç®¡ç†"æŒ‰é’®æ·»åŠ API Keyï¼Œæˆ–è€…åˆ·æ–°é¡µé¢é‡è¯•',
              'warning',
              10000
            );
          } else {
            console.log(`âœ… å·²åŠ è½½ ${API_POOL.length} ä¸ªå¯ç”¨API`);
            // ç§»åŠ¨ç«¯å‹å¥½æç¤º
            if (window.innerWidth <= 768) {
              showMessage('âœ… åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨', 'success', 3000);
            }
          }
        }
        
        console.log('ğŸ‰ åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼');
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        showMessage(
          'âš ï¸ åˆå§‹åŒ–å¤±è´¥: ' + error.message + '\nè¯·åˆ·æ–°é¡µé¢é‡è¯•',
          'error',
          10000
        );
      }
    };
    
    // ä¿å­˜åˆ°IndexedDB
    function saveToDB(key, value) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['settings'], 'readwrite');
        const store = transaction.objectStore('settings');
        const request = store.put({ key: key, value: value });
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // ä»IndexedDBè¯»å–
    function getFromDB(key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['settings'], 'readonly');
        const store = transaction.objectStore('settings');
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result?.value);
        request.onerror = () => reject(request.error);
      });
    }
    
    // ==========================================
    // ğŸ’¾ æŸ¥è¯¢ç»“æœç¼“å­˜ç®¡ç†
    // ==========================================
    
    // ä¿å­˜æŸ¥è¯¢ç¼“å­˜åˆ° IndexedDB
    async function saveSearchCache() {
      if (allVideos.length === 0) return; // æ²¡æœ‰æ•°æ®æ—¶ä¸ä¿å­˜
      
      try {
        const cacheData = {
          allVideos: allVideos,
          currentSearchTags: currentSearchTags,
          tagStats: tagStats,
          searchMode: searchMode,
          timestamp: new Date().toISOString(),
          filters: {
            maxSubscribers: document.getElementById('maxSubscribers').value,
            minViews: document.getElementById('minViews').value,
            regionFilter: document.getElementById('regionFilter').value,
            publishedAfter: document.getElementById('publishedAfter').value
          }
        };
        
        await saveToDB('lastSearchCache', cacheData);
        console.log('âœ… æŸ¥è¯¢ç»“æœå·²ç¼“å­˜:', allVideos.length, 'ä¸ªè§†é¢‘');
      } catch (error) {
        console.error('âŒ ç¼“å­˜ä¿å­˜å¤±è´¥:', error);
      }
    }
    
    // ä» IndexedDB åŠ è½½æŸ¥è¯¢ç¼“å­˜
    async function loadSearchCache() {
      try {
        const cacheData = await getFromDB('lastSearchCache');
        
        if (!cacheData || !cacheData.allVideos || cacheData.allVideos.length === 0) {
          console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜æ•°æ®');
          return false;
        }
        
        // æ¢å¤æ•°æ®
        allVideos = cacheData.allVideos;
        currentSearchTags = cacheData.currentSearchTags || [];
        tagStats = cacheData.tagStats || {};
        searchMode = cacheData.searchMode || 'batch';
        
        // æ¢å¤ç­›é€‰æ¡ä»¶
        if (cacheData.filters) {
          document.getElementById('maxSubscribers').value = cacheData.filters.maxSubscribers || 100000;
          document.getElementById('minViews').value = cacheData.filters.minViews || 10000;
          document.getElementById('regionFilter').value = cacheData.filters.regionFilter || '';
          document.getElementById('publishedAfter').value = cacheData.filters.publishedAfter || 'month';
        }
        
        // åº”ç”¨ç­›é€‰å¹¶æ˜¾ç¤º
        filteredVideos = [...allVideos];
        applyFilters();
        
        // æ˜¾ç¤ºæ¢å¤æç¤º
        const uniqueChannels = new Set(allVideos.map(v => v.channelId));
        const cacheTime = new Date(cacheData.timestamp).toLocaleString('zh-CN');
        showMessage(
          `âœ… å·²è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡æŸ¥è¯¢ç»“æœ\nå…± ${allVideos.length} ä¸ªè§†é¢‘ï¼Œ${uniqueChannels.size} ä¸ªé¢‘é“\nç¼“å­˜æ—¶é—´: ${cacheTime}`,
          'success',
          5000
        );
        
        console.log('âœ… å·²æ¢å¤ç¼“å­˜æ•°æ®:', allVideos.length, 'ä¸ªè§†é¢‘');
        return true;
      } catch (error) {
        console.error('âŒ ç¼“å­˜åŠ è½½å¤±è´¥:', error);
        return false;
      }
    }
    
    // æ¸…ç©ºæŸ¥è¯¢ç¼“å­˜
    async function clearSearchCache() {
      try {
        await saveToDB('lastSearchCache', null);
        console.log('âœ… æŸ¥è¯¢ç¼“å­˜å·²æ¸…ç©º');
      } catch (error) {
        console.error('âŒ ç¼“å­˜æ¸…ç©ºå¤±è´¥:', error);
      }
    }
    
    // ==========================================
    // ğŸ·ï¸ æœç´¢æ¨¡å¼åˆ‡æ¢
    // ==========================================
    function switchSearchMode(mode) {
      searchMode = mode;
      const singleGroup = document.getElementById('singleSearchGroup');
      const batchGroup = document.getElementById('batchSearchGroup');
      const singleBtn = document.getElementById('singleModeBtn');
      const batchBtn = document.getElementById('batchModeBtn');
      
      if (mode === 'single') {
        singleGroup.style.display = 'block';
        batchGroup.style.display = 'none';
        singleBtn.className = 'btn btn-primary';
        batchBtn.className = 'btn btn-secondary';
      } else {
        singleGroup.style.display = 'none';
        batchGroup.style.display = 'block';
        singleBtn.className = 'btn btn-secondary';
        batchBtn.className = 'btn btn-primary';
      }
    }
    
    // æ›´æ–°æ ‡ç­¾è®¡æ•°
    function updateTagCount() {
      const batchInput = document.getElementById('batchSearchQuery');
      const tagCountEl = document.getElementById('tagCount');
      if (!batchInput || !tagCountEl) return;
      
      const tags = parseTags(batchInput.value);
      tagCountEl.textContent = `å·²è¾“å…¥ ${tags.length} ä¸ªæ ‡ç­¾`;
    }
    
    // è§£ææ ‡ç­¾ï¼ˆæ”¯æŒé€—å·å’Œæ¢è¡Œåˆ†éš”ï¼‰
    function parseTags(input) {
      if (!input) return [];
      return input
        .split(/[,\n]/)
        .map(tag => tag.trim())
        .filter(tag => tag.length > 0);
    }
    
    // ==========================================
    // ğŸ·ï¸ æ ‡ç­¾ç»„ç®¡ç†åŠŸèƒ½
    // ==========================================
    
    // ä¿å­˜å½“å‰æ ‡ç­¾ç»„
    async function saveCurrentTagGroup() {
      const batchInput = document.getElementById('batchSearchQuery');
      const tags = parseTags(batchInput.value);
      
      if (tags.length === 0) {
        showMessage('è¯·å…ˆè¾“å…¥æ ‡ç­¾', 'error');
        return;
      }
      
      const name = prompt('è¯·è¾“å…¥æ ‡ç­¾ç»„åç§°ï¼š', 'æ ‡ç­¾ç»„ ' + new Date().toLocaleString('zh-CN'));
      if (!name) return;
      
      try {
        await saveTagGroupToDB({
          name: name,
          tags: tags,
          createdAt: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        });
        
        await loadTagGroupsToSelect();
        showMessage('æ ‡ç­¾ç»„å·²ä¿å­˜', 'success');
      } catch (error) {
        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ä¿å­˜æ ‡ç­¾ç»„åˆ°IndexedDB
    function saveTagGroupToDB(tagGroup) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagGroups'], 'readwrite');
        const store = transaction.objectStore('tagGroups');
        const request = store.add(tagGroup);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    // ä»IndexedDBåŠ è½½æ‰€æœ‰æ ‡ç­¾ç»„
    function loadAllTagGroups() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagGroups'], 'readonly');
        const store = transaction.objectStore('tagGroups');
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result || []);
        request.onerror = () => reject(request.error);
      });
    }
    
    // åŠ è½½æ ‡ç­¾ç»„åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
    async function loadTagGroupsToSelect() {
      try {
        const tagGroups = await loadAllTagGroups();
        const selectEl = document.getElementById('tagGroupSelect');
        if (!selectEl) return;
        
        // ä¿ç•™ç¬¬ä¸€ä¸ªé»˜è®¤é€‰é¡¹
        selectEl.innerHTML = '<option value="">-- é€‰æ‹©æ ‡ç­¾ç»„ --</option>';
        
        // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åº
        tagGroups.sort((a, b) => new Date(b.lastUsed) - new Date(a.lastUsed));
        
        tagGroups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = `${group.name} (${group.tags.length}ä¸ªæ ‡ç­¾)`;
          selectEl.appendChild(option);
        });
      } catch (error) {
        console.error('åŠ è½½æ ‡ç­¾ç»„å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½é€‰ä¸­çš„æ ‡ç­¾ç»„
    async function loadSelectedTagGroup() {
      const selectEl = document.getElementById('tagGroupSelect');
      const groupId = parseInt(selectEl.value);
      
      if (!groupId) return;
      
      try {
        const tagGroup = await getTagGroupFromDB(groupId);
        if (tagGroup) {
          const batchInput = document.getElementById('batchSearchQuery');
          batchInput.value = tagGroup.tags.join(', ');
          updateTagCount();
          
          // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
          tagGroup.lastUsed = new Date().toISOString();
          await updateTagGroupInDB(tagGroup);
          
          showMessage(`å·²åŠ è½½æ ‡ç­¾ç»„: ${tagGroup.name}`, 'success');
        }
      } catch (error) {
        showMessage('åŠ è½½æ ‡ç­¾ç»„å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ä»IndexedDBè·å–å•ä¸ªæ ‡ç­¾ç»„
    function getTagGroupFromDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagGroups'], 'readonly');
        const store = transaction.objectStore('tagGroups');
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    // æ›´æ–°æ ‡ç­¾ç»„
    function updateTagGroupInDB(tagGroup) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagGroups'], 'readwrite');
        const store = transaction.objectStore('tagGroups');
        const request = store.put(tagGroup);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // åˆ é™¤æ ‡ç­¾ç»„
    function deleteTagGroupFromDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagGroups'], 'readwrite');
        const store = transaction.objectStore('tagGroups');
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    
    // æ‰“å¼€æ ‡ç­¾ç»„ç®¡ç†å¼¹çª—
    async function manageTagGroups() {
      try {
        const tagGroups = await loadAllTagGroups();
        const modal = document.getElementById('tagGroupModal');
        const listEl = document.getElementById('tagGroupsList');
        
        if (tagGroups.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #a7adb8;">æš‚æ— ä¿å­˜çš„æ ‡ç­¾ç»„</div>';
        } else {
          listEl.innerHTML = tagGroups.map(group => `
            <div style="background: #0f0f13; border: 1px solid #2a2a33; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="color: #e6e6e9; font-weight: 600; font-size: 15px; margin-bottom: 4px;">${escapeHtml(group.name)}</div>
                  <div style="color: #a7adb8; font-size: 12px;">
                    åˆ›å»ºæ—¶é—´: ${new Date(group.createdAt).toLocaleString('zh-CN')}
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="loadTagGroupById(${group.id})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">åŠ è½½</button>
                  <button onclick="deleteTagGroup(${group.id})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #d32f2f;">åˆ é™¤</button>
                </div>
              </div>
              <div style="margin-top: 12px; padding: 10px; background: #1a1a1f; border-radius: 6px;">
                <div style="color: #7ef29a; font-size: 13px; word-break: break-all;">
                  ${group.tags.map(tag => `<span style="display: inline-block; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); color: #93c5fd; padding: 4px 10px; border-radius: 6px; margin: 3px; font-size: 11px; font-weight: 600; border: 1px solid rgba(59, 130, 246, 0.4); box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);">${escapeHtml(tag)}</span>`).join('')}
                </div>
              </div>
            </div>
          `).join('');
        }
        
        modal.style.display = 'flex';
      } catch (error) {
        showMessage('åŠ è½½æ ‡ç­¾ç»„å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // å…³é—­æ ‡ç­¾ç»„ç®¡ç†å¼¹çª—
    function closeTagGroupModal() {
      const modal = document.getElementById('tagGroupModal');
      modal.style.display = 'none';
    }
    
    // ä»ç®¡ç†ç•Œé¢åŠ è½½æ ‡ç­¾ç»„
    async function loadTagGroupById(id) {
      try {
        const tagGroup = await getTagGroupFromDB(id);
        if (tagGroup) {
          const batchInput = document.getElementById('batchSearchQuery');
          batchInput.value = tagGroup.tags.join(', ');
          updateTagCount();
          
          // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
          tagGroup.lastUsed = new Date().toISOString();
          await updateTagGroupInDB(tagGroup);
          
          closeTagGroupModal();
          showMessage(`å·²åŠ è½½æ ‡ç­¾ç»„: ${tagGroup.name}`, 'success');
        }
      } catch (error) {
        showMessage('åŠ è½½æ ‡ç­¾ç»„å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åˆ é™¤æ ‡ç­¾ç»„
    async function deleteTagGroup(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡ç­¾ç»„å—ï¼Ÿ')) return;
      
      try {
        await deleteTagGroupFromDB(id);
        await loadTagGroupsToSelect();
        await manageTagGroups(); // åˆ·æ–°ç®¡ç†ç•Œé¢
        showMessage('æ ‡ç­¾ç»„å·²åˆ é™¤', 'success');
      } catch (error) {
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    function showMessage(message, type, duration = 3000) {
      const errorDiv = document.getElementById('errorDiv');
      errorDiv.className = type;
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, duration);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }
    
    // æŸ¥æ‰¾è§†é¢‘æ ‡é¢˜å’Œæè¿°ä¸­åŒ¹é…çš„æ ‡ç­¾
    function findMatchedTags(title, description) {
      if (currentSearchTags.length === 0) return [];
      
      const matchedTags = [];
      const searchText = (title + ' ' + description).toLowerCase();
      
      for (const tag of currentSearchTags) {
        const tagLower = tag.toLowerCase();
        if (searchText.includes(tagLower)) {
          matchedTags.push(tag);
        }
      }
      
      return matchedTags;
    }
    
    // æ›´æ–°æœç´¢è¿›åº¦
    function updateSearchProgress(current, total, tag, videoCount) {
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressInfo = document.getElementById('progressInfo');
      
      loadingText.textContent = `æ­£åœ¨æœç´¢: ${tag} (${current}/${total})`;
      progressBar.style.display = 'block';
      progressInfo.style.display = 'block';
      
      const percentage = Math.round((current / total) * 100);
      progressFill.style.width = percentage + '%';
      progressInfo.textContent = `å·²è·å– ${videoCount} ä¸ªè§†é¢‘`;
    }
    
    // æœç´¢å•ä¸ªæ ‡ç­¾
    async function searchSingleTag(tag, maxResults, publishedAfter) {
      let apiKey = getCurrentApiKey();
      
      if (!apiKey) {
        throw new Error('æ²¡æœ‰å¯ç”¨çš„API Key');
      }
      
      const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(tag)}&type=video&order=viewCount&publishedAfter=${publishedAfter}&maxResults=${maxResults}&key=${apiKey}`;
      
      const searchResponse = await fetch(searchUrl);
      const searchData = await searchResponse.json();
      
      if (searchData.error) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯é…é¢é”™è¯¯
        if (searchData.error.code === 403 || 
            searchData.error.message.includes('quota') || 
            searchData.error.message.includes('exceeded')) {
          const switched = await markApiAsExhausted();
          if (switched) {
            // åˆ‡æ¢æˆåŠŸï¼Œé‡è¯•å½“å‰æ ‡ç­¾
            return await searchSingleTag(tag, maxResults, publishedAfter);
          } else {
            throw new Error('æ‰€æœ‰APIé…é¢å·²ç”¨å°½');
          }
        }
        throw new Error(searchData.error.message);
      }
      
      if (!searchData.items || searchData.items.length === 0) {
        return [];
      }
      
      const videoIds = searchData.items.map(item => item.id.videoId).join(',');
      
      // é‡æ–°è·å–å½“å‰APIï¼ˆå¯èƒ½å·²ç»åˆ‡æ¢ï¼‰
      apiKey = getCurrentApiKey();
      
      // è·å–è§†é¢‘è¯¦ç»†ä¿¡æ¯
      const videoUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIds}&key=${apiKey}`;
      const videoResponse = await fetch(videoUrl);
      const videoData = await videoResponse.json();
      
      if (!videoData.items || videoData.items.length === 0) {
        return [];
      }
      
      // è·å–é¢‘é“ä¿¡æ¯
      const channelIds = [...new Set(videoData.items.map(item => item.snippet.channelId))].join(',');
      const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelIds}&key=${apiKey}`;
      const channelResponse = await fetch(channelUrl);
      const channelData = await channelResponse.json();
      
      // åˆå¹¶æ•°æ®å¹¶æ ‡è®°åŒ¹é…çš„æ ‡ç­¾
      return videoData.items.map(video => {
        const channel = channelData.items.find(ch => ch.id === video.snippet.channelId);
        
        return {
          videoId: video.id,
          title: video.snippet.title,
          description: video.snippet.description || '',
          thumbnail: video.snippet.thumbnails.medium.url,
          channelTitle: video.snippet.channelTitle,
          channelId: video.snippet.channelId,
          channelAvatar: channel?.snippet?.thumbnails?.default?.url || '',
          publishedAt: video.snippet.publishedAt,
          viewCount: parseInt(video.statistics.viewCount || 0),
          likeCount: parseInt(video.statistics.likeCount || 0),
          commentCount: parseInt(video.statistics.commentCount || 0),
          subscriberCount: parseInt(channel?.statistics?.subscriberCount || 0),
          videoCount: parseInt(channel?.statistics?.videoCount || 0),
          country: channel?.snippet?.country || 'Unknown',
          matchedTags: [tag], // ç›´æ¥æ ‡è®°å½“å‰æœç´¢çš„æ ‡ç­¾
          searchTag: tag // è®°å½•æ˜¯å“ªä¸ªæ ‡ç­¾æœç´¢åˆ°çš„
        };
      });
    }
    
    // å»é‡è§†é¢‘ï¼ˆåˆå¹¶matchedTagsï¼‰
    function deduplicateVideos(videos) {
      const videoMap = new Map();
      
      for (const video of videos) {
        if (videoMap.has(video.videoId)) {
          // åˆå¹¶matchedTags
          const existing = videoMap.get(video.videoId);
          existing.matchedTags = [...new Set([...existing.matchedTags, ...video.matchedTags])];
        } else {
          videoMap.set(video.videoId, video);
        }
      }
      
      return Array.from(videoMap.values());
    }
    
    // ==========================================
    // ğŸ“± å¾®ä¿¡æ¨é€åŠŸèƒ½ - PushPlus
    // ==========================================
    
    // æ¨é€é…ç½® - ä¿®å¤ç‰ˆé…ç½®
    const PUSH_CONFIG = {
      token: 'bbd33b528a124566abc86b381e150c4e',
      apiUrl: 'https://www.pushplus.plus/api/send',
      maxVideos: 10, // æœ€å¤§æ¨é€è§†é¢‘æ•°é‡
      defaultVideos: 8, // é»˜è®¤æ¨é€è§†é¢‘æ•°é‡
      maxContentLength: 40000, // å†…å®¹é•¿åº¦é™åˆ¶
      minInterval: 60000 // æœ€å°æ¨é€é—´éš”1åˆ†é’Ÿ
    };

    // Deepseek AI é…ç½®
    const DEEPSEEK_CONFIG = {
      apiUrl: 'https://api.deepseek.com/v1',
      model: 'deepseek-chat',
      apiKey: 'sk-96f5d6bd84e2470592d84d85e82ffb92'
    };

    // AIåˆ†æç¼“å­˜æœºåˆ¶
    let aiAnalysisCache = new Map(); // å†…å­˜ç¼“å­˜
    const CACHE_KEY_PREFIX = 'ai_analysis_';
    const CACHE_DURATION = 30 * 60 * 1000; // 30åˆ†é’Ÿç¼“å­˜

    // ç”Ÿæˆç¼“å­˜é”®
    function generateCacheKey(searchTags, videoStats, topVideos) {
      const tagsKey = searchTags.sort().join(',');
      const statsKey = `${videoStats.totalVideos}_${videoStats.totalChannels}_${videoStats.avgViews}_${videoStats.hotVideos}`;
      const videosKey = topVideos.slice(0, 5).map(v => v.videoId).join(',');
      return CACHE_KEY_PREFIX + btoa(tagsKey + '|' + statsKey + '|' + videosKey).slice(0, 50);
    }

    // è·å–ç¼“å­˜çš„AIåˆ†æ
    async function getCachedAIAnalysis(cacheKey) {
      try {
        const cached = await getFromDB(cacheKey);
        if (cached && cached.timestamp && Date.now() - cached.timestamp < CACHE_DURATION) {
          console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„AIåˆ†æç»“æœ');
          console.log('ğŸ“‹ ç¼“å­˜å†…å®¹é•¿åº¦:', cached.analysis ? cached.analysis.length : 0, 'å­—ç¬¦');
          return cached.analysis;
        }
      } catch (error) {
        console.log('âš ï¸ ç¼“å­˜è¯»å–å¤±è´¥ï¼Œä½¿ç”¨APIè°ƒç”¨');
      }
      console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç¼“å­˜ï¼Œå°†è°ƒç”¨API');
      return null;
    }

    // ä¿å­˜AIåˆ†æåˆ°ç¼“å­˜
    async function saveCachedAIAnalysis(cacheKey, analysis) {
      try {
        const cacheData = {
          analysis: analysis,
          timestamp: Date.now()
        };
        await saveToDB(cacheKey, cacheData);
        console.log('ğŸ’¾ AIåˆ†æç»“æœå·²ç¼“å­˜');
      } catch (error) {
        console.log('âš ï¸ ç¼“å­˜ä¿å­˜å¤±è´¥');
      }
    }
// æ¨é€é˜Ÿåˆ—ç®¡ç† - é¿å…é¢‘ç‡å†²çª
class PushQueue {
  constructor() {
    this.queue = [];
    this.isProcessing = false;
    this.lastPushTime = 0;
    this.minInterval = PUSH_CONFIG.minInterval; // ä½¿ç”¨é…ç½®ä¸­çš„æœ€å°é—´éš”
  }
  
  async add(pushData) {
    return new Promise((resolve, reject) => {
      this.queue.push({
        data: pushData,
        resolve,
        reject,
        timestamp: Date.now()
      });
      
      if (!this.isProcessing) {
        this.processQueue();
      }
    });
  }
  
  async processQueue() {
    if (this.isProcessing || this.queue.length === 0) {
      return;
    }
    
    this.isProcessing = true;
    
    while (this.queue.length > 0) {
      const item = this.queue.shift();
      
      // æ£€æŸ¥æ—¶é—´é—´éš”
      const now = Date.now();
      const timeSinceLastPush = now - this.lastPushTime;
      
      if (timeSinceLastPush < this.minInterval) {
        const waitTime = this.minInterval - timeSinceLastPush;
        console.log(`â° ç­‰å¾… ${waitTime}ms é¿å…é¢‘ç‡é™åˆ¶...`);
        await this.sleep(waitTime);
      }
      
      try {
        const result = await this.sendPush(item.data);
        item.resolve(result);
        this.lastPushTime = Date.now();
      } catch (error) {
        item.reject(error);
      }
      
      // å¤„ç†å®Œä¸€ä¸ªé¡¹ç›®åç­‰å¾…ä¸€æ®µæ—¶é—´
      if (this.queue.length > 0) {
        await this.sleep(3000); // 3ç§’é—´éš”
      }
    }
    
    this.isProcessing = false;
  }
  
  async sendPush(pushData) {
    const { title, content, retryCount = 0 } = pushData;
    
    console.log(`ğŸ“¤ å‘é€æ¨é€: ${title}`);
    console.log(`ğŸ“Š å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
    
    // å†…å®¹é•¿åº¦æ£€æŸ¥å’Œä¼˜åŒ–
    let optimizedContent = content;
    if (content.length > PUSH_CONFIG.maxContentLength) {
      console.warn(`âš ï¸ æ¨é€å†…å®¹è¿‡é•¿ (${content.length} å­—ç¬¦)ï¼Œè¿›è¡Œä¼˜åŒ–...`);
      optimizedContent = this.optimizeContent(content);
    }
    
    // é¢‘ç‡æ§åˆ¶ - å¢åŠ å»¶è¿Ÿæ—¶é—´
    if (retryCount > 0) {
      const delay = 8000 * retryCount + Math.random() * 5000; // 8-13ç§’å»¶è¿Ÿ
      console.log(`â° é‡è¯•å»¶è¿Ÿ: ${delay}ms`);
      await this.sleep(delay);
    }
    
    try {
      const response = await fetch(PUSH_CONFIG.apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          token: PUSH_CONFIG.token,
          title: title,
          content: optimizedContent,
          template: 'html'
        })
      });
      
      const result = await response.json();
      
      if (result.code === 200) {
        console.log('âœ… å¾®ä¿¡æ¨é€å‘é€æˆåŠŸ');
        return { success: true, data: result };
      } else {
        console.error('âŒ å¾®ä¿¡æ¨é€å‘é€å¤±è´¥:', result.msg || result.message || 'æœªçŸ¥é”™è¯¯');
        
        // ç‰¹æ®Šå¤„ç†é¢‘ç‡é™åˆ¶é”™è¯¯
        if (result.code === 999 && result.data && result.data.includes('é¢‘ç‡è¿‡å¿«')) {
          console.warn('âš ï¸ è§¦å‘é¢‘ç‡é™åˆ¶');
          if (retryCount < 2) { // å‡å°‘é‡è¯•æ¬¡æ•°åˆ°2æ¬¡
            console.log(`ğŸ”„ é¢‘ç‡é™åˆ¶ï¼Œç­‰å¾…18ç§’åé‡è¯•...`);
            await this.sleep(18000); // å¢åŠ åˆ°18ç§’
            return await this.sendPush({
              ...pushData,
              retryCount: retryCount + 1
            });
          }
        }
        
        return { success: false, error: result.msg || result.message };
      }
    } catch (error) {
      console.error('âŒ å¾®ä¿¡æ¨é€è¯·æ±‚å¤±è´¥:', error);
      if (retryCount < 2) { // å‡å°‘é‡è¯•æ¬¡æ•°
        console.log(`ğŸ”„ ç½‘ç»œå¼‚å¸¸ï¼Œå‡†å¤‡é‡è¯•...`);
        await this.sleep(8000); // 8ç§’å»¶è¿Ÿ
        return await this.sendPush({
          ...pushData,
          retryCount: retryCount + 1
        });
      }
      throw error;
    }
  }
  
  // å†…å®¹ä¼˜åŒ– - å‡å°‘é•¿åº¦åŒæ—¶ä¿æŒå…³é”®ä¿¡æ¯
  optimizeContent(content) {
    console.log('ğŸ”§ ä¼˜åŒ–æ¨é€å†…å®¹...');
    
    // ç§»é™¤ä¸å¿…è¦çš„ç©ºç™½å’Œæ¢è¡Œ
    let optimized = content
      .replace(/\s+/g, ' ')
      .replace(/>\s+</g, '><')
      .trim();
    
    // å¦‚æœä»ç„¶è¿‡é•¿ï¼Œè¿›è¡Œæ›´æ¿€è¿›çš„ä¼˜åŒ–
    if (optimized.length > PUSH_CONFIG.maxContentLength) {
      console.log('ğŸ”§ è¿›è¡Œæ¿€è¿›ä¼˜åŒ–...');
      
      // åªä¿ç•™æœ€æ ¸å¿ƒçš„éƒ¨åˆ†
      const titleMatch = optimized.match(/<h3[^>]*>.*?<\/h3>/);
      const statsMatch = optimized.match(/<div[^>]*class="[^"]*ç»Ÿè®¡[^"]*"[^>]*>.*?<\/div>/);
      
      let newContent = '<div style="font-family: sans-serif; padding: 10px; background: #fff; border-radius: 6px;">';
      
      if (titleMatch) {
        newContent += titleMatch[0];
      }
      
      if (statsMatch) {
        newContent += statsMatch[0];
      }
      
      // åªä¿ç•™å‰2ä¸ªçƒ­é—¨è§†é¢‘
      const videoMatches = optimized.match(/<div[^>]*class="[^"]*çƒ­é—¨è§†é¢‘[^"]*"[^"]*">.*?<\/div>/g);
      if (videoMatches && videoMatches.length > 0) {
        newContent += '<div style="margin: 8px 0;"><strong>ğŸ”¥ çƒ­é—¨è§†é¢‘</strong></div>';
        newContent += videoMatches.slice(0, 2).join('');
      }
      
      newContent += '<div style="color: #999; font-size: 10px; margin-top: 8px;">å†…å®¹å·²ä¼˜åŒ–æ˜¾ç¤º</div>';
      newContent += '</div>';
      
      optimized = newContent;
    }
    
    console.log(`âœ… å†…å®¹ä¼˜åŒ–å®Œæˆ: ${content.length} -> ${optimized.length} å­—ç¬¦`);
    return optimized;
  }
  
  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// åˆ›å»ºå…¨å±€æ¨é€é˜Ÿåˆ—å®ä¾‹
const pushQueue = new PushQueue();

// ä¿®å¤åçš„æ¨é€å‡½æ•° - ä½¿ç”¨é˜Ÿåˆ—ç®¡ç†
async function sendWeChatPush(title, content, useQueue = true) {
  console.log(`ğŸ“¤ ä¿®å¤ç‰ˆæ¨é€å‡½æ•°è¢«è°ƒç”¨`);
  console.log(`ğŸ“‹ æ ‡é¢˜: ${title}`);
  console.log(`ğŸ“Š å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
  console.log(`ğŸ”„ ä½¿ç”¨é˜Ÿåˆ—: ${useQueue ? 'æ˜¯' : 'å¦'}`);
  
  try {
    if (useQueue) {
      const result = await pushQueue.add({ title, content });
      return result.success;
    } else {
      // ç›´æ¥å‘é€ï¼ˆç”¨äºç´§æ€¥æƒ…å†µï¼‰
      const result = await pushQueue.sendPush({ title, content });
      return result.success;
    }
  } catch (error) {
    console.error('âŒ æ¨é€å¤±è´¥:', error);
    return false;
  }
}

// å¸¦ç¼“å­˜å’Œè¶…æ—¶çš„AIåˆ†æåŠŸèƒ½
async function generateAIAnalysisWithTimeout(topVideos, searchTags, videoStats, timeoutMs = 30000) {
  console.log(`ğŸ¤– å¼€å§‹ç”ŸæˆAIåˆ†æï¼ˆè¶…æ—¶æ—¶é—´: ${timeoutMs}msï¼Œå«ç¼“å­˜æœºåˆ¶ï¼‰...`);
  
  // ç”Ÿæˆç¼“å­˜é”®
  const cacheKey = generateCacheKey(searchTags, videoStats, topVideos);
  
  // å…ˆæ£€æŸ¥ç¼“å­˜
  const cachedAnalysis = await getCachedAIAnalysis(cacheKey);
  if (cachedAnalysis) {
    console.log('ğŸ¯ è¿”å›ç¼“å­˜çš„AIåˆ†æç»“æœ');
    return cachedAnalysis;
  }
  console.log('ğŸ”„ ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹è°ƒç”¨APIç”ŸæˆAIåˆ†æ');
  
  // åˆ›å»ºè¶…æ—¶Promise
  let timeoutId;
  const timeoutPromise = new Promise((resolve) => {
    timeoutId = setTimeout(() => {
      console.warn('â° AIåˆ†æè¶…æ—¶ï¼Œå°†è·³è¿‡AIåˆ†æç»§ç»­æ¨é€');
      resolve({ timeout: true, data: null });
    }, timeoutMs);
  });
  
  // åˆ›å»ºAIåˆ†æPromiseï¼ˆä¼ é€’ç¼“å­˜é”®ï¼‰
  const aiAnalysisPromise = generateAIAnalysis(topVideos, searchTags, videoStats, cacheKey)
    .then(data => {
      clearTimeout(timeoutId); // çœŸå®è¯·æ±‚å®Œæˆåæ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
      return { timeout: false, data };
    });
  
  // ä½¿ç”¨Promise.raceå®ç°è¶…æ—¶æ§åˆ¶
  const result = await Promise.race([aiAnalysisPromise, timeoutPromise]);
  
  if (result.timeout) {
    console.log('âš ï¸ AIåˆ†æå› è¶…æ—¶è¢«è·³è¿‡');
    return null;
  }
  
  console.log('âœ… AIåˆ†æPromise.race ç»“æœ:', result.data ? `å†…å®¹é•¿åº¦ ${result.data.length}` : 'æ— å†…å®¹');
  return result.data;
}

// æ ‡é¢˜ç¿»è¯‘åŠŸèƒ½ - å°†è‹±æ–‡æ ‡é¢˜ç¿»è¯‘ä¸ºä¸­æ–‡å¹¶è§£é‡Šå†…å®¹
function translateTitle(title) {
  // ç®€å•çš„å…³é”®è¯ç¿»è¯‘å’Œè§£é‡Š
  const translations = {
    'AI': 'AIäººå·¥æ™ºèƒ½',
    'ChatGPT': 'ChatGPTèŠå¤©æœºå™¨äºº',
    'tutorial': 'æ•™ç¨‹',
    'guide': 'æŒ‡å—',
    'how to': 'å¦‚ä½•',
    'revolution': 'é©å‘½',
    'change': 'æ”¹å˜',
    'work': 'å·¥ä½œ',
    'deep learning': 'æ·±åº¦å­¦ä¹ ',
    'machine learning': 'æœºå™¨å­¦ä¹ ',
    'artificial intelligence': 'äººå·¥æ™ºèƒ½',
    'complete': 'å®Œæ•´',
    'beginner': 'æ–°æ‰‹',
    'advanced': 'é«˜çº§',
    'tips': 'æŠ€å·§',
    'tricks': 'çªé—¨',
    'review': 'è¯„æµ‹',
    'comparison': 'å¯¹æ¯”',
    'vs': 'å¯¹æ¯”',
    'best': 'æœ€ä½³',
    'top': 'é¡¶çº§',
    '2024': '2024å¹´',
    '2025': '2025å¹´'
  };
  
  let translated = title;
  for (const [en, zh] of Object.entries(translations)) {
    const regex = new RegExp(en, 'gi');
    translated = translated.replace(regex, zh);
  }
  
  // å¦‚æœè¿˜æ˜¯è‹±æ–‡ä¸ºä¸»ï¼Œæä¾›ç®€å•è§£é‡Š
  if (/^[a-zA-Z\s]+$/.test(translated)) {
    return `${translated} (AIæŠ€æœ¯ç›¸å…³å†…å®¹)`;
  }
  
  return translated;
}

// å†…å®¹æè¿°åŠŸèƒ½ - æ ¹æ®æ ‡é¢˜åˆ†æè§†é¢‘å†…å®¹
function describeContent(title, category) {
  if (title.includes('tutorial') || title.includes('guide') || title.includes('how to')) {
    return 'æ•™å­¦ç±»å†…å®¹ï¼Œæ‰‹æŠŠæ‰‹æ•™è§‚ä¼—ä½¿ç”¨AIå·¥å…·';
  }
  if (title.includes('review') || title.includes('comparison') || title.includes('vs')) {
    return 'è¯„æµ‹å¯¹æ¯”ç±»å†…å®¹ï¼Œåˆ†æä¸åŒAIå·¥å…·çš„ä¼˜ç¼ºç‚¹';
  }
  if (title.includes('tips') || title.includes('tricks') || title.includes('hack')) {
    return 'æŠ€å·§åˆ†äº«ç±»å†…å®¹ï¼Œæ•™è§‚ä¼—é«˜æ•ˆä½¿ç”¨AIçš„çªé—¨';
  }
  if (title.includes('2024') || title.includes('2025') || title.includes('new')) {
    return 'æœ€æ–°èµ„è®¯ç±»å†…å®¹ï¼Œä»‹ç»AIé¢†åŸŸçš„æ–°å‘å±•';
  }
  if (category === 'æ•™è‚²') {
    return 'æ•™è‚²ç±»å†…å®¹ï¼Œç³»ç»Ÿæ€§åœ°æ•™æˆAIçŸ¥è¯†';
  }
  if (category === 'å¯¹æ¯”') {
    return 'å¯¹æ¯”åˆ†æç±»å†…å®¹ï¼Œå¸®åŠ©è§‚ä¼—é€‰æ‹©åˆé€‚çš„AIå·¥å…·';
  }
  return 'å®ç”¨åˆ†äº«ç±»å†…å®¹ï¼Œå¸®åŠ©è§‚ä¼—æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨AIæŠ€æœ¯';
}

// ç”Ÿæˆçƒ­é—¨tagæ¨è
function generateHotTags(searchTags, videoStats) {
  const baseTags = [...searchTags];
  const recommendations = [];
  
  // åŸºäºæœç´¢æ ‡ç­¾æ‰©å±•
  if (searchTags.includes('AI') || searchTags.includes('äººå·¥æ™ºèƒ½')) {
    recommendations.push('#AIæ•™ç¨‹ - æ•™å­¦ç±»å†…å®¹æœ€å—æ¬¢è¿');
    recommendations.push('#ChatGPTä½¿ç”¨æŠ€å·§ - å®ç”¨æŠ€å·§ç±»å†…å®¹');
    recommendations.push('#AIå·¥å…·æ¨è - å·¥å…·è¯„æµ‹ç±»å†…å®¹');
  }
  
  if (searchTags.includes('ChatGPT')) {
    recommendations.push('#ChatGPTæç¤ºè¯ - æç¤ºè¯å·¥ç¨‹ç±»å†…å®¹');
    recommendations.push('#GPT4æ•™ç¨‹ - æ–°åŠŸèƒ½ä»‹ç»ç±»å†…å®¹');
  }
  
  // åŸºäºæ•°æ®è¡¨ç°æ¨è
  if (videoStats.hotVideos > 5) {
    recommendations.push('#çˆ†æ¬¾åˆ†æ - æ•°æ®åˆ†æç±»å†…å®¹');
  }
  
  if (videoStats.totalVideos > 20) {
    recommendations.push('#AIè¡Œä¸šè¶‹åŠ¿ - è¡Œä¸šåˆ†æç±»å†…å®¹');
  }
  
  // é€šç”¨çƒ­é—¨tag
  recommendations.push('#ç§‘æŠ€å‰æ²¿ - ç§‘æŠ€èµ„è®¯ç±»å†…å®¹');
  recommendations.push('#æ•°ç ç§‘æŠ€ - ç¡¬ä»¶è½¯ä»¶ç±»å†…å®¹');
  
  return recommendations.slice(0, 3); // è¿”å›å‰3ä¸ªæ¨è
}

// Deepseek AI åˆ†æå’Œé¢„æµ‹åŠŸèƒ½ï¼ˆå¸¦ç¼“å­˜ä¿å­˜ï¼‰
async function generateAIAnalysis(topVideos, searchTags, videoStats, cacheKey = null) {
  console.log('ğŸ¤– å¼€å§‹ç”ŸæˆAIåˆ†æå’Œé¢„æµ‹...');
  
  try {
    console.log('ğŸš€ å¼€å§‹ä¼˜åŒ–AIåˆ†ææµç¨‹...');
    
    // æ™ºèƒ½æ•°æ®é¢„å¤„ç† - åªæå–å…³é”®ä¿¡æ¯ï¼Œå‡å°‘tokenæ¶ˆè€—
    const keyMetrics = {
      avgViews: Math.round(videoStats.avgViews.replace(/[MK]/g, '') * (videoStats.avgViews.includes('M') ? 1000000 : 1000)),
      totalVideos: videoStats.totalVideos,
      hotVideoRatio: (videoStats.hotVideos / videoStats.totalVideos * 100).toFixed(1)
    };

    // ç²¾é€‰è§†é¢‘æ•°æ® - åªå–å‰3ä¸ªæœ€å…·ä»£è¡¨æ€§çš„è§†é¢‘ï¼Œè¿›ä¸€æ­¥å‡å°‘æ•°æ®é‡
    const selectedVideos = topVideos.slice(0, 3).map((video, index) => ({
      rank: index + 1,
      title: video.title.length > 30 ? video.title.substring(0, 30) + '...' : video.title, // è¿›ä¸€æ­¥æˆªæ–­æ ‡é¢˜
      viewCount: Math.round(video.viewCount / 1000) + 'K', // ç®€åŒ–è§‚çœ‹æ•°
      performance: Math.round(video.viewCount / Math.max(video.subscriberCount, 1)), // ç®€åŒ–è¡¨ç°ç³»æ•°
      isHot: video.viewCount > video.subscriberCount * 2,
      category: video.title.includes('tutorial') || video.title.includes('guide') ? 'æ•™ç¨‹' :
                video.title.includes('review') || video.title.includes('vs') ? 'è¯„æµ‹' :
                video.title.includes('tips') || video.title.includes('tricks') ? 'æŠ€å·§' : 'å…¶ä»–'
    }));

    // ä¼˜åŒ–çš„ç³»ç»Ÿæç¤ºè¯ - ä¸­æ–‡å†…å®¹ä¸“å®¶
    const systemPrompt = `ä½ æ˜¯YouTubeä¸­æ–‡å†…å®¹åˆ›ä½œä¸“å®¶ï¼Œæ“…é•¿åˆ†æè‹±æ–‡è§†é¢‘å†…å®¹å¹¶ä¸ºä¸­æ–‡åˆ›ä½œè€…æä¾›å®ç”¨å»ºè®®ã€‚è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„ä¸­æ–‡åˆ†æè§†é¢‘å†…å®¹è¶‹åŠ¿ã€‚`;

    // ä¼˜åŒ–çš„ç”¨æˆ·æç¤ºè¯ - è¶…ç®€æ´å¿«é€Ÿç‰ˆæœ¬
    const userPrompt = `åˆ†æ${searchTags.join('ã€')}é¢†åŸŸçˆ†æ¬¾è§†é¢‘ï¼š
  
  ğŸ“Š æ•°æ®ï¼š${keyMetrics.totalVideos}è§†é¢‘ï¼Œçˆ†æ¬¾ç‡${keyMetrics.hotVideoRatio}%ï¼Œå¹³å‡${(keyMetrics.avgViews / 1000).toFixed(0)}Kè§‚çœ‹
  
  ğŸ¬ çƒ­é—¨å†…å®¹ï¼š
  ${selectedVideos.map(v => {
    const titleZh = translateTitle(v.title);
    return `${v.rank}.ã€Š${titleZh}ã€‹${v.performance}å€è¡¨ç°`;
  }).join('\n')}
  
  è¯·å¿«é€Ÿæä¾›ï¼š
  1. å†…å®¹è¶‹åŠ¿ï¼ˆ30å­—å†…ï¼‰
  2. çƒ­é—¨tagï¼ˆ3ä¸ªï¼‰
  3. åˆ›ä½œæ–¹å‘ï¼ˆ2ä¸ªï¼‰
  4. è“æµ·æœºä¼šï¼ˆ1ä¸ªï¼‰
  
  è¦æ±‚ï¼šç®€æ´å®ç”¨ï¼Œä¸­æ–‡è¾“å‡ºï¼Œå¹¶ä½¿ç”¨Markdownæ ¼å¼ï¼ŒåŒ…å«æ ‡é¢˜å’Œåˆ—è¡¨ã€‚å¦‚æœæ— æ³•æä¾›å…·ä½“åˆ†æï¼Œè¯·è‡³å°‘è¿”å›ä¸€ä¸ªç®€è¦è¯´æ˜ï¼Œä¸è¦ç•™ç©ºã€‚`;

    const requestBody = {
      model: DEEPSEEK_CONFIG.model,
      messages: [
        {
          role: "system",
          content: systemPrompt
        },
        {
          role: "user",
          content: userPrompt
        }
      ],
      temperature: 0.1, // è¿›ä¸€æ­¥é™ä½æ¸©åº¦ï¼Œæé«˜ç¡®å®šæ€§
      max_tokens: 400,  // å¤§å¹…å‡å°‘tokenæ•°é‡åˆ°400ï¼ŒåŠ å¿«å“åº”
      stream: false     // å…³é—­æµå¼è¾“å‡ºï¼Œæé«˜ç¨³å®šæ€§
    };

    console.log('ğŸš€ è°ƒç”¨GPT-5-Nano AI API...');
    
    const response = await fetch(`${DEEPSEEK_CONFIG.apiUrl}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      console.error(`âŒ GPT-5-Nano API é”™è¯¯: ${response.status} ${response.statusText}`);
      return null;
    }

    const result = await response.json();
    
    if (result.choices && result.choices[0] && result.choices[0].message) {
      const aiAnalysis = result.choices[0].message.content;
      console.log('âœ… GPT-5-Nano AIåˆ†æç”ŸæˆæˆåŠŸ');
      console.log('ğŸ“ GPT-5-Nano AIåˆ†æå†…å®¹:', aiAnalysis ? aiAnalysis.substring(0, 200) + '...' : 'ç©º');
      console.log('ğŸ” AIåˆ†æç»“æœç±»å‹:', typeof aiAnalysis, 'é•¿åº¦:', aiAnalysis ? aiAnalysis.length : 0);
      
      // ç»“æœåˆ¤å®šï¼šç¡®ä¿ä¸æ˜¯ç©ºå­—ç¬¦ä¸²æˆ–çº¯ç©ºç™½å­—ç¬¦ä¸²
      if (aiAnalysis && typeof aiAnalysis === 'string' && aiAnalysis.trim().length > 0) {
        // ä¿å­˜åˆ°ç¼“å­˜
        if (cacheKey) {
          await saveCachedAIAnalysis(cacheKey, aiAnalysis);
        }
        return aiAnalysis;
      } else {
        console.error('âŒ AIåˆ†æç»“æœä¸ºç©ºæˆ–çº¯ç©ºç™½ (å¯èƒ½æ˜¯APIè¿”å›ç©ºå†…å®¹)');
        console.warn('ğŸ“¦ AIåŸå§‹å“åº”:', result);
        const fallbackAnalysis = generateFallbackAIInsights(topVideos, searchTags, videoStats);
        console.log('ğŸ›Ÿ ä½¿ç”¨æœ¬åœ°æ•°æ®ç”Ÿæˆçš„å…œåº•AIåˆ†æ');
        return fallbackAnalysis;
      }
    } else {
      console.error('âŒ AIåˆ†æç»“æœæ ¼å¼é”™è¯¯æˆ–ç¼ºå°‘å†…å®¹ (APIè¿”å›ç»“æ„ä¸ç¬¦åˆé¢„æœŸ)');
      const fallbackAnalysis = generateFallbackAIInsights(topVideos, searchTags, videoStats);
      console.log('ğŸ›Ÿ ä½¿ç”¨æœ¬åœ°æ•°æ®ç”Ÿæˆçš„å…œåº•AIåˆ†æ');
      return fallbackAnalysis;
    }
  } catch (error) {
    console.error('âŒ GPT-5-Nano AIåˆ†æç”Ÿæˆå¤±è´¥ (APIè¯·æ±‚å¼‚å¸¸):', error);
    const fallbackAnalysis = generateFallbackAIInsights(topVideos, searchTags, videoStats);
    console.log('ğŸ›Ÿ AIæ¥å£å¼‚å¸¸ï¼Œå›é€€è‡³æœ¬åœ°æ•°æ®æ´å¯Ÿ');
    return fallbackAnalysis;
  }
}

// æœ¬åœ°å…œåº•AIåˆ†æï¼Œä¿è¯æ¨é€æµç¨‹ä¸ä¼šå› ä¸ºLLMè¿”å›ç©ºå†…å®¹è€Œä¸­æ–­
function generateFallbackAIInsights(topVideos, searchTags, videoStats) {
  const safeVideos = Array.isArray(topVideos) ? topVideos : [];
  const safeTags = (Array.isArray(searchTags) && searchTags.length > 0) ? searchTags : ['AI'];
  const totalVideos = videoStats && videoStats.totalVideos ? videoStats.totalVideos : safeVideos.length;
  const totalChannels = videoStats && videoStats.totalChannels ? videoStats.totalChannels : new Set(safeVideos.map(v => v.channelId)).size;
  const avgViewsText = typeof (videoStats && videoStats.avgViews) === 'string'
    ? videoStats.avgViews
    : formatNumber(videoStats && videoStats.avgViews ? videoStats.avgViews : 0);
  const hotVideos = videoStats && typeof videoStats.hotVideos === 'number'
    ? videoStats.hotVideos
    : safeVideos.filter(video => video.viewCount > video.subscriberCount * 2).length;
  const hotRatio = totalVideos ? Math.round((hotVideos / totalVideos) * 100) : 0;
  
  const highlights = safeVideos.slice(0, Math.min(3, safeVideos.length)).map((video, index) => {
    const isHot = video.viewCount > video.subscriberCount * 2;
    return `- **TOP ${index + 1}** ${video.title}ï¼ˆğŸ‘ï¸ ${formatNumberSimple(video.viewCount)} | ğŸ‘ ${formatNumberSimple(video.likeCount || 0)}${isHot ? ' | ğŸ”¥ çˆ†æ¬¾' : ''}ï¼‰`;
  }).join('\n') || '- æš‚æ— å¯ç”¨çš„çƒ­é—¨è§†é¢‘æ•°æ®';
  
  const tagSuggestions = typeof generateHotTags === 'function'
    ? generateHotTags(safeTags, { ...(videoStats || {}), totalVideos, hotVideos })
    : [];
  const tagLines = (tagSuggestions && tagSuggestions.length > 0)
    ? tagSuggestions.map(tag => `- ${tag}`).join('\n')
    : '- å»ºè®®èšç„¦ç»†åˆ†åœºæ™¯ï¼Œæ­é…â€œæ•™ç¨‹ / å®æˆ˜ / æ¡ˆä¾‹â€ç­‰å…³é”®è¯';
  
  const creativeTips = [
    `- èšç„¦ ${safeTags.slice(0, 2).join('ã€') || safeTags[0]} çš„å®æˆ˜æ•™ç¨‹ï¼Œçªå‡ºå¯å¤åˆ¶æµç¨‹`,
    '- æ ‡é¢˜ç»“åˆã€Œç—›ç‚¹+æˆæœã€ç»“æ„ï¼Œå°é¢ç”¨é«˜å¯¹æ¯”è‰²å¼ºåŒ–ç‚¹å‡»æ„å›¾',
    `- ${hotRatio >= 30 ? 'çˆ†æ¬¾å¯†åº¦è¾ƒé«˜ï¼Œå¯å¿«é€Ÿå¤åˆ»é«˜äº’åŠ¨é¢˜æ' : 'çˆ†æ¬¾ç‡æ™®é€šï¼Œé€‚åˆåˆ‡å…¥æ›´å‚ç›´çš„ç»†åˆ†éœ€æ±‚'}`
  ].join('\n');
  
  return `### ğŸ¤– AIæ´å¯Ÿï¼ˆè‡ªåŠ¨å¤‡é€‰æ–¹æ¡ˆï¼‰
**æ ‡ç­¾ï¼š** ${safeTags.join(' / ')}
**æ•´ä½“è¡¨ç°ï¼š** ${totalVideos} ä¸ªè§†é¢‘ | ${totalChannels || '-'} ä¸ªé¢‘é“ | å¹³å‡ ${avgViewsText} è§‚çœ‹ | çˆ†æ¬¾ç‡ ${hotRatio || 0}%

#### ğŸ”¥ é«˜æ½œå†…å®¹
${highlights}

#### ğŸ¯ çƒ­é—¨æ ‡ç­¾æ¨è
${tagLines}

#### ğŸš€ åˆ›ä½œæ–¹å‘å»ºè®®
${creativeTips}

> LLM æ¥å£æš‚æ—¶ä¸å¯ç”¨ï¼Œä»¥ä¸Šæ´å¯Ÿç”±æœ¬åœ°ç®—æ³•æ ¹æ®å½“å‰æ•°æ®è‡ªåŠ¨ç”Ÿæˆï¼Œç¡®ä¿æŠ¥å‘Šå…ˆäºæ¨é€ã€‚`;
}
    
    // ç”Ÿæˆæ¨é€å†…å®¹ - å¢åŠ å°é¢ä¸AIæŠ¥å‘Šæ’ç‰ˆ
    function generatePushContent(searchTags, videoStats, topVideos, videoCount = 5, aiAnalysis = null) {
      const now = new Date().toLocaleString('zh-CN');
      const heroVideo = topVideos && topVideos.length > 0 ? topVideos[0] : null;
      const displayVideos = Array.isArray(topVideos) ? topVideos.slice(0, Math.min(videoCount, topVideos.length)) : [];
      
      let content = `
        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 14px; background: #f4f6fb; border-radius: 10px;">
          <div style="text-align: center; margin-bottom: 14px;">
            <h3 style="margin: 0; color: #0f172a; font-size: 18px;">ğŸ¯ YouTubeä½ç²‰çˆ†æ¬¾é›·è¾¾æŠ¥å‘Š</h3>
            <p style="margin: 6px 0 0 0; color: #475569; font-size: 12px;">${now}</p>
          </div>
      `;
      
      if (heroVideo) {
        const heroCover = heroVideo.thumbnail ? `<img src="${heroVideo.thumbnail}" alt="${escapeHtml(heroVideo.title)}" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter: brightness(0.55);">` : '';
        content += `
          <div style="position:relative; border-radius: 12px; overflow:hidden; margin-bottom: 12px; box-shadow: 0 8px 24px rgba(15,23,42,0.25); background: linear-gradient(135deg, #0f172a, #1d4ed8);">
            ${heroCover}
            <div style="position:relative; padding: 16px 18px; color: #fff;">
              <div style="font-size: 11px; letter-spacing: 1px; text-transform: uppercase; opacity: 0.9;">ä»Šæ—¥å°é¢</div>
              <div style="font-size: 16px; font-weight: 600; margin: 6px 0 10px 0;">${escapeHtml(heroVideo.title)}</div>
              <div style="display:flex; flex-wrap:wrap; gap:12px; font-size: 12px; opacity: 0.95;">
                <span>ğŸ‘ï¸ ${formatNumberSimple(heroVideo.viewCount)} è§‚çœ‹</span>
                <span>ğŸ‘ ${formatNumberSimple(heroVideo.likeCount || 0)} äº’åŠ¨</span>
                <span>ğŸ“º ${escapeHtml(heroVideo.channelTitle || 'çƒ­é—¨é¢‘é“')}</span>
              </div>
            </div>
          </div>
        `;
      }
      
      if (searchTags && searchTags.length > 0) {
        content += `
          <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">
            <div style="color: #2563eb; font-weight: 600; font-size: 12px; margin-bottom: 6px;">ğŸ” æœç´¢æ ‡ç­¾</div>
            <div style="color: #0f172a; font-size: 11px; line-height: 1.5;">${searchTags.map(tag => `<span style="display:inline-block; background: rgba(37,99,235,0.08); color:#1d4ed8; padding:3px 10px; border-radius:999px; margin: 2px 4px 2px 0;">${escapeHtml(tag)}</span>`).join('')}</div>
          </div>
        `;
      }
      
      if (videoStats) {
        content += `
          <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0;">
            <div style="color: #2563eb; font-weight: 600; font-size: 12px; margin-bottom: 6px;">ğŸ“Š æ•°æ®æ¦‚è§ˆ</div>
            <div style="display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 6px; font-size: 12px; color: #0f172a;">
              <div style="background:#f8fafc; padding:6px 8px; border-radius:6px;">è§†é¢‘æ€»é‡ <strong>${videoStats.totalVideos}</strong></div>
              <div style="background:#f8fafc; padding:6px 8px; border-radius:6px;">é¢‘é“æ•° <strong>${videoStats.totalChannels}</strong></div>
              <div style="background:#f8fafc; padding:6px 8px; border-radius:6px;">å¹³å‡è§‚çœ‹ <strong>${videoStats.avgViews}</strong></div>
              <div style="background:#f8fafc; padding:6px 8px; border-radius:6px;">çˆ†æ¬¾æ•°é‡ <strong style="color:#ef4444;">${videoStats.hotVideos}</strong></div>
            </div>
          </div>
        `;
      }
      
      if (displayVideos.length > 0) {
        content += `
          <div style="background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="color: #f97316; font-weight: 600; font-size: 12px; margin-bottom: 8px;">ğŸ”¥ çƒ­é—¨è§†é¢‘æ¸…å•</div>
            ${displayVideos.map((video, index) => {
              const isHot = video.viewCount > video.subscriberCount * 2;
              return `
                <div style="display:flex; gap:10px; padding:8px 0; border-bottom:${index === displayVideos.length - 1 ? 'none' : '1px solid #f1f5f9'};">
                  <div style="width:52px; height:34px; border-radius:6px; overflow:hidden; flex-shrink:0; background:#cbd5f5;">
                    ${video.thumbnail ? `<img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" style="width:100%; height:100%; object-fit:cover;">` : ''}
                  </div>
                  <div style="flex:1; min-width:0;">
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
                      <span style="background:${index === 0 ? '#f97316' : '#94a3b8'}; color:#fff; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:600;">${index + 1}</span>
                      <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank" style="flex:1; font-size:12px; font-weight:600; color:#0f172a; text-decoration:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(video.title)}</a>
                    </div>
                    <div style="font-size:11px; color:#475569;">
                      ğŸ‘ï¸ ${formatNumberSimple(video.viewCount)}ã€€ğŸ‘ ${formatNumberSimple(video.likeCount || 0)}${isHot ? 'ã€€<span style="color:#ef4444;">ğŸ”¥ çˆ†æ¬¾è¡¨ç°</span>' : ''}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      const aiReport = buildAIReportSection(aiAnalysis, displayVideos);
      if (aiReport) {
        content += aiReport;
      }
      
      content += '</div>';
      return content;
    }

    function buildAIReportSection(aiAnalysis, topVideos) {
      const insights = formatAITrendText(aiAnalysis);
      const hasVideos = Array.isArray(topVideos) && topVideos.length > 0;
      if (!insights && !hasVideos) {
        return '';
      }
      
      const highlightCards = hasVideos ? `
        <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
          ${topVideos.slice(0, 3).map((video, index) => `
            <div style="background:#f8fafc; border-radius:7px; padding:8px;">
              <div style="font-size:12px; font-weight:600; color:#0f172a; margin-bottom:4px;">TOP ${index + 1} Â· ${escapeHtml(video.title)}</div>
              <div style="font-size:11px; color:#475569;">ğŸ‘ï¸ ${formatNumberSimple(video.viewCount)} | ğŸ‘ ${formatNumberSimple(video.likeCount || 0)} | ${video.viewCount > video.subscriberCount * 2 ? 'ğŸ”¥ è¶…é¢è¡¨ç°' : 'ğŸ“ˆ ç¨³å®šå¢é•¿'}</div>
            </div>
          `).join('')}
        </div>
      ` : '';
      
      return `
        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid #d8b4fe; margin-top: 12px;">
          <div style="color: #7c3aed; font-weight: 600; font-size: 13px; margin-bottom: 6px;">ğŸ¤– AI çƒ­é—¨å†…å®¹ & è¶‹åŠ¿æ´å¯Ÿ</div>
          ${highlightCards}
          ${insights ? `<div style="margin-top:10px; font-size:12px; color:#4338ca;">ğŸ“ˆ è¶‹åŠ¿é€Ÿè§ˆ</div><div style="font-size:11px; color:#312e81; line-height:1.6; margin-top:4px;">${insights}</div>` : ''}
        </div>
      `;
    }

    function formatAITrendText(aiAnalysis) {
      if (!aiAnalysis || typeof aiAnalysis !== 'string' || aiAnalysis.trim().length === 0) {
        return '';
      }
      
      const lines = aiAnalysis.replace(/\r/g, '').split('\n');
      let html = '';
      let isListOpen = false;
      
      const closeList = () => {
        if (isListOpen) {
          html += '</ul>';
          isListOpen = false;
        }
      };
      
      lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) {
          closeList();
          return;
        }
        if (/^[-*]/.test(trimmed) || /^\d+\./.test(trimmed)) {
          if (!isListOpen) {
            html += '<ul style="margin:4px 0 4px 18px; padding:0; color:#1e1b4b;">';
            isListOpen = true;
          }
          const clean = trimmed.replace(/^[-*\d.]+\s*/, '');
          html += `<li style="margin:2px 0;">${escapeHtml(clean)}</li>`;
          return;
        }
        if (/^#+\s/.test(trimmed)) {
          closeList();
          html += `<div style="font-weight:600; margin-top:6px; color:#4338ca;">${escapeHtml(trimmed.replace(/^#+\s*/, ''))}</div>`;
          return;
        }
        closeList();
        html += `<p style="margin:4px 0; color:#312e81;">${escapeHtml(trimmed)}</p>`;
      });
      
      closeList();
      return html;
    }
    
    // ç®€åŒ–çš„æ•°å­—æ ¼å¼åŒ–
    function formatNumberSimple(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }
    
    async function fetchVideos() {
      // æ ¹æ®æœç´¢æ¨¡å¼è·å–æœç´¢æŸ¥è¯¢
      if (searchMode === 'batch') {
        await fetchVideosBatch();
      } else {
        await fetchVideosSingle();
      }
      
      // æµ‹è¯•å¾®ä¿¡æ¨é€åŠŸèƒ½
      async function testWeChatPush() {
        if (filteredVideos.length === 0) {
          showMessage('è¯·å…ˆè¿›è¡Œåˆ†æï¼Œè·å–è§†é¢‘æ•°æ®åå†æµ‹è¯•æ¨é€', 'warning');
          return;
        }
        
        showMessage('æ­£åœ¨æµ‹è¯•å¾®ä¿¡æ¨é€åŠŸèƒ½...', 'info', 2000);
        
        try {
          const searchTags = currentSearchTags.length > 0 ? currentSearchTags : ['æµ‹è¯•æ ‡ç­¾'];
          const videoStats = {
            totalVideos: Math.min(5, filteredVideos.length), // æµ‹è¯•ç”¨å°‘é‡æ•°æ®
            totalChannels: 3,
            avgViews: '15K',
            hotVideos: 2
          };
          
          // è·å–å‰3ä¸ªè§†é¢‘ç”¨äºæµ‹è¯•
          const testVideos = filteredVideos.slice(0, 3);
          
          // ç”ŸæˆAIåˆ†æï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
          console.log('ğŸ§ª ç”Ÿæˆæµ‹è¯•AIåˆ†æ...');
          const aiAnalysis = await generateAIAnalysis(testVideos, searchTags, videoStats);
          
          const testTitle = aiAnalysis ? `ğŸ¤– AIæµ‹è¯•ï¼šå¾®ä¿¡æ¨é€æµ‹è¯• - ${new Date().toLocaleString('zh-CN')}` : `ï¿½ å¾®ä¿¡æ¨é€æµ‹è¯• - ${new Date().toLocaleString('zh-CN')}`;
          const testContent = generatePushContent(searchTags, videoStats, testVideos, 3, aiAnalysis);
          
          console.log(`ğŸ§ª å‘é€æµ‹è¯•æ¨é€...`);
          
          const success = await sendWeChatPush(testTitle, testContent);
          
          if (success) {
            showMessage('âœ… æµ‹è¯•æ¨é€å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥å¾®ä¿¡', 'success', 5000);
          } else {
            showMessage('âŒ æµ‹è¯•æ¨é€å‘é€å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', 'error', 5000);
          }
        } catch (error) {
          console.error('æµ‹è¯•æ¨é€å¤±è´¥:', error);
          showMessage('âŒ æµ‹è¯•æ¨é€å‘ç”Ÿå¼‚å¸¸', 'error', 5000);
        }
      }
      
      // å‘é€å¾®ä¿¡æ¨é€
      if (allVideos.length > 0) {
        console.log(`ğŸ“± å‡†å¤‡å‘é€å¾®ä¿¡æ¨é€ï¼Œå…± ${allVideos.length} ä¸ªè§†é¢‘ï¼Œç­›é€‰å ${filteredVideos.length} ä¸ª`);
        
        const searchTags = currentSearchTags.length > 0 ? currentSearchTags : ['æœªçŸ¥æ ‡ç­¾'];
        const videoStats = {
          totalVideos: filteredVideos.length,
          totalChannels: new Set(filteredVideos.map(v => v.channelId)).size,
          avgViews: formatNumber(Math.round(filteredVideos.reduce((sum, v) => sum + v.viewCount, 0) / filteredVideos.length)),
          hotVideos: filteredVideos.filter(v => v.viewCount > v.subscriberCount * 2).length
        };
        
        console.log(`ğŸ“Š æ¨é€ç»Ÿè®¡æ•°æ®:`, videoStats);
        
        // åªç­›é€‰è§‚çœ‹æ•°æœ€é«˜çš„10ä¸ªè§†é¢‘è¿›è¡Œæ¨é€ï¼ˆä¸ç®¡æ€»è§†é¢‘æ•°é‡å¤šå°‘ï¼‰
        const PUSH_TOP_VIDEOS = 10; // å›ºå®šæ¨é€è§‚çœ‹æ•°æœ€é«˜çš„10ä¸ªè§†é¢‘
        const topVideos = [...filteredVideos]
          .sort((a, b) => b.viewCount - a.viewCount)
          .slice(0, PUSH_TOP_VIDEOS);
        
        console.log(`ğŸ¬ ä» ${filteredVideos.length} ä¸ªè§†é¢‘ä¸­ç­›é€‰å‡ºè§‚çœ‹æ•°æœ€é«˜çš„ ${topVideos.length} ä¸ªè§†é¢‘è¿›è¡Œæ¨é€`);
        
        // å¦‚æœé«˜è´¨é‡è§†é¢‘ä¸è¶³10ä¸ªï¼Œåˆ™ä½¿ç”¨å®é™…æ•°é‡
        const actualPushCount = Math.min(PUSH_TOP_VIDEOS, topVideos.length);
        
        // ç”ŸæˆAIåˆ†æå’Œé¢„æµ‹ï¼ˆå¸¦è¶…æ—¶æœºåˆ¶ï¼‰
        console.log('ğŸ¤– å¼€å§‹ç”ŸæˆAIæ´å¯Ÿåˆ†æ...');
        let aiAnalysis = null;
        
        // åˆ›å»ºå¸¦è¶…æ—¶çš„AIåˆ†æPromiseï¼ˆå»¶é•¿è¶…æ—¶æ—¶é—´ - 30ç§’è¶…æ—¶ï¼‰
        const aiAnalysisPromise = generateAIAnalysisWithTimeout(topVideos, searchTags, videoStats, 30000); // 30ç§’è¶…æ—¶
        
        try {
          aiAnalysis = await aiAnalysisPromise;
          console.log('ğŸ¯ AIåˆ†æPromiseè¿”å›ç»“æœ (åŸå§‹):', aiAnalysis ? aiAnalysis.substring(0, 200) + '...' : 'ç©º');
          console.log('ğŸ” AIåˆ†æPromiseè¿”å›ç»“æœç±»å‹:', typeof aiAnalysis, 'é•¿åº¦:', aiAnalysis ? aiAnalysis.length : 0);
          
          // ç¡®ä¿aiAnalysisæ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²å†…å®¹
          if (aiAnalysis && typeof aiAnalysis === 'string' && aiAnalysis.trim().length > 0) {
            console.log('âœ… AIåˆ†æç”ŸæˆæˆåŠŸï¼Œå†…å®¹é•¿åº¦:', aiAnalysis.length, 'å­—ç¬¦');
          } else {
            console.log('âš ï¸ AIåˆ†æç»“æœä¸ºç©ºæˆ–æ— æ•ˆï¼Œå°†ç»§ç»­æ­£å¸¸æ¨é€');
            aiAnalysis = null; // æ˜ç¡®è®¾ç½®ä¸ºnullï¼Œç¡®ä¿èµ°åŸºç¡€æ¨é€é€»è¾‘
          }
        } catch (aiError) {
          console.error('âŒ AIåˆ†æå¼‚å¸¸:', aiError);
          aiAnalysis = null; // ç¡®ä¿AIåˆ†æå¤±è´¥æ—¶ä¸å½±å“æ­£å¸¸æ¨é€
        }
        
        // å®æ–½æ™ºèƒ½å•æ¨é€ç­–ç•¥ - ä¼˜åŒ–é¢åº¦ä½¿ç”¨
        console.log('ğŸ“¤ å‡†å¤‡å®æ–½æ™ºèƒ½å•æ¨é€ç­–ç•¥...');
        
        // æ ¹æ®AIåˆ†æç»“æœå†³å®šæ¨é€å†…å®¹
        let pushTitle, pushContent, pushMessage;
        
        if (aiAnalysis) {
          // AIåˆ†ææˆåŠŸï¼Œå‘é€AIå¢å¼ºç‰ˆæ¨é€
          console.log('âœ… AIåˆ†ææˆåŠŸï¼Œå‘é€AIå¢å¼ºç‰ˆæ¨é€');
          pushTitle = `ğŸ¤– AIæ´å¯Ÿï¼šYouTubeçˆ†æ¬¾åˆ†æ - ${searchTags.join(', ')}`;
          pushContent = generatePushContent(searchTags, videoStats, topVideos, actualPushCount, aiAnalysis);
          pushMessage = 'âœ… AIæ´å¯ŸæŠ¥å‘Šå·²å‘é€åˆ°å¾®ä¿¡';
        } else {
          // AIåˆ†æå¤±è´¥æˆ–è¶…æ—¶ï¼Œå‘é€åŸºç¡€æ¨é€
          console.log('âš ï¸ AIåˆ†æå¤±è´¥æˆ–è¶…æ—¶ï¼Œå‘é€åŸºç¡€æ¨é€');
          pushTitle = `YouTubeçˆ†æ¬¾åˆ†æå®Œæˆ - ${searchTags.join(', ')}`;
          pushContent = generatePushContent(searchTags, videoStats, topVideos, actualPushCount, null);
          pushMessage = 'âœ… åˆ†æç»“æœå·²å‘é€åˆ°å¾®ä¿¡ï¼ˆAIæ´å¯Ÿä¸å¯ç”¨ï¼‰';
        }
        
        // å‘é€å•æ¡æ¨é€
        console.log(`ğŸ“¤ å‘é€${aiAnalysis ? 'AIå¢å¼º' : 'åŸºç¡€'}æ¨é€...`);
        const pushPromise = sendWeChatPush(pushTitle, pushContent);
        
        // ç­‰å¾…æ¨é€ç»“æœï¼Œå¢å¼ºé”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
        pushPromise.then(success => {
          if (success) {
            console.log('âœ… æ¨é€å‘é€æˆåŠŸ');
            showMessage(pushMessage, 'success', 5000);
          } else {
            console.log('âŒ æ¨é€å‘é€å¤±è´¥');
            // è¿™é‡Œçš„é”™è¯¯æç¤ºéœ€è¦åŒºåˆ†æ˜¯AIåˆ†æå¤±è´¥å¯¼è‡´çš„æ¨é€å†…å®¹é™çº§ï¼Œè¿˜æ˜¯æ¨é€æœ¬èº«å¤±è´¥
            if (aiAnalysis === null) {
              // å¦‚æœaiAnalysisæ˜¯nullï¼Œè¯´æ˜æ˜¯AIåˆ†æå¤±è´¥æˆ–è¶…æ—¶ï¼Œå¯¼è‡´æ¨é€é™çº§
              showMessage('âš ï¸ AIæ´å¯Ÿè¶…æ—¶æˆ–ç”Ÿæˆå¤±è´¥ï¼Œä½†åŸºç¡€åˆ†æç»“æœå·²å‘é€åˆ°å¾®ä¿¡ï¼', 'warning', 8000);
            } else {
              // å¦‚æœaiAnalysisæœ‰å†…å®¹ä½†æ¨é€å¤±è´¥ï¼Œè¯´æ˜æ˜¯æ¨é€æœ¬èº«çš„ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–é”™è¯¯
              showMessage('âš ï¸ å¾®ä¿¡æ¨é€æš‚æ—¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ï¼æ‚¨çš„åˆ†æç»“æœå·²å®Œå…¨ä¿å­˜', 'warning', 8000);
            }
          }
        }).catch(error => {
          console.error('âŒ æ¨é€å‘ç”Ÿå¼‚å¸¸:', error);
          if (aiAnalysis === null) {
            showMessage('âŒ AIæ´å¯Ÿè¶…æ—¶æˆ–ç”Ÿæˆå¤±è´¥ï¼Œä¸”åŸºç¡€åˆ†æç»“æœæ¨é€å‘ç”Ÿå¼‚å¸¸ï¼è¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—', 'error', 8000);
          } else {
            showMessage('âŒ å¾®ä¿¡æ¨é€é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œä½†æ‚¨çš„AIæ´å¯Ÿåˆ†æç»“æœå·²å®‰å…¨ä¿å­˜ï¼è¯·ç¨åé‡è¯•', 'error', 8000);
          }
        });
      } else {
        console.log(`âš ï¸ æ²¡æœ‰è§†é¢‘æ•°æ®ï¼Œè·³è¿‡å¾®ä¿¡æ¨é€`);
      }
    }
    
    // å•æ ‡ç­¾æœç´¢æ¨¡å¼
    async function fetchVideosSingle() {
      const apiKey = getCurrentApiKey();
      const searchQuery = document.getElementById('searchQuery').value.trim();
      
      if (!searchQuery) {
        showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
        return;
      }
      
      if (!apiKey) {
        showMessage('æ‰€æœ‰APIéƒ½ä¸å¯ç”¨ï¼Œè¯·è¾“å…¥è‡ªå®šä¹‰API Key', 'error');
        return;
      }
      
      // æ¸…ç©ºæ—§ç¼“å­˜
      await clearSearchCache();
      
      currentSearchTags = [searchQuery];
      tagStats = {};
      
      document.getElementById('loadingDiv').style.display = 'block';
      document.getElementById('resultsDiv').innerHTML = '';
      document.getElementById('errorDiv').style.display = 'none';
      document.getElementById('loadingText').textContent = 'æ­£åœ¨è·å–æ•°æ®...';
      document.getElementById('progressBar').style.display = 'none';
      document.getElementById('progressInfo').style.display = 'none';
      
      try {
        const publishedAfter = getPublishedAfterDate();
        const videos = await searchSingleTag(searchQuery, 50, publishedAfter);
        
        allVideos = videos;
        tagStats[searchQuery] = videos.length;
        
        filteredVideos = [...allVideos];
        applyFilters();
        
      } catch (error) {
        showMessage('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
        console.error(error);
      } finally {
        document.getElementById('loadingDiv').style.display = 'none';
      }
    }
    
    // æ‰¹é‡æ ‡ç­¾æœç´¢æ¨¡å¼
    async function fetchVideosBatch() {
      const batchInput = document.getElementById('batchSearchQuery').value.trim();
      const tags = parseTags(batchInput);
      
      if (tags.length === 0) {
        showMessage('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ ‡ç­¾', 'error');
        return;
      }
      
      const apiKey = getCurrentApiKey();
      if (!apiKey) {
        showMessage('æ‰€æœ‰APIéƒ½ä¸å¯ç”¨ï¼Œè¯·åœ¨APIç®¡ç†å·¥å…·ä¸­æ·»åŠ ', 'error');
        return;
      }
      
      // æ¸…ç©ºæ—§ç¼“å­˜
      await clearSearchCache();
      
      // è·å–é…ç½®
      const resultsPerTag = parseInt(document.getElementById('resultsPerTag').value) || 10;
      const shouldDeduplicate = document.getElementById('deduplicateVideos').checked;
      
      currentSearchTags = tags;
      tagStats = {};
      
      const loadingDiv = document.getElementById('loadingDiv');
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressInfo = document.getElementById('progressInfo');
      
      loadingDiv.style.display = 'block';
      progressBar.style.display = 'block';
      progressInfo.style.display = 'block';
      document.getElementById('resultsDiv').innerHTML = '';
      document.getElementById('errorDiv').style.display = 'none';
      
      try {
        const publishedAfter = getPublishedAfterDate();
        let allFetchedVideos = [];
        let completed = 0;
        let currentActive = 0;
        let successCount = 0;
        let failCount = 0;
        
        // åˆ›å»ºä»»åŠ¡æ•°ç»„
        const tasks = tags.map((tag, index) => async () => {
          currentActive++;
          loadingText.textContent = `æ­£åœ¨æœç´¢: ${tag} (${completed + 1}/${tags.length}) [è¿›è¡Œä¸­: ${currentActive}]`;
          
          try {
            // æ·»åŠ å»¶è¿Ÿé¿å…APIé™æµ
            if (index > 0) {
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const videos = await searchSingleTag(tag, resultsPerTag, publishedAfter);
            tagStats[tag] = videos.length;
            successCount++;
            currentActive--;
            completed++;
            
            // æ›´æ–°è¿›åº¦
            const percentage = Math.round((completed / tags.length) * 100);
            progressFill.style.width = percentage + '%';
            progressInfo.textContent = `å·²å®Œæˆ ${completed}/${tags.length} | æˆåŠŸ: ${successCount} | å¤±è´¥: ${failCount} | å·²è·å–: ${allFetchedVideos.length + videos.length} ä¸ªè§†é¢‘`;
            
            console.log(`âœ… æ ‡ç­¾ "${tag}" æœç´¢å®Œæˆï¼Œè·å– ${videos.length} ä¸ªè§†é¢‘`);
            return videos;
          } catch (error) {
            console.error(`âŒ æ ‡ç­¾ "${tag}" æœç´¢å¤±è´¥:`, error);
            tagStats[tag] = 0;
            failCount++;
            currentActive--;
            completed++;
            
            // æ›´æ–°è¿›åº¦
            const percentage = Math.round((completed / tags.length) * 100);
            progressFill.style.width = percentage + '%';
            progressInfo.textContent = `å·²å®Œæˆ ${completed}/${tags.length} | æˆåŠŸ: ${successCount} | å¤±è´¥: ${failCount} | å·²è·å–: ${allFetchedVideos.length} ä¸ªè§†é¢‘`;
            
            return [];
          }
        });
        
        // ä½¿ç”¨å¹¶å‘æ§åˆ¶å™¨æ‰§è¡Œä»»åŠ¡ï¼ˆæœ€å¤š3ä¸ªå¹¶å‘ï¼‰
        const results = await promiseConcurrency(tasks, 3, (completedCount, total) => {
          // è¿›åº¦å›è°ƒå·²åœ¨ä»»åŠ¡å†…éƒ¨å¤„ç†
        });
        
        // æ”¶é›†æ‰€æœ‰æˆåŠŸçš„ç»“æœ
        results.forEach(result => {
          if (result.success && result.data) {
            allFetchedVideos.push(...result.data);
          }
        });
        
        // å»é‡å¤„ç†
        if (shouldDeduplicate) {
          allVideos = deduplicateVideos(allFetchedVideos);
          console.log(`å»é‡å‰: ${allFetchedVideos.length} ä¸ªï¼Œå»é‡å: ${allVideos.length} ä¸ª`);
        } else {
          allVideos = allFetchedVideos;
        }
        
        filteredVideos = [...allVideos];
        applyFilters();
        
        showMessage(`æœç´¢å®Œæˆï¼å…±è·å– ${allVideos.length} ä¸ªè§†é¢‘ (æˆåŠŸ: ${successCount}ä¸ªæ ‡ç­¾, å¤±è´¥: ${failCount}ä¸ªæ ‡ç­¾)`, successCount > 0 ? 'success' : 'error', 5000);
        
      } catch (error) {
        showMessage('è·å–æ•°æ®å¤±è´¥: ' + error.message, 'error');
        console.error(error);
      } finally {
        loadingDiv.style.display = 'none';
      }
    }
    
    function getPublishedAfterDate() {
      const publishedAfter = document.getElementById('publishedAfter').value;
      const date = new Date();
      
      switch(publishedAfter) {
        case 'day':
          date.setDate(date.getDate() - 1);
          break;
        case 'week':
          date.setDate(date.getDate() - 7);
          break;
        case 'month':
          date.setMonth(date.getMonth() - 1);
          break;
      }
      
      return date.toISOString();
    }
    
    function applyFilters() {
      const maxSubscribers = parseInt(document.getElementById('maxSubscribers').value) || Infinity;
      const minViews = parseInt(document.getElementById('minViews').value) || 0;
      const regionFilter = document.getElementById('regionFilter').value;
      
      filteredVideos = allVideos.filter(video => {
        const subscriberMatch = video.subscriberCount <= maxSubscribers;
        const viewMatch = video.viewCount >= minViews;
        const regionMatch = !regionFilter || video.country === regionFilter;
        
        return subscriberMatch && viewMatch && regionMatch;
      });
      
      displayVideos();
      updateStats();
      
      // è‡ªåŠ¨ä¿å­˜æŸ¥è¯¢ç»“æœåˆ°ç¼“å­˜
      saveSearchCache();
    }
    
    function displayVideos() {
      const resultsDiv = document.getElementById('resultsDiv');
      
      if (filteredVideos.length === 0) {
        resultsDiv.innerHTML = '<div class="loading"><p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è§†é¢‘</p></div>';
        return;
      }
      
      resultsDiv.innerHTML = filteredVideos.map(video => {
        const isHot = video.viewCount > video.subscriberCount * 2;
        const isChecked = selectedVideos.has(video.videoId);
        const selectedClass = isChecked ? ' selected' : '';
        
        return `
          <div class="video-card${selectedClass}" onclick="openVideo('${video.videoId}', event)">
            <div class="video-thumbnail">
              <input type="checkbox" 
                class="video-checkbox" 
                data-video-id="${video.videoId}"
                ${isChecked ? 'checked' : ''}
                onclick="toggleVideoSelection('${video.videoId}', event)">
              <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}">
              ${isHot ? '<div class="video-badge">ğŸ”¥ çˆ†æ¬¾</div>' : ''}
            </div>
            <div class="video-info">
              <div class="video-title">${escapeHtml(video.title)}</div>
              <div class="channel-info">
                <img class="channel-avatar" src="${video.channelAvatar}" alt="${escapeHtml(video.channelTitle)}">
                <div class="channel-details">
                  <div class="channel-name">${escapeHtml(video.channelTitle)}</div>
                  <div class="channel-stats">
                    ${formatNumber(video.subscriberCount)} è®¢é˜… Â· ${video.videoCount} è§†é¢‘
                  </div>
                </div>
              </div>
              <div class="video-stats">
                <div class="stat-item">ğŸ‘ï¸ ${formatNumber(video.viewCount)}</div>
                <div class="stat-item">ğŸ‘ ${formatNumber(video.likeCount)}</div>
                <div class="stat-item">ğŸ’¬ ${formatNumber(video.commentCount)}</div>
              </div>
              <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                <span class="tag">${video.country}</span>
                ${isHot ? '<span class="tag hot">ä½ç²‰çˆ†æ¬¾</span>' : ''}
                ${video.matchedTags && video.matchedTags.length > 0 ? 
                  (() => {
                    const visibleTags = video.matchedTags.slice(0, 3);
                    const remainingCount = video.matchedTags.length - 3;
                    let html = visibleTags.map(tag => 
                      `<span class="tag" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);" title="åŒ¹é…æ ‡ç­¾: ${escapeHtml(tag)}">
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="display: inline-block; vertical-align: middle; margin-right: 3px;">
                          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                          <line x1="7" y1="7" x2="7.01" y2="7"></line>
                        </svg>${escapeHtml(tag)}
                      </span>`
                    ).join('');
                    if (remainingCount > 0) {
                      html += `<span class="tag" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.4); font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; box-shadow: 0 1px 3px rgba(139, 92, 246, 0.2);" title="è¿˜æœ‰${remainingCount}ä¸ªæ ‡ç­¾">+${remainingCount}</span>`;
                    }
                    return html;
                  })()
                  : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function updateStats() {
      document.getElementById('statsSection').style.display = 'grid';
      document.getElementById('totalVideos').textContent = filteredVideos.length;
      
      const uniqueChannels = new Set(filteredVideos.map(v => v.channelId));
      document.getElementById('totalChannels').textContent = uniqueChannels.size;
      
      const avgViews = filteredVideos.reduce((sum, v) => sum + v.viewCount, 0) / filteredVideos.length;
      document.getElementById('avgViews').textContent = formatNumber(Math.round(avgViews));
      
      const hotVideos = filteredVideos.filter(v => v.viewCount > v.subscriberCount * 2);
      document.getElementById('hotVideos').textContent = hotVideos.length;
      
      // æ›´æ–°æ ‡ç­¾ç»Ÿè®¡
      updateTagStats();
    }
    
    // æ›´æ–°æ ‡ç­¾ç»Ÿè®¡ä¿¡æ¯
    function updateTagStats() {
      const tagStatsCard = document.getElementById('tagStatsCard');
      const tagStatsPreview = document.getElementById('tagStatsPreview');
      const tagStatsDetail = document.getElementById('tagStatsDetail');
      
      if (Object.keys(tagStats).length === 0 || currentSearchTags.length === 0) {
        tagStatsCard.style.display = 'none';
        return;
      }
      
      tagStatsCard.style.display = 'block';
      
      // é¢„è§ˆï¼šæ˜¾ç¤ºå‰3ä¸ªæ ‡ç­¾ç»Ÿè®¡
      const sortedTags = Object.entries(tagStats).sort((a, b) => b[1] - a[1]);
      const previewTags = sortedTags.slice(0, 3);
      tagStatsPreview.textContent = previewTags.map(([tag, count]) => `${tag}: ${count}ä¸ª`).join(' | ');
      if (sortedTags.length > 3) {
        tagStatsPreview.textContent += ` | +${sortedTags.length - 3}ä¸ªæ ‡ç­¾...`;
      }
      
      // è¯¦ç»†åˆ—è¡¨
      tagStatsDetail.innerHTML = sortedTags.map(([tag, count]) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #2a2a33;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); color: #93c5fd; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid rgba(59, 130, 246, 0.4); box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);">
              ${escapeHtml(tag)}
            </span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="color: #a7adb8; font-size: 13px;">${count} ä¸ªè§†é¢‘</span>
            <div style="width: 100px; height: 6px; background: #2a2a33; border-radius: 3px; overflow: hidden;">
              <div style="height: 100%; background: linear-gradient(90deg, var(--p5r-yellow), #7ef29a); width: ${Math.min(100, (count / Math.max(...sortedTags.map(t => t[1]))) * 100)}%;"></div>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // åˆ‡æ¢æ ‡ç­¾ç»Ÿè®¡è¯¦æƒ…æ˜¾ç¤º
    function toggleTagStats() {
      const detail = document.getElementById('tagStatsDetail');
      const toggle = document.getElementById('tagStatsToggle');
      
      if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = 'â–²';
      } else {
        detail.style.display = 'none';
        toggle.textContent = 'â–¼';
      }
    }
    
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }
    
    function clearData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—?')) {
        allVideos = [];
        filteredVideos = [];
        selectedVideos.clear();
        currentSearchTags = [];
        tagStats = {};
        document.getElementById('resultsDiv').innerHTML = '';
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('channelLinksSection').style.display = 'none';
        updateSelectionToolbar();
        
        // æ¸…ç©ºç¼“å­˜
        clearSearchCache();
        
        showMessage('æ•°æ®å·²æ¸…ç©º', 'success');
      }
    }
    
    function toggleVideoSelection(videoId, event) {
      event.stopPropagation();
      
      if (selectedVideos.has(videoId)) {
        selectedVideos.delete(videoId);
      } else {
        selectedVideos.add(videoId);
      }
      
      updateSelectionToolbar();
      if (selectionMode) {
        displayVideos();
      }
    }
    
    function openVideo(videoId, event) {
      // é€‰æ‹©æ¨¡å¼ä¸‹ï¼Œå¡ç‰‡ç‚¹å‡»ç”¨äºé€‰æ‹©ï¼Œä¸è·³è½¬
      if (event.target && event.target.type === 'checkbox') return;
      if (selectionMode) {
        toggleVideoSelection(videoId, event);
        return;
      }
      window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
    }
    
    function updateSelectionToolbar() {
      const toolbar = document.getElementById('selectionToolbar');
      const info = document.getElementById('selectionInfo');
      
      if (selectionMode || selectedVideos.size > 0) {
        toolbar.style.display = 'flex';
        info.textContent = `å·²é€‰æ‹© ${selectedVideos.size} ä¸ªè§†é¢‘${selectionMode ? 'ï¼ˆé€‰æ‹©æ¨¡å¼ï¼‰' : ''}`;
      } else {
        toolbar.style.display = 'none';
        info.textContent = 'å·²é€‰æ‹© 0 ä¸ªè§†é¢‘';
      }
    }
    
    function clearSelection() {
      selectedVideos.clear();
      updateSelectionToolbar();
      displayVideos();
      document.getElementById('channelLinksSection').style.display = 'none';
    }
    
    function toggleSelectionMode(force) {
      if (typeof force === 'boolean') {
        selectionMode = force;
      } else {
        selectionMode = !selectionMode;
      }
      document.body.classList.toggle('select-mode', selectionMode);
      const btn = document.getElementById('selectionModeBtn');
      if (btn) {
        btn.textContent = selectionMode ? 'âœ… é€€å‡ºé€‰æ‹©æ¨¡å¼' : 'ğŸ§° è¿›å…¥é€‰æ‹©æ¨¡å¼';
      }
      updateSelectionToolbar();
      displayVideos();
    }

    function selectAllVisible() {
      filteredVideos.forEach(v => selectedVideos.add(v.videoId));
      updateSelectionToolbar();
      displayVideos();
    }
    
    function getSelectedChannels() {
      if (selectedVideos.size === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è§†é¢‘', 'error');
        return;
      }
      
      // è·å–é€‰ä¸­è§†é¢‘å¯¹åº”çš„åšä¸»ä¿¡æ¯
      const selectedVideosList = Array.from(selectedVideos);
      const channelsMap = new Map();
      
      filteredVideos.forEach(video => {
        if (selectedVideosList.includes(video.videoId)) {
          if (!channelsMap.has(video.channelId)) {
            channelsMap.set(video.channelId, {
              channelId: video.channelId,
              channelTitle: video.channelTitle,
              channelUrl: `https://www.youtube.com/channel/${video.channelId}`,
              subscriberCount: video.subscriberCount,
              videoCount: video.videoCount
            });
          }
        }
      });
      
      displayChannelLinks(Array.from(channelsMap.values()));
    }
    
    function displayChannelLinks(channels) {
      const linksSection = document.getElementById('channelLinksSection');
      const linksList = document.getElementById('channelLinksList');
      
      if (channels.length === 0) {
        showMessage('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„åšä¸»', 'error');
        return;
      }
      
      linksList.innerHTML = channels.map(channel => `
        <div class="channel-link-item">
          <div class="channel-link-info">
            <div class="channel-link-name">${escapeHtml(channel.channelTitle)}</div>
            <div class="channel-link-url">${escapeHtml(channel.channelUrl)}</div>
            <div class="channel-stats" style="font-size: 12px; color: #6c757d; margin-top: 5px;">
              ${formatNumber(channel.subscriberCount)} è®¢é˜… Â· ${channel.videoCount} è§†é¢‘
            </div>
          </div>
          <button class="btn-copy" onclick="copyLink('${channel.channelUrl}')">å¤åˆ¶</button>
        </div>
      `).join('');
      
      linksSection.style.display = 'block';
      
      // æ»šåŠ¨åˆ°é“¾æ¥åŒºåŸŸ
      linksSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      showMessage(`å·²è·å– ${channels.length} ä¸ªåšä¸»é“¾æ¥`, 'success');
    }
    
    // æ”¹è¿›çš„å¤åˆ¶åŠŸèƒ½ï¼Œæ”¯æŒç§»åŠ¨ç«¯
    function copyToClipboard(text) {
      // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      
      // Fallback: ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•ï¼ˆå…¼å®¹ç§»åŠ¨ç«¯ï¼‰
      return new Promise((resolve, reject) => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        textArea.style.top = '0';
        document.body.appendChild(textArea);
        
        // ç§»åŠ¨ç«¯éœ€è¦ç‰¹æ®Šå¤„ç†
        if (navigator.userAgent.match(/ipad|iphone/i)) {
          const range = document.createRange();
          range.selectNodeContents(textArea);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          textArea.setSelectionRange(0, 999999);
        } else {
          textArea.select();
        }
        
        try {
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          if (successful) {
            resolve();
          } else {
            reject(new Error('å¤åˆ¶å‘½ä»¤æ‰§è¡Œå¤±è´¥'));
          }
        } catch (err) {
          document.body.removeChild(textArea);
          reject(err);
        }
      });
    }
    
    function copyLink(url) {
      copyToClipboard(url).then(() => {
        showMessage('âœ… é“¾æ¥å·²å¤åˆ¶', 'success');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      });
    }
    
    function copyAllLinks() {
      const linkItems = document.querySelectorAll('.channel-link-url');
      if (linkItems.length === 0) {
        showMessage('âŒ æ²¡æœ‰å¯å¤åˆ¶çš„é“¾æ¥', 'error');
        return;
      }
      
      const allLinks = Array.from(linkItems).map(item => item.textContent).join('\n');
      
      copyToClipboard(allLinks).then(() => {
        showMessage(`âœ… å·²å¤åˆ¶ ${linkItems.length} ä¸ªé“¾æ¥`, 'success');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showMessage('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      });
    }
    
    // ç§»åŠ¨ç«¯å¯¼èˆªèœå•åˆ‡æ¢
    (function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const navMenu = document.querySelector('.nav-menu');
      
      if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          navMenu.classList.toggle('show');
          mobileMenuBtn.setAttribute('aria-expanded', navMenu.classList.contains('show') ? 'true' : 'false');
        });
        
        // ç‚¹å‡»å¯¼èˆªé“¾æ¥åå…³é—­èœå•
        const navLinks = navMenu.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            navMenu.classList.remove('show');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
          });
        });
      }
    })();
  </script>
</body>
</html>
