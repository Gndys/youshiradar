<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåˆ†æåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .result { margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .error { background: #ffeaea; color: #d32f2f; }
        button { padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1565c0; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AIåˆ†æåŠŸèƒ½æµ‹è¯•</h1>
        <p>æµ‹è¯•Deepseek AIåˆ†æåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <div class="test-section">
            <h3>æµ‹è¯•AIåˆ†æåŠŸèƒ½</h3>
            <button onclick="testAIAnalysis()">å¼€å§‹æµ‹è¯•</button>
            <div id="testResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>æµ‹è¯•æ¨é€åŠŸèƒ½</h3>
            <button onclick="testPushFunction()">æµ‹è¯•æ¨é€</button>
            <div id="pushResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Deepseek AI é…ç½®
        const DEEPSEEK_CONFIG = {
            apiUrl: 'https://api.apimart.ai/v1',
            model: 'gpt-5-nano',
            apiKey: 'sk-bhvcYeZB2dwxwsvjD69xc6xiSHgzqxLRciaftZUt4YXQVO7y'
        };

        // PushPlus é…ç½®
        const PUSH_CONFIG = {
            token: 'bbd33b528a124566abc86b381e150c4e',
            apiUrl: 'https://www.pushplus.plus/api/send'
        };

        // æ¨¡æ‹Ÿè§†é¢‘æ•°æ®
        const mockVideoData = [
            {
                title: "AI Revolution 2024 - äººå·¥æ™ºèƒ½å¦‚ä½•æ”¹å˜ä¸–ç•Œ",
                viewCount: 1500000,
                likeCount: 45000,
                commentCount: 3200,
                channelTitle: "TechVision",
                subscriberCount: 250000,
                isHot: true
            },
            {
                title: "ChatGPT vs Claude - æœ€å¼ºAIåŠ©æ‰‹å¯¹æ¯”æµ‹è¯•",
                viewCount: 890000,
                likeCount: 28000,
                commentCount: 2100,
                channelTitle: "AIå®éªŒå®¤",
                subscriberCount: 180000,
                isHot: true
            },
            {
                title: "æœºå™¨å­¦ä¹ å…¥é—¨æ•™ç¨‹ - ä»é›¶å¼€å§‹å­¦AI",
                viewCount: 650000,
                likeCount: 19000,
                commentCount: 1500,
                channelTitle: "ç¼–ç¨‹å­¦é™¢",
                subscriberCount: 320000,
                isHot: false
            }
        ];

        // æµ‹è¯•AIåˆ†æåŠŸèƒ½ï¼ˆå¸¦è¶…æ—¶æœºåˆ¶ï¼‰
        async function testAIAnalysis() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆAIåˆ†æï¼ˆ15ç§’è¶…æ—¶ï¼‰...</div>';

            try {
                const searchTags = ['AI', 'äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ '];
                const videoStats = {
                    totalVideos: 25,
                    totalChannels: 18,
                    avgViews: '580K',
                    hotVideos: 8
                };

                // ä½¿ç”¨å¸¦è¶…æ—¶çš„AIåˆ†æ
                const aiAnalysis = await generateAIAnalysisWithTimeout(mockVideoData, searchTags, videoStats, 15000);
                
                if (aiAnalysis) {
                    resultDiv.innerHTML = `âœ… AIåˆ†æç”ŸæˆæˆåŠŸï¼\n\n${aiAnalysis}`;
                } else {
                    resultDiv.innerHTML = 'âš ï¸ AIåˆ†æç”Ÿæˆå¤±è´¥æˆ–è¶…æ—¶ï¼Œä½†è¿™ä¸å½±å“æ­£å¸¸ä½¿ç”¨';
                    resultDiv.style.background = '#fff3cd';
                    resultDiv.style.color = '#856404';
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.classList.add('error');
                console.error('AIåˆ†ææµ‹è¯•å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•æ¨é€åŠŸèƒ½ï¼ˆå¼‚æ­¥æ¨é€ç­–ç•¥ï¼‰
        async function testPushFunction() {
            const resultDiv = document.getElementById('pushResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨å®æ–½å¼‚æ­¥æ¨é€ç­–ç•¥...</div>';

            try {
                const searchTags = ['AIæµ‹è¯•'];
                const videoStats = {
                    totalVideos: 3,
                    totalChannels: 3,
                    avgViews: '1M',
                    hotVideos: 2
                };

                // ç«‹å³å‘é€åŸºç¡€æ¨é€ï¼ˆä¸å«AIåˆ†æï¼‰
                const baseTitle = `æ¨é€åŠŸèƒ½æµ‹è¯•`;
                const baseContent = generateTestPushContent(searchTags, videoStats, mockVideoData, null);
                
                console.log('ğŸ“¤ å‘é€åŸºç¡€æ¨é€ï¼ˆä¸å«AIåˆ†æï¼‰...');
                const basePushPromise = sendWeChatPush(baseTitle, baseContent);
                
                // åŒæ—¶å¯åŠ¨AIåˆ†æï¼ˆå¸¦è¶…æ—¶ï¼‰
                const aiAnalysisPromise = generateAIAnalysisWithTimeout(mockVideoData, searchTags, videoStats, 10000);
                
                // ç­‰å¾…åŸºç¡€æ¨é€ç»“æœ
                const baseSuccess = await basePushPromise;
                
                if (baseSuccess) {
                    resultDiv.innerHTML = 'âœ… åŸºç¡€æ¨é€å‘é€æˆåŠŸï¼æ­£åœ¨ç”ŸæˆAIåˆ†æ...';
                    
                    // ç­‰å¾…AIåˆ†æç»“æœ
                    const aiAnalysis = await aiAnalysisPromise;
                    
                    if (aiAnalysis) {
                        console.log('ğŸ“¤ AIåˆ†ææˆåŠŸï¼Œå‘é€å¢å¼ºç‰ˆæ¨é€...');
                        const enhancedTitle = `ğŸ¤– AIæµ‹è¯•ï¼šæ¨é€åŠŸèƒ½æµ‹è¯•`;
                        const enhancedContent = generateTestPushContent(searchTags, videoStats, mockVideoData, aiAnalysis);
                        
                        // å¼‚æ­¥å‘é€å¢å¼ºç‰ˆæ¨é€ï¼Œä¸ç­‰å¾…ç»“æœ
                        sendWeChatPush(enhancedTitle, enhancedContent).then(success => {
                            if (success) {
                                console.log('âœ… AIå¢å¼ºç‰ˆæ¨é€å‘é€æˆåŠŸ');
                                resultDiv.innerHTML = 'âœ… åŸºç¡€æ¨é€å’ŒAIæ´å¯ŸæŠ¥å‘Šéƒ½å·²å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥å¾®ä¿¡';
                            } else {
                                console.log('âš ï¸ AIå¢å¼ºç‰ˆæ¨é€å‘é€å¤±è´¥');
                                resultDiv.innerHTML = 'âœ… åŸºç¡€æ¨é€å‘é€æˆåŠŸï¼ŒAIæ´å¯ŸæŠ¥å‘Šå‘é€å¤±è´¥';
                            }
                        });
                    } else {
                        console.log('âš ï¸ AIåˆ†æè¶…æ—¶æˆ–å¤±è´¥');
                        resultDiv.innerHTML = 'âœ… åŸºç¡€æ¨é€å‘é€æˆåŠŸï¼ˆAIåˆ†æè¶…æ—¶ï¼‰';
                    }
                } else {
                    resultDiv.innerHTML = 'âŒ åŸºç¡€æ¨é€å‘é€å¤±è´¥';
                    resultDiv.classList.add('error');
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ¨é€æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.classList.add('error');
                console.error('æ¨é€æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæµ‹è¯•æ¨é€å†…å®¹
        function generateTestPushContent(searchTags, videoStats, topVideos, aiAnalysis = null) {
            const now = new Date().toLocaleString('zh-CN');
            let content = `
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="text-align: center; margin-bottom: 12px;">
                        <h3 style="color: #1e293b; margin: 0; font-size: 16px; font-weight: 600;">ğŸ¯ æµ‹è¯•æ¨é€</h3>
                        <p style="color: #64748b; margin: 4px 0 0 0; font-size: 11px;">${now}</p>
                    </div>
            `;

            // æœç´¢æ ‡ç­¾ä¿¡æ¯
            if (searchTags && searchTags.length > 0) {
                content += `
                    <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                        <div style="color: #3b82f6; font-size: 12px; font-weight: 600; margin-bottom: 4px;">ğŸ” æœç´¢æ ‡ç­¾</div>
                        <div style="color: #475569; font-size: 11px; line-height: 1.4;">${searchTags.join(' â€¢ ')}</div>
                    </div>
                `;
            }

            // ç»Ÿè®¡ä¿¡æ¯
            if (videoStats) {
                content += `
                    <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #e2e8f0;">
                        <div style="color: #3b82f6; font-size: 12px; font-weight: 600; margin-bottom: 6px;">ğŸ“Š åˆ†æç»Ÿè®¡</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div style="color: #475569;">è§†é¢‘: <strong style="color: #1e293b;">${videoStats.totalVideos}</strong></div>
                            <div style="color: #475569;">é¢‘é“: <strong style="color: #1e293b;">${videoStats.totalChannels}</strong></div>
                            <div style="color: #475569;">å‡æ’­: <strong style="color: #1e293b;">${videoStats.avgViews}</strong></div>
                            <div style="color: #475569;">çˆ†æ¬¾: <strong style="color: #ef4444;">${videoStats.hotVideos}</strong></div>
                        </div>
                    </div>
                `;
            }

            // çƒ­é—¨è§†é¢‘
            if (topVideos && topVideos.length > 0) {
                content += `
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0;">
                        <div style="color: #3b82f6; font-size: 12px; font-weight: 600; margin-bottom: 6px;">ğŸ”¥ çƒ­é—¨è§†é¢‘</div>
                `;

                topVideos.slice(0, 3).forEach((video, index) => {
                    const isHot = video.viewCount > video.subscriberCount * 2;
                    const medalColor = index === 0 ? '#fbbf24' : index === 1 ? '#d1d5db' : '#f59e0b';

                    content += `
                        <div style="display: flex; align-items: flex-start; padding: 6px 0; border-bottom: 1px solid #f1f5f9; ${index === Math.min(3, topVideos.length) - 1 ? 'border-bottom: none;' : ''}">
                            <div style="background: ${medalColor}; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 8px; flex-shrink: 0;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: #1e293b; font-size: 11px; font-weight: 500; margin-bottom: 2px; line-height: 1.3;">${video.title}</div>
                                <div style="color: #64748b; font-size: 10px; margin-bottom: 2px;">${video.channelTitle}</div>
                                <div style="color: #64748b; font-size: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                                    <span>ğŸ‘ï¸ ${formatNumber(video.viewCount)}</span>
                                    <span>ğŸ‘ ${formatNumber(video.likeCount)}</span>
                                    <span>ğŸ’¬ ${formatNumber(video.commentCount)}</span>
                                    ${isHot ? '<span style="color: #ef4444; font-weight: 500;">ğŸ”¥</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                content += '</div>';
            }

            // æ·»åŠ AIåˆ†æå’Œé¢„æµ‹
            if (aiAnalysis) {
                content += `
                    <div style="background: white; padding: 12px; border-radius: 4px; margin-top: 8px; border: 1px solid #e2e8f0;">
                        <div style="color: #8b5cf6; font-size: 12px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 6px;">ğŸ¤–</span>
                            AIæ´å¯Ÿåˆ†æ
                        </div>
                        <div style="color: #475569; font-size: 11px; line-height: 1.5; white-space: pre-line;">${aiAnalysis}</div>
                    </div>
                `;
            }

            content += '</div>';
            return content;
        }

        // å‘é€å¾®ä¿¡æ¨é€æ¶ˆæ¯
        async function sendWeChatPush(title, content) {
            const PUSHPLUS_TOKEN = PUSH_CONFIG.token;
            const PUSHPLUS_API = PUSH_CONFIG.apiUrl;

            console.log(`ğŸ“¤ å¼€å§‹å‘é€å¾®ä¿¡æ¨é€...`);
            console.log(`ğŸ“‹ æ¨é€æ ‡é¢˜: ${title}`);
            console.log(`ğŸ“Š å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);

            try {
                const requestBody = {
                    token: PUSHPLUS_TOKEN,
                    title: title,
                    content: content,
                    template: 'html'
                };

                const response = await fetch(PUSHPLUS_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    console.error(`âŒ HTTP é”™è¯¯: ${response.status} ${response.statusText}`);
                    return false;
                }

                const result = await response.json();

                if (result.code === 200) {
                    console.log('âœ… å¾®ä¿¡æ¨é€å‘é€æˆåŠŸ');
                    return true;
                } else {
                    console.error('âŒ å¾®ä¿¡æ¨é€å‘é€å¤±è´¥:', result.msg || result.message || 'æœªçŸ¥é”™è¯¯');
                    return false;
                }
            } catch (error) {
                console.error('âŒ å¾®ä¿¡æ¨é€è¯·æ±‚å¤±è´¥:', error);
                return false;
            }
        }

        // ç”ŸæˆAIåˆ†æï¼ˆå¤åˆ¶è‡ªä¸»æ–‡ä»¶ï¼‰
        async function generateAIAnalysis(topVideos, searchTags, videoStats) {
            console.log('ğŸ¤– å¼€å§‹ç”ŸæˆAIåˆ†æå’Œé¢„æµ‹...');
            
            try {
                // å‡†å¤‡AIåˆ†æçš„æç¤ºè¯
                const videoData = topVideos.map((video, index) => ({
                    rank: index + 1,
                    title: video.title,
                    viewCount: video.viewCount,
                    likeCount: video.likeCount,
                    commentCount: video.commentCount,
                    channelTitle: video.channelTitle,
                    subscriberCount: video.subscriberCount,
                    isHot: video.viewCount > video.subscriberCount * 2
                }));

                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„YouTubeå†…å®¹åˆ†æä¸“å®¶ï¼Œæ“…é•¿åˆ†æè§†é¢‘æ•°æ®å’Œè¶‹åŠ¿é¢„æµ‹ã€‚è¯·åŸºäºæä¾›çš„æ•°æ®ç»™å‡ºæ·±å…¥çš„åˆ†æå’Œé¢„æµ‹ã€‚`;

                const userPrompt = `è¯·åˆ†æä»¥ä¸‹YouTubeè§†é¢‘æ•°æ®ï¼Œå¹¶æä¾›ä¸“ä¸šçš„æ´å¯Ÿå’Œé¢„æµ‹ï¼š

æœç´¢æ ‡ç­¾ï¼š${searchTags.join(', ')}

æ•´ä½“ç»Ÿè®¡ï¼š
- æ€»è§†é¢‘æ•°ï¼š${videoStats.totalVideos}
- é¢‘é“æ•°ï¼š${videoStats.totalChannels}
- å¹³å‡è§‚çœ‹ï¼š${videoStats.avgViews}
- çˆ†æ¬¾è§†é¢‘ï¼š${videoStats.hotVideos}

è§‚çœ‹æ•°æœ€é«˜çš„10ä¸ªè§†é¢‘æ•°æ®ï¼š
${JSON.stringify(videoData, null, 2)}

è¯·æä¾›ä»¥ä¸‹åˆ†æï¼š
1. å†…å®¹è¶‹åŠ¿åˆ†æï¼ˆè¿™äº›è§†é¢‘æœ‰ä»€ä¹ˆå…±åŒç‰¹ç‚¹ï¼‰
2. æˆåŠŸå› ç´ æ€»ç»“ï¼ˆä¸ºä»€ä¹ˆè¿™äº›è§†é¢‘èƒ½è·å¾—é«˜è§‚çœ‹ï¼‰
3. åˆ›ä½œå»ºè®®ï¼ˆåŸºäºè¿™äº›æ•°æ®ï¼Œç»™å†…å®¹åˆ›ä½œè€…çš„å»ºè®®ï¼‰
4. æœªæ¥é¢„æµ‹ï¼ˆé¢„æµ‹è¿™ç±»å†…å®¹çš„å‘å±•è¶‹åŠ¿ï¼‰
5. æœºä¼šæ´å¯Ÿï¼ˆæŒ‡å‡ºæ½œåœ¨çš„å†…å®¹æœºä¼šï¼‰

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œè¯­è¨€è¦ä¸“ä¸šä½†æ˜“æ‡‚ï¼Œç»“æ„æ¸…æ™°ï¼Œæ¯æ¡å»ºè®®éƒ½è¦å…·ä½“å®ç”¨ã€‚`;

                const requestBody = {
                    model: DEEPSEEK_CONFIG.model,
                    messages: [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: userPrompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                };

                console.log('ğŸš€ è°ƒç”¨Deepseek AI API...');
                
                const response = await fetch(`${DEEPSEEK_CONFIG.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    console.error(`âŒ Deepseek API é”™è¯¯: ${response.status} ${response.statusText}`);
                    return null;
                }

                const result = await response.json();
                
                if (result.choices && result.choices[0] && result.choices[0].message) {
                    const aiAnalysis = result.choices[0].message.content;
                    console.log('âœ… AIåˆ†æç”ŸæˆæˆåŠŸ');
                    console.log('ğŸ“ AIåˆ†æå†…å®¹:', aiAnalysis);
                    return aiAnalysis;
                } else {
                    console.error('âŒ AIåˆ†æç»“æœæ ¼å¼é”™è¯¯');
                    return null;
                }
            } catch (error) {
                console.error('âŒ AIåˆ†æç”Ÿæˆå¤±è´¥:', error);
                return null;
            }
        }

        // æ•°å­—æ ¼å¼åŒ–
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
    </script>
</body>
</html>