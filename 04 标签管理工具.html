<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‡ç­¾ç®¡ç†å·¥å…· - PHANTOM RADAR</title>
  <link rel="stylesheet" href="youtube-tools-p5-refined.css">
  <style>
    /* ========== å…¨å±€åŠ¨ç”»å…³é”®å¸§ ========== */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.6;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    /* ========== åŒæ å¸ƒå±€ ========== */
    .main-layout {
      display: flex;
      height: calc(100vh - 80px);
      background: var(--bg-secondary);
    }

    /* å·¦ä¾§åˆ†ç±»å¯¼èˆª */
    .category-sidebar {
      width: 240px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-primary);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .category-header {
      padding: var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .category-header h3 {
      margin: 0 0 var(--space-3) 0;
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
    }

    .category-list {
      flex: 1;
      overflow-y: auto;
    }

    .category-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      transition: all var(--transition-base);
      border-left: 3px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .category-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--primary-100), transparent);
      transition: width var(--transition-base);
      z-index: 0;
    }

    .category-item:hover::before {
      width: 100%;
    }

    .category-item:hover {
      background: var(--bg-secondary);
      transform: translateX(2px);
    }

    .category-item.active {
      background: linear-gradient(90deg, var(--primary-50), var(--bg-primary));
      border-left-color: var(--primary-600);
      font-weight: var(--font-semibold);
      box-shadow: inset 0 0 0 1px var(--primary-200);
    }

    .category-item > * {
      position: relative;
      z-index: 1;
    }

    .category-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .category-name {
      flex: 1;
      font-size: var(--text-sm);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .category-count {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      background: var(--gray-100);
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
      font-weight: var(--font-medium);
    }

    .category-item.active .category-count {
      background: var(--primary-100);
      color: var(--primary-700);
    }

    /* å³ä¾§å†…å®¹åŒº */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-toolbar {
      background: var(--bg-primary);
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .toolbar-left {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
      flex: 1;
    }

    .toolbar-right {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .view-switcher {
      display: flex;
      gap: 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
      border: 1px solid var(--border-primary);
    }

    .view-btn {
      padding: var(--space-2) var(--space-4);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .view-btn:hover {
      color: var(--text-primary);
    }

    .view-btn.active {
      background: var(--primary-500);
      color: white;
    }

    .search-box {
      min-width: 200px;
      flex: 1;
      max-width: 400px;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      transition: all var(--transition-base);
      background: var(--bg-primary);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      transform: translateY(-1px);
    }

    .search-box::placeholder {
      color: var(--text-tertiary);
    }

    /* å†…å®¹æ»šåŠ¨åŒº */
    .content-scroll {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
      transition: opacity 0.3s ease-out;
    }

    .content-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .content-scroll::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .content-scroll::-webkit-scrollbar-thumb {
      background: var(--primary-300);
      border-radius: 4px;
    }

    .content-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--primary-500);
    }

    /* ========== æ’è¡Œæ¦œè§†å›¾ ========== */
    .ranking-view {
      max-width: 1200px;
      margin: 0 auto;
    }

    .ranking-header {
      text-align: center;
      margin-bottom: var(--space-8);
    }

    .ranking-header h2 {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin: 0 0 var(--space-2) 0;
    }

    .ranking-header p {
      font-size: var(--text-base);
      color: var(--text-secondary);
      margin: 0;
    }

    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-6);
    }

    .rank-card {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out backwards;
    }

    .rank-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      opacity: 0;
      transition: opacity var(--transition-base);
      z-index: 0;
    }

    .rank-card:hover::before {
      opacity: 0.05;
    }

    .rank-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(139, 92, 246, 0.3), 0 0 0 1px var(--primary-300);
      border-color: var(--primary-400);
    }

    .rank-card > * {
      position: relative;
      z-index: 1;
    }

    .ranking-grid .rank-card:nth-child(1) {
      animation-delay: 0s;
    }

    .ranking-grid .rank-card:nth-child(2) {
      animation-delay: 0.05s;
    }

    .ranking-grid .rank-card:nth-child(3) {
      animation-delay: 0.1s;
    }

    .ranking-grid .rank-card:nth-child(n+4) {
      animation-delay: 0.15s;
    }

    .rank-badge {
      position: absolute;
      top: var(--space-4);
      right: var(--space-4);
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--gray-100);
      color: var(--gray-600);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-base);
      font-weight: var(--font-bold);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: transform var(--transition-base);
    }

    .rank-card:hover .rank-badge {
      transform: scale(1.1) rotate(5deg);
    }

    .rank-card:nth-child(1) .rank-badge {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .rank-card:nth-child(2) .rank-badge {
      background: linear-gradient(135deg, #E8E8E8 0%, #A8A8A8 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(192, 192, 192, 0.4);
    }

    .rank-card:nth-child(3) .rank-badge {
      background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(205, 127, 50, 0.4);
    }

    .rank-tag-name {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--text-primary);
      margin-bottom: var(--space-3);
      padding-right: 48px;
    }

    .rank-stats {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-3);
    }

    .rank-count {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--primary-600);
    }

    .rank-heat {
      font-size: 20px;
    }

    .rank-category {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      background: var(--gray-100);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--text-secondary);
    }

    /* ========== åˆ—è¡¨è§†å›¾ ========== */
    .list-view {
      max-width: 1400px;
      margin: 0 auto;
    }

    .list-table {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      overflow: hidden;
      border: 1px solid var(--border-primary);
    }

    .list-table-header {
      display: grid;
      grid-template-columns: 50px 1fr 120px 120px 150px 80px;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-6);
      background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
      color: white;
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .list-table-body {
      background: var(--bg-primary);
    }

    .list-row {
      display: grid;
      grid-template-columns: 50px 1fr 120px 120px 150px 80px;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-6);
      border-bottom: 1px solid var(--border-primary);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      align-items: center;
      position: relative;
    }

    .list-row:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .list-row::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--primary-500);
      transform: scaleY(0);
      transition: transform var(--transition-base);
    }

    .list-row:hover {
      background: linear-gradient(90deg, var(--primary-50), transparent);
      transform: translateX(2px);
    }

    .list-row:hover::before {
      transform: scaleY(1);
    }

    .list-row.selected {
      background: linear-gradient(90deg, var(--primary-100), var(--primary-50));
      border-left: 4px solid var(--primary-500);
      padding-left: calc(var(--space-6) - 4px);
      box-shadow: inset 0 0 0 1px var(--primary-200);
    }

    .list-row.expanded {
      background: linear-gradient(90deg, var(--primary-50), var(--bg-secondary));
      border-left: 4px solid var(--primary-600);
      padding-left: calc(var(--space-6) - 4px);
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
    }

    .list-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin: 0;
    }

    .list-tag-name {
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .expand-icon {
      font-size: var(--text-sm);
      color: var(--text-tertiary);
      transition: transform var(--transition-fast);
      cursor: pointer;
    }

    .list-row.expanded .expand-icon {
      transform: rotate(90deg);
    }

    .list-count {
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--primary-600);
    }

    .list-heat {
      font-size: 18px;
    }

    .list-category {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .list-actions {
      display: flex;
      gap: var(--space-1);
    }

    .icon-btn-sm {
      padding: var(--space-1);
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 16px;
      transition: all var(--transition-fast);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn-sm:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-500);
    }

    /* å±•å¼€è¯¦æƒ… */
    .list-detail {
      display: none;
      grid-column: 1 / -1;
      padding: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-primary);
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }

    .list-row.expanded + .list-detail {
      display: block;
      padding: var(--space-6);
      max-height: 500px;
      opacity: 1;
      animation: slideInUp 0.3s ease-out;
    }

    .detail-actions {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--border-primary);
    }

    .channel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-3);
      max-height: 300px;
      overflow-y: auto;
    }

    .channel-card {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .channel-card:hover {
      box-shadow: var(--shadow-sm);
    }

    .channel-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 2px solid var(--border-primary);
    }

    .channel-name {
      flex: 1;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: var(--space-16);
      color: var(--text-tertiary);
      animation: fadeIn 0.5s ease-out;
    }

    .empty-state-icon {
      font-size: 80px;
      margin-bottom: var(--space-6);
      opacity: 0.5;
      animation: pulse 3s ease-in-out infinite;
      display: inline-block;
    }

    .empty-state h3 {
      animation: fadeIn 0.6s ease-out 0.2s backwards;
    }

    .empty-state p {
      animation: fadeIn 0.7s ease-out 0.3s backwards;
    }

    .empty-state button {
      animation: fadeIn 0.8s ease-out 0.4s backwards;
    }

    /* æ‰¹é‡æ“ä½œæ  */
    .batch-actions-bar {
      position: fixed;
      bottom: var(--space-6);
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--gray-900) 0%, #1a1a2e 100%);
      color: white;
      padding: var(--space-4) var(--space-6);
      border-radius: var(--radius-2xl);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
      display: none;
      align-items: center;
      gap: var(--space-4);
      z-index: var(--z-fixed);
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .batch-actions-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary-500), transparent);
    }

    .batch-actions-bar.show {
      display: flex;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0) scale(1);
        opacity: 1;
      }
    }

    .batch-info {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
    }

    .batch-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* ========== æ¨¡æ€æ¡† ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: var(--z-modal);
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      margin: 8% auto;
      padding: 0;
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-2xl);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(139, 92, 246, 0.1);
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-60px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-6);
      border-bottom: 1px solid var(--border-primary);
    }

    .modal-header h2 {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      margin: 0;
    }

    .close {
      color: var(--text-tertiary);
      font-size: 32px;
      font-weight: var(--font-bold);
      line-height: 1;
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-6);
    }

    .form-group {
      margin-bottom: var(--space-6);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-sm);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .color-btn {
      width: 44px;
      height: 44px;
      border: 3px solid transparent;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .color-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius-md);
      background: inherit;
      opacity: 0.9;
      transition: opacity var(--transition-base);
    }

    .color-btn:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .color-btn:hover::before {
      opacity: 1;
    }

    .color-btn.selected {
      border-color: var(--gray-900);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--gray-900);
      transform: scale(1.1);
    }

    .color-btn.selected::after {
      content: 'âœ“';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .icon-btn {
      width: 50px;
      height: 50px;
      border: 2px solid var(--border-primary);
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .icon-btn::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: var(--radius-lg);
      padding: 2px;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      opacity: 0;
      transition: opacity var(--transition-base);
    }

    .icon-btn:hover {
      border-color: var(--primary-400);
      background: var(--primary-50);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    .icon-btn:hover::before {
      opacity: 1;
    }

    .icon-btn.selected {
      border-color: var(--primary-600);
      background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
      border-width: 3px;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      transform: scale(1.05);
    }

    /* ========== å“åº”å¼ ========== */
    @media (max-width: 768px) {
      .main-layout {
        flex-direction: column;
        height: auto;
        min-height: calc(100vh - 80px);
      }

      .category-sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 2px solid var(--border-primary);
      }

      .category-list {
        display: flex;
        overflow-x: auto;
        overflow-y: visible;
        padding: var(--space-2);
        gap: var(--space-2);
        -webkit-overflow-scrolling: touch;
      }

      .category-list::-webkit-scrollbar {
        height: 4px;
      }

      .category-list::-webkit-scrollbar-thumb {
        background: var(--primary-300);
        border-radius: 2px;
      }

      .category-item {
        flex-direction: column;
        padding: var(--space-3) var(--space-4);
        text-align: center;
        white-space: nowrap;
        border-left: none;
        border-bottom: 3px solid transparent;
        min-width: 80px;
        border-radius: var(--radius-md);
      }

      .category-item:hover {
        transform: translateY(-2px);
      }

      .category-item.active {
        border-left: none;
        border-bottom-color: var(--primary-600);
        background: var(--primary-100);
      }

      .category-item::before {
        display: none;
      }

      .content-toolbar {
        padding: var(--space-3);
      }

      .toolbar-left {
        width: 100%;
      }

      .search-box {
        max-width: 100%;
      }

      .ranking-grid {
        grid-template-columns: 1fr;
      }

      .list-table-header,
      .list-row {
        grid-template-columns: 40px 1fr 60px 80px;
      }

      .list-table-header div:nth-child(4),
      .list-table-header div:nth-child(5),
      .list-row > div:nth-child(4),
      .list-row > div:nth-child(5) {
        display: none;
      }

      .channel-grid {
        grid-template-columns: 1fr;
      }

      .batch-actions-bar {
        left: var(--space-3);
        right: var(--space-3);
        transform: translateX(0);
        width: auto;
        flex-wrap: wrap;
        bottom: var(--space-4);
        padding: var(--space-3) var(--space-4);
      }

      .batch-actions {
        width: 100%;
        justify-content: center;
      }

      .batch-actions button {
        flex: 1;
        min-width: 0;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-content {
        width: 95%;
        margin: 5% auto;
      }

      .ranking-grid {
        padding: var(--space-4);
      }

      .rank-card {
        padding: var(--space-4);
      }

      .icon-btn {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }

      .color-btn {
        width: 38px;
        height: 38px;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <div class="logo">
        <a href="index.html">PHANTOM RADAR</a>
      </div>
      <div class="nav-menu">
        <ul>
          <li><a href="01 ä½ç²‰çˆ†æ¬¾æŒ–æ˜ .html">çˆ†æ¬¾æŒ–æ˜</a></li>
          <li><a href="02 YouTubeåšä¸»ç®¡ç†å·¥å…·.html">åšä¸»ç®¡ç†</a></li>
          <li><a href="03 è§†é¢‘ç›‘æ§å·¥å…·.html">è§†é¢‘ç›‘æ§</a></li>
          <li><a href="04 æ ‡ç­¾ç®¡ç†å·¥å…·.html" class="active">æ ‡ç­¾ç®¡ç†</a></li>
          <li><a href="APIæ± ç®¡ç†å·¥å…·.html">APIç®¡ç†</a></li>
        </ul>
      </div>
      <button class="mobile-menu-btn" aria-label="æ‰“å¼€ä¸»èœå•" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <div id="messageDiv" class="message" style="display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 1000; min-width: 300px;"></div>
  
  <!-- åŠ è½½åŠ¨ç”» -->
  <div id="loadingOverlay" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 20px;">
    <div style="width: 60px; height: 60px; border: 4px solid rgba(139, 92, 246, 0.2); border-top-color: var(--primary-500); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div style="color: white; font-size: 16px; font-weight: 500;">åŠ è½½ä¸­...</div>
  </div>
  
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- åŒæ å¸ƒå±€ -->
  <div class="main-layout">
    <!-- å·¦ä¾§åˆ†ç±»å¯¼èˆª -->
    <div class="category-sidebar">
      <div class="category-header">
        <h3>ğŸ“ æ ‡ç­¾åˆ†ç±»</h3>
        <button class="btn btn-sm btn-primary" onclick="openCategoryModal()" style="width: 100%;">
          â• æ–°å»ºåˆ†ç±»
        </button>
      </div>
      <div class="category-list" id="categoryList">
        <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±»åˆ—è¡¨ -->
      </div>
    </div>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="content-area">
      <!-- å·¥å…·æ  -->
      <div class="content-toolbar">
        <div class="toolbar-left">
          <input 
            type="text" 
            id="searchInput" 
            class="search-box"
            placeholder="ğŸ” æœç´¢æ ‡ç­¾..." 
            oninput="debouncedFilter()"
          >
          <select id="sortSelect" onchange="sortTags()">
            <option value="count-desc">ä½¿ç”¨æ¬¡æ•°â†“</option>
            <option value="count-asc">ä½¿ç”¨æ¬¡æ•°â†‘</option>
            <option value="name-asc">åç§° A-Z</option>
            <option value="name-desc">åç§° Z-A</option>
          </select>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-sm btn-secondary" onclick="exportTags()">ğŸ“¤ å¯¼å‡º</button>
          <button class="btn btn-sm btn-secondary" onclick="syncFromChannels()">ğŸ”„ åŒæ­¥</button>
          <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('ranking')" data-view="ranking">
              ğŸ“Š æ’è¡Œæ¦œ
            </button>
            <button class="view-btn" onclick="switchView('list')" data-view="list">
              ğŸ“‹ åˆ—è¡¨
            </button>
          </div>
        </div>
      </div>

      <!-- å†…å®¹æ»šåŠ¨åŒº -->
      <div class="content-scroll">
        <!-- æ’è¡Œæ¦œè§†å›¾ -->
        <div id="rankingView" class="ranking-view">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- åˆ—è¡¨è§†å›¾ -->
        <div id="listView" class="list-view" style="display: none;">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <div id="batchActionsBar" class="batch-actions-bar">
    <div class="batch-info">
      å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªæ ‡ç­¾
    </div>
    <div class="batch-actions">
      <button class="btn btn-sm btn-primary" onclick="openBatchEditModal()">âœï¸ æ‰¹é‡ç¼–è¾‘</button>
      <button class="btn btn-sm btn-warning" onclick="batchMergeTags()">ğŸ”— åˆå¹¶</button>
      <button class="btn btn-sm btn-danger" onclick="batchDeleteTags()">ğŸ—‘ï¸ åˆ é™¤</button>
      <button class="btn btn-sm btn-secondary" onclick="deselectAll()">âœ• å–æ¶ˆ</button>
    </div>
  </div>

  <!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="categoryModalTitle">â• æ–°å»ºåˆ†ç±»</h2>
        <span class="close" onclick="closeCategoryModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>åˆ†ç±»åç§°*</label>
          <input type="text" id="categoryNameInput" placeholder="ä¾‹å¦‚ï¼šåŠ¨ç‰©ç±»ã€æƒ…æ„Ÿç±»...">
        </div>
        <div class="form-group">
          <label>å›¾æ ‡*</label>
          <div id="iconPicker" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--space-2); padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;">
            <!-- å›¾æ ‡é€‰æ‹©å™¨ -->
          </div>
          <input type="hidden" id="categoryIconInput" value="ğŸ“">
        </div>
        <div class="form-group">
          <label>é¢œè‰²*</label>
          <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--space-2);">
            <button class="color-btn" data-color="#8B5CF6" style="background: #8B5CF6;" onclick="selectColor('#8B5CF6')"></button>
            <button class="color-btn" data-color="#EC4899" style="background: #EC4899;" onclick="selectColor('#EC4899')"></button>
            <button class="color-btn" data-color="#EF4444" style="background: #EF4444;" onclick="selectColor('#EF4444')"></button>
            <button class="color-btn" data-color="#F59E0B" style="background: #F59E0B;" onclick="selectColor('#F59E0B')"></button>
            <button class="color-btn" data-color="#10B981" style="background: #10B981;" onclick="selectColor('#10B981')"></button>
            <button class="color-btn" data-color="#3B82F6" style="background: #3B82F6;" onclick="selectColor('#3B82F6')"></button>
            <button class="color-btn" data-color="#6366F1" style="background: #6366F1;" onclick="selectColor('#6366F1')"></button>
            <button class="color-btn" data-color="#6B7280" style="background: #6B7280;" onclick="selectColor('#6B7280')"></button>
          </div>
          <input type="hidden" id="categoryColorInput" value="#8B5CF6">
        </div>
        <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6);">
          <button class="btn btn-secondary" onclick="closeCategoryModal()">å–æ¶ˆ</button>
          <button class="btn btn-danger" id="deleteCategoryBtn" onclick="confirmDeleteCategory()" style="display: none;">åˆ é™¤åˆ†ç±»</button>
          <button class="btn btn-primary" onclick="saveCategoryData()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ ‡ç­¾ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="tagEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ ç¼–è¾‘æ ‡ç­¾</h2>
        <span class="close" onclick="closeTagEditModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>æ ‡ç­¾åç§°</label>
          <input type="text" id="tagNameEditInput" readonly style="background: var(--bg-secondary);">
        </div>
        <div class="form-group">
          <label>æ‰€å±åˆ†ç±»</label>
          <select id="tagCategorySelect">
            <option value="">-- æœªåˆ†ç±» --</option>
          </select>
        </div>
        <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="closeTagEditModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveTagEdit()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é‡å‘½åæ ‡ç­¾æ¨¡æ€æ¡† -->
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ é‡å‘½åæ ‡ç­¾</h2>
        <span class="close" onclick="closeRenameModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>å½“å‰åç§°</label>
          <input type="text" id="oldTagNameDisplay" readonly style="background: var(--bg-secondary);">
        </div>
        <div class="form-group">
          <label>æ–°åç§°</label>
          <input type="text" id="newTagNameInput" placeholder="è¾“å…¥æ–°çš„æ ‡ç­¾åç§°...">
        </div>
        <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="closeRenameModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="confirmRename()">ç¡®è®¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆå¹¶æ ‡ç­¾æ¨¡æ€æ¡† -->
  <div id="mergeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ”— åˆå¹¶æ ‡ç­¾</h2>
        <span class="close" onclick="closeMergeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>é€‰ä¸­çš„æ ‡ç­¾</label>
          <div id="selectedTagsList" style="padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md); font-size: var(--text-sm);"></div>
        </div>
        <div class="form-group">
          <label>åˆå¹¶ä¸ºï¼ˆé€‰æ‹©æˆ–è¾“å…¥æ–°æ ‡ç­¾åï¼‰</label>
          <select id="mergeTargetSelect" onchange="onMergeTargetChange()">
            <option value="">-- é€‰æ‹©å·²æœ‰æ ‡ç­¾ --</option>
          </select>
        </div>
        <div class="form-group">
          <label>æˆ–è¾“å…¥æ–°æ ‡ç­¾å</label>
          <input type="text" id="mergeTargetInput" placeholder="è¾“å…¥æ–°çš„æ ‡ç­¾åç§°...">
        </div>
        <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="closeMergeModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="confirmMerge()">ç¡®è®¤åˆå¹¶</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="batchEditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ æ‰¹é‡ç¼–è¾‘æ ‡ç­¾</h2>
        <span class="close" onclick="closeBatchEditModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
          <strong>å·²é€‰æ‹© <span id="batchEditCount">0</span> ä¸ªæ ‡ç­¾</strong>
        </div>
        
        <div class="form-group">
          <label>åˆ†é…åˆ°åˆ†ç±»</label>
          <select id="batchCategorySelect">
            <option value="">-- æœªåˆ†ç±» --</option>
          </select>
        </div>
        
        <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6);">
          <button class="btn btn-secondary" onclick="closeBatchEditModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveBatchEdit()">åº”ç”¨æ›´æ”¹</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let db;
    let channels = [];
    let categories = []; // åˆ†ç±»åˆ—è¡¨ï¼ˆåŸtracksï¼‰
    let tags = {}; // { tagName: { name, count, categoryId, channels[] } }
    let filteredTags = [];
    let selectedTags = new Set();
    let expandedTags = new Set();
    let currentRenameTag = '';
    let currentEditTag = '';
    let currentEditCategory = null;
    let currentView = 'ranking'; // 'ranking' or 'list'
    let currentCategoryFilter = 'all'; // å½“å‰é€‰ä¸­çš„åˆ†ç±»
    let searchDebounceTimer = null;

    // ========== æ•°æ®åº“åˆå§‹åŒ– ==========
    
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('YouTubeToolDB', 5);
        
        request.onerror = () => {
          console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥:', request.error);
          reject(request.error);
        };
        
        request.onsuccess = () => {
          db = request.result;
          console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          if (!db.objectStoreNames.contains('channels')) {
            const channelStore = db.createObjectStore('channels', { keyPath: 'channelId' });
            channelStore.createIndex('addedAt', 'addedAt', { unique: false });
            channelStore.createIndex('name', 'name', { unique: false });
          }
          
          if (!db.objectStoreNames.contains('tracks')) {
            const trackStore = db.createObjectStore('tracks', { keyPath: 'id' });
            trackStore.createIndex('name', 'name', { unique: false });
          }
          
          if (!db.objectStoreNames.contains('tagMetadata')) {
            const tagMetaStore = db.createObjectStore('tagMetadata', { keyPath: 'name' });
            tagMetaStore.createIndex('categoryId', 'categoryId', { unique: false });
          }
        };
      });
    }

    // ========== æ•°æ®åŠ è½½ ==========
    
    async function loadChannels() {
      return new Promise((resolve, reject) => {
        if (!db.objectStoreNames.contains('channels')) {
          channels = [];
          resolve();
          return;
        }
        
        const transaction = db.transaction(['channels'], 'readonly');
        const store = transaction.objectStore('channels');
        const request = store.getAll();
        
        request.onsuccess = () => {
          channels = request.result || [];
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }

    async function loadCategories() {
      return new Promise((resolve, reject) => {
        if (!db.objectStoreNames.contains('tracks')) {
          categories = [];
          resolve();
          return;
        }
        
        const transaction = db.transaction(['tracks'], 'readonly');
        const store = transaction.objectStore('tracks');
        const request = store.getAll();
        
        request.onsuccess = () => {
          categories = request.result || [];
          resolve();
        };
        request.onerror = () => reject(request.error);
      });
    }

    async function loadTagMetadata() {
      return new Promise((resolve, reject) => {
        if (!db.objectStoreNames.contains('tagMetadata')) {
          resolve({});
          return;
        }
        
        const transaction = db.transaction(['tagMetadata'], 'readonly');
        const store = transaction.objectStore('tagMetadata');
        const request = store.getAll();
        
        request.onsuccess = () => {
          const metaArray = request.result || [];
          const metaMap = {};
          metaArray.forEach(meta => {
            metaMap[meta.name] = meta;
          });
          resolve(metaMap);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // ========== æ•°æ®ä¿å­˜ ==========
    
    async function saveChannels() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['channels'], 'readwrite');
        const store = transaction.objectStore('channels');
        
        store.clear();
        for (const channel of channels) {
          store.put(channel);
        }
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    async function saveCategory(category) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tracks'], 'readwrite');
        const store = transaction.objectStore('tracks');
        store.put(category);
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    async function deleteCategory(categoryId) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tracks'], 'readwrite');
        const store = transaction.objectStore('tracks');
        store.delete(categoryId);
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    async function saveTagMetadata(tagName, metadata) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagMetadata'], 'readwrite');
        const store = transaction.objectStore('tagMetadata');
        store.put({ name: tagName, ...metadata });
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    async function deleteTagMetadata(tagName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction(['tagMetadata'], 'readwrite');
        const store = transaction.objectStore('tagMetadata');
        store.delete(tagName);
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    // ========== æ ‡ç­¾æå– ==========
    
    async function extractTags() {
      tags = {};
      
      // ä»channelsæå–æ ‡ç­¾
      channels.forEach(channel => {
        if (channel.tags && channel.tags.trim()) {
          const channelTags = channel.tags.split(',').map(t => t.trim()).filter(t => t);
          
          channelTags.forEach(tag => {
            if (!tags[tag]) {
              tags[tag] = {
                name: tag,
                count: 0,
                categoryId: null,
                channels: []
              };
            }
            tags[tag].count++;
            tags[tag].channels.push(channel);
          });
        }
      });
      
      // åŠ è½½å¹¶åˆå¹¶å…ƒæ•°æ®
      const metadata = await loadTagMetadata();
      Object.keys(tags).forEach(tagName => {
        if (metadata[tagName]) {
          tags[tagName].categoryId = metadata[tagName].categoryId || null;
        }
      });
      
      filteredTags = Object.keys(tags);
    }

    // ========== å·¥å…·å‡½æ•° ==========
    
    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    function getHeatLevel(count) {
      if (count >= 10) return 'ğŸ”¥ğŸ”¥ğŸ”¥';
      if (count >= 5) return 'ğŸ”¥ğŸ”¥';
      if (count >= 1) return 'ğŸ”¥';
      return '';
    }

    function getCategoryById(id) {
      return categories.find(c => c.id === id);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showMessage(message, type, duration = 3000) {
      const messageDiv = document.getElementById('messageDiv');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = message.replace(/\n/g, '<br>');
      messageDiv.style.display = 'block';
      
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, duration);
    }

    // ========== åˆ†ç±»å¯¼èˆª ==========
    
    function renderCategoryNav() {
      const container = document.getElementById('categoryList');
      
      // ç»Ÿè®¡å„åˆ†ç±»çš„æ ‡ç­¾æ•°
      const allCount = Object.keys(tags).length;
      const hotCount = Object.values(tags).filter(t => t.count >= 5).length;
      const uncategorizedCount = Object.values(tags).filter(t => !t.categoryId).length;
      
      let html = `
        <div class="category-item ${currentCategoryFilter === 'all' ? 'active' : ''}" onclick="switchCategory('all')">
          <span class="category-icon">ğŸ“‹</span>
          <span class="category-name">å…¨éƒ¨æ ‡ç­¾</span>
          <span class="category-count">${allCount}</span>
        </div>
        <div class="category-item ${currentCategoryFilter === 'hot' ? 'active' : ''}" onclick="switchCategory('hot')">
          <span class="category-icon">ğŸ”¥</span>
          <span class="category-name">çƒ­é—¨æ ‡ç­¾</span>
          <span class="category-count">${hotCount}</span>
        </div>
      `;
      
      categories.forEach(cat => {
        const count = Object.values(tags).filter(t => t.categoryId === cat.id).length;
        html += `
          <div class="category-item ${currentCategoryFilter === cat.id ? 'active' : ''}" onclick="switchCategory('${cat.id}')">
            <span class="category-icon">${cat.icon}</span>
            <span class="category-name">${escapeHtml(cat.name)}</span>
            <span class="category-count">${count}</span>
          </div>
        `;
      });
      
      html += `
        <div class="category-item ${currentCategoryFilter === 'uncategorized' ? 'active' : ''}" onclick="switchCategory('uncategorized')">
          <span class="category-icon">â“</span>
          <span class="category-name">æœªåˆ†ç±»</span>
          <span class="category-count">${uncategorizedCount}</span>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function switchCategory(categoryId) {
      if (currentCategoryFilter === categoryId) return;
      
      currentCategoryFilter = categoryId;
      
      // æ·»åŠ è§†è§‰åé¦ˆ
      const contentScroll = document.querySelector('.content-scroll');
      contentScroll.style.opacity = '0.5';
      contentScroll.style.pointerEvents = 'none';
      
      renderCategoryNav();
      
      // ä½¿ç”¨ requestAnimationFrame è®©åŠ¨ç”»æ›´æµç•…
      requestAnimationFrame(() => {
        filterTags();
        
        setTimeout(() => {
          contentScroll.style.opacity = '1';
          contentScroll.style.pointerEvents = 'auto';
        }, 150);
      });
    }

    // ========== è§†å›¾åˆ‡æ¢ ==========
    
    function switchView(view) {
      if (currentView === view) return;
      
      currentView = view;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      // æ·»åŠ æ·¡å‡ºæ•ˆæœ
      const rankingView = document.getElementById('rankingView');
      const listView = document.getElementById('listView');
      const currentViewElem = currentView === 'ranking' ? rankingView : listView;
      const otherViewElem = currentView === 'ranking' ? listView : rankingView;
      
      // æ·¡å‡ºå½“å‰è§†å›¾
      otherViewElem.style.opacity = '0';
      setTimeout(() => {
        otherViewElem.style.display = 'none';
        currentViewElem.style.display = 'block';
        currentViewElem.style.opacity = '0';
        
        requestAnimationFrame(() => {
          currentViewElem.style.transition = 'opacity 0.3s ease-out';
          currentViewElem.style.opacity = '1';
        });
      }, 200);
      
      renderCurrentView();
    }

    function renderCurrentView() {
      if (currentView === 'ranking') {
        renderRankingView();
      } else {
        renderListView();
      }
    }

    // ========== æ’è¡Œæ¦œè§†å›¾ ==========
    
    function renderRankingView() {
      const container = document.getElementById('rankingView');
      
      if (filteredTags.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ·ï¸</div>
            <h3 style="color: var(--text-secondary); margin-bottom: var(--space-2);">æš‚æ— æ ‡ç­¾</h3>
            <p style="color: var(--text-tertiary);">ä»åšä¸»ç®¡ç†å·¥å…·æ·»åŠ æ ‡ç­¾åï¼Œå®ƒä»¬ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
            <button class="btn btn-primary" onclick="window.location.href='02 YouTubeåšä¸»ç®¡ç†å·¥å…·.html'" style="margin-top: var(--space-4);">
              å‰å¾€åšä¸»ç®¡ç†
            </button>
          </div>
        `;
        return;
      }
      
      const categoryName = getCurrentCategoryName();
      
      container.innerHTML = `
        <div class="ranking-header">
          <h2>ğŸ“Š ${categoryName} TOP ${Math.min(filteredTags.length, 20)}</h2>
          <p>å±•ç¤ºä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ ‡ç­¾</p>
        </div>
        <div class="ranking-grid">
          ${filteredTags.slice(0, 20).map((tagName, index) => {
            const tag = tags[tagName];
            const category = getCategoryById(tag.categoryId);
            const heat = getHeatLevel(tag.count);
            
            return `
              <div class="rank-card" onclick="showTagDetail('${escapeHtml(tagName)}')">
                <div class="rank-badge">#${index + 1}</div>
                <div class="rank-tag-name">${escapeHtml(tagName)}</div>
                <div class="rank-stats">
                  <div class="rank-count">${tag.count}æ¬¡</div>
                  <div class="rank-heat">${heat}</div>
                </div>
                <div class="rank-category">${category ? escapeHtml(category.name) : 'æœªåˆ†ç±»'}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ========== åˆ—è¡¨è§†å›¾ ==========
    
    function renderListView() {
      const container = document.getElementById('listView');
      
      if (filteredTags.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ·ï¸</div>
            <h3 style="color: var(--text-secondary); margin-bottom: var(--space-2);">æš‚æ— æ ‡ç­¾</h3>
            <p style="color: var(--text-tertiary);">ä»åšä¸»ç®¡ç†å·¥å…·æ·»åŠ æ ‡ç­¾åï¼Œå®ƒä»¬ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="list-table">
          <div class="list-table-header">
            <div></div>
            <div>æ ‡ç­¾åç§°</div>
            <div>ä½¿ç”¨æ¬¡æ•°</div>
            <div>çƒ­åº¦</div>
            <div>åˆ†ç±»</div>
            <div>æ“ä½œ</div>
          </div>
          <div class="list-table-body">
            ${filteredTags.map(tagName => {
              const tag = tags[tagName];
              const isSelected = selectedTags.has(tagName);
              const isExpanded = expandedTags.has(tagName);
              const category = getCategoryById(tag.categoryId);
              const heat = getHeatLevel(tag.count);
              
              return `
                <div class="list-row ${isSelected ? 'selected' : ''} ${isExpanded ? 'expanded' : ''}" 
                     data-tag="${escapeHtml(tagName)}"
                     onclick="toggleTagExpand(event, '${escapeHtml(tagName)}')">
                  <div>
                    <input 
                      type="checkbox" 
                      class="list-checkbox" 
                      ${isSelected ? 'checked' : ''}
                      onclick="event.stopPropagation()"
                      onchange="toggleTagSelection('${escapeHtml(tagName)}')"
                    >
                  </div>
                  <div class="list-tag-name">
                    <span class="expand-icon">â–¶</span>
                    <span>${escapeHtml(tagName)}</span>
                  </div>
                  <div class="list-count">${tag.count}æ¬¡</div>
                  <div class="list-heat">${heat}</div>
                  <div class="list-category">${category ? escapeHtml(category.name) : 'æœªåˆ†ç±»'}</div>
                  <div class="list-actions" onclick="event.stopPropagation()">
                    <button class="icon-btn-sm" onclick="openTagEditModal('${escapeHtml(tagName)}')" title="ç¼–è¾‘">âœï¸</button>
                    <button class="icon-btn-sm" onclick="renameTag('${escapeHtml(tagName)}')" title="é‡å‘½å">ğŸ“</button>
                    <button class="icon-btn-sm" onclick="deleteTag('${escapeHtml(tagName)}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                  </div>
                </div>
                <div class="list-detail" data-tag-detail="${escapeHtml(tagName)}">
                  <div class="detail-actions">
                    <button class="btn btn-sm btn-primary" onclick="openTagEditModal('${escapeHtml(tagName)}')">
                      âœï¸ ç¼–è¾‘æ ‡ç­¾
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="renameTag('${escapeHtml(tagName)}')">
                      ğŸ“ é‡å‘½å
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTag('${escapeHtml(tagName)}')">
                      ğŸ—‘ï¸ åˆ é™¤
                    </button>
                  </div>
                  ${tag.count > 0 ? `
                    <div>
                      <h4 style="margin: 0 0 var(--space-3) 0; font-size: var(--text-sm); color: var(--text-secondary);">
                        ä½¿ç”¨è¯¥æ ‡ç­¾çš„åšä¸» (${tag.count})
                      </h4>
                      <div class="channel-grid">
                        ${tag.channels.map(channel => `
                          <div class="channel-card">
                            <img class="channel-avatar" src="${channel.avatar}" alt="${escapeHtml(channel.name)}">
                            <span class="channel-name">${escapeHtml(channel.name)}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : '<p style="color: var(--text-tertiary); font-size: var(--text-sm);">æš‚æ— åšä¸»ä½¿ç”¨æ­¤æ ‡ç­¾</p>'}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function getCurrentCategoryName() {
      if (currentCategoryFilter === 'all') return 'å…¨éƒ¨æ ‡ç­¾';
      if (currentCategoryFilter === 'hot') return 'çƒ­é—¨æ ‡ç­¾';
      if (currentCategoryFilter === 'uncategorized') return 'æœªåˆ†ç±»æ ‡ç­¾';
      const cat = getCategoryById(currentCategoryFilter);
      return cat ? cat.name : 'æ ‡ç­¾';
    }

    // ========== æ ‡ç­¾è¯¦æƒ… ==========
    
    function showTagDetail(tagName) {
      if (currentView === 'ranking') {
        // åˆ‡æ¢åˆ°åˆ—è¡¨è§†å›¾å¹¶å±•å¼€
        currentView = 'list';
        switchView('list');
        setTimeout(() => {
          expandedTags.add(tagName);
          renderListView();
          const element = document.querySelector(`[data-tag="${tagName}"]`);
          if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    }

    function toggleTagExpand(event, tagName) {
      if (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON') {
        return;
      }
      
      if (expandedTags.has(tagName)) {
        expandedTags.delete(tagName);
      } else {
        expandedTags.add(tagName);
      }
      renderListView();
    }

    // ========== ç­›é€‰å’Œæ’åº ==========
    
    // åˆ›å»ºé˜²æŠ–çš„ç­›é€‰å‡½æ•°
    const debouncedFilter = debounce(() => {
      filterTags();
    }, 300);
    
    function filterTags() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      
      filteredTags = Object.keys(tags).filter(tagName => {
        const tag = tags[tagName];
        
        // æ–‡æœ¬æœç´¢
        if (!tagName.toLowerCase().includes(searchText)) {
          return false;
        }
        
        // åˆ†ç±»ç­›é€‰
        if (currentCategoryFilter === 'hot') {
          return tag.count >= 5;
        } else if (currentCategoryFilter === 'uncategorized') {
          return !tag.categoryId;
        } else if (currentCategoryFilter !== 'all') {
          return tag.categoryId === currentCategoryFilter;
        }
        
        return true;
      });
      
      sortTags();
    }

    function sortTags() {
      const sortBy = document.getElementById('sortSelect').value;
      
      filteredTags.sort((a, b) => {
        switch(sortBy) {
          case 'name-asc':
            return a.localeCompare(b);
          case 'name-desc':
            return b.localeCompare(a);
          case 'count-asc':
            return tags[a].count - tags[b].count;
          case 'count-desc':
            return tags[b].count - tags[a].count;
          default:
            return 0;
        }
      });
      
      renderCurrentView();
    }

    // ========== æ ‡ç­¾é€‰æ‹© ==========
    
    function toggleTagSelection(tagName) {
      if (selectedTags.has(tagName)) {
        selectedTags.delete(tagName);
      } else {
        selectedTags.add(tagName);
      }
      updateBatchActionsBar();
      renderListView();
    }

    function selectAll() {
      selectedTags.clear();
      filteredTags.forEach(tag => selectedTags.add(tag));
      updateBatchActionsBar();
      renderListView();
    }

    function deselectAll() {
      selectedTags.clear();
      updateBatchActionsBar();
      renderListView();
    }

    function updateBatchActionsBar() {
      const bar = document.getElementById('batchActionsBar');
      const count = document.getElementById('selectedCount');
      
      count.textContent = selectedTags.size;
      
      if (selectedTags.size > 0) {
        bar.classList.add('show');
      } else {
        bar.classList.remove('show');
      }
    }

    // ========== åˆ†ç±»ç®¡ç† ==========
    
    function openCategoryModal(categoryId = null) {
      currentEditCategory = categoryId ? categories.find(c => c.id === categoryId) : null;
      
      // ç”Ÿæˆå›¾æ ‡é€‰æ‹©å™¨
      const icons = ['ğŸ“', 'ğŸ±', 'ğŸ¨', 'ğŸµ', 'ğŸ“š', 'ğŸ’¼', 'ğŸƒ', 'ğŸŒ', 'ğŸ”¬', 'ğŸ¬', 'âš™ï¸', 'ğŸ“', 'ğŸ’°', 'ğŸš€', 'ğŸ ', 'ğŸŒ±', 'âš½', 'ğŸª', 'ğŸ¯', 'ğŸ¸', 'ğŸ•', 'ğŸ›’', 'ğŸ®', 'ğŸ“±'];
      document.getElementById('iconPicker').innerHTML = icons.map(icon => `
        <button class="icon-btn ${currentEditCategory && currentEditCategory.icon === icon ? 'selected' : ''}" 
                onclick="selectIcon('${icon}', event)" type="button">
          ${icon}
        </button>
      `).join('');
      
      if (currentEditCategory) {
        document.getElementById('categoryModalTitle').textContent = 'âœï¸ ç¼–è¾‘åˆ†ç±»';
        document.getElementById('categoryNameInput').value = currentEditCategory.name;
        document.getElementById('categoryIconInput').value = currentEditCategory.icon;
        document.getElementById('categoryColorInput').value = currentEditCategory.color;
        document.getElementById('deleteCategoryBtn').style.display = 'block';
        
        document.querySelectorAll('.color-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.color === currentEditCategory.color);
        });
      } else {
        document.getElementById('categoryModalTitle').textContent = 'â• æ–°å»ºåˆ†ç±»';
        document.getElementById('categoryNameInput').value = '';
        document.getElementById('categoryIconInput').value = 'ğŸ“';
        document.getElementById('categoryColorInput').value = '#8B5CF6';
        document.getElementById('deleteCategoryBtn').style.display = 'none';
        
        document.querySelectorAll('.color-btn').forEach((btn, idx) => {
          btn.classList.toggle('selected', idx === 0);
        });
      }
      
      document.getElementById('categoryModal').style.display = 'block';
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').style.display = 'none';
      currentEditCategory = null;
    }

    function selectIcon(icon, evt) {
      document.getElementById('categoryIconInput').value = icon;
      document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      if (evt && evt.currentTarget) {
        evt.currentTarget.classList.add('selected');
      }
    }

    function selectColor(color) {
      document.getElementById('categoryColorInput').value = color;
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.color === color);
      });
    }

    async function saveCategoryData() {
      const name = document.getElementById('categoryNameInput').value.trim();
      const icon = document.getElementById('categoryIconInput').value;
      const color = document.getElementById('categoryColorInput').value;
      
      if (!name) {
        showMessage('è¯·è¾“å…¥åˆ†ç±»åç§°', 'error');
        return;
      }
      
      // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
      const saveBtn = event.target;
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      saveBtn.style.opacity = '0.6';
      
      try {
        const categoryData = {
          id: currentEditCategory ? currentEditCategory.id : 'cat-' + Date.now(),
          name,
          icon,
          color,
          createdAt: currentEditCategory ? currentEditCategory.createdAt : Date.now()
        };
        
        await saveCategory(categoryData);
        
        if (currentEditCategory) {
          const index = categories.findIndex(c => c.id === currentEditCategory.id);
          if (index !== -1) {
            categories[index] = categoryData;
          }
        } else {
          categories.push(categoryData);
        }
        
        renderCategoryNav();
        closeCategoryModal();
        showMessage(currentEditCategory ? 'âœ… åˆ†ç±»å·²æ›´æ–°' : 'âœ… åˆ†ç±»å·²åˆ›å»º', 'success');
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showMessage('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
        saveBtn.style.opacity = '1';
      }
    }

    async function confirmDeleteCategory() {
      if (!currentEditCategory) return;
      
      const tagCount = Object.values(tags).filter(t => t.categoryId === currentEditCategory.id).length;
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${currentEditCategory.name}"å—ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹æœ‰ ${tagCount} ä¸ªæ ‡ç­¾ï¼Œåˆ é™¤åè¿™äº›æ ‡ç­¾å°†å˜ä¸ºæœªåˆ†ç±»ã€‚`)) {
        return;
      }
      
      // ä»æ‰€æœ‰æ ‡ç­¾ä¸­ç§»é™¤è¯¥åˆ†ç±»
      for (const tagName of Object.keys(tags)) {
        const tag = tags[tagName];
        if (tag.categoryId === currentEditCategory.id) {
          tag.categoryId = null;
          await saveTagMetadata(tagName, { categoryId: null });
        }
      }
      
      await deleteCategory(currentEditCategory.id);
      categories = categories.filter(c => c.id !== currentEditCategory.id);
      
      renderCategoryNav();
      closeCategoryModal();
      renderCurrentView();
      showMessage('åˆ†ç±»å·²åˆ é™¤', 'success');
    }

    // ========== æ ‡ç­¾ç¼–è¾‘ ==========
    
    function openTagEditModal(tagName) {
      currentEditTag = tagName;
      const tag = tags[tagName];
      
      document.getElementById('tagNameEditInput').value = tagName;
      
      // å¡«å……åˆ†ç±»é€‰é¡¹
      const categorySelect = document.getElementById('tagCategorySelect');
      categorySelect.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>' +
        categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
      categorySelect.value = tag.categoryId || '';
      
      document.getElementById('tagEditModal').style.display = 'block';
    }

    function closeTagEditModal() {
      document.getElementById('tagEditModal').style.display = 'none';
      currentEditTag = '';
    }

    async function saveTagEdit() {
      if (!currentEditTag) return;
      
      const categoryId = document.getElementById('tagCategorySelect').value || null;
      
      tags[currentEditTag].categoryId = categoryId;
      
      await saveTagMetadata(currentEditTag, { categoryId });
      
      closeTagEditModal();
      renderCategoryNav();
      renderCurrentView();
      showMessage('æ ‡ç­¾å·²æ›´æ–°', 'success');
    }

    // ========== é‡å‘½åæ ‡ç­¾ ==========
    
    function renameTag(oldName) {
      currentRenameTag = oldName;
      document.getElementById('oldTagNameDisplay').value = oldName;
      document.getElementById('newTagNameInput').value = oldName;
      document.getElementById('renameModal').style.display = 'block';
    }

    function closeRenameModal() {
      document.getElementById('renameModal').style.display = 'none';
      currentRenameTag = '';
    }

    async function confirmRename() {
      const newName = document.getElementById('newTagNameInput').value.trim();
      
      if (!newName) {
        showMessage('è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°', 'error');
        return;
      }
      
      if (newName === currentRenameTag) {
        showMessage('æ–°åç§°ä¸æ—§åç§°ç›¸åŒ', 'warning');
        return;
      }
      
      if (tags[newName]) {
        showMessage('è¯¥æ ‡ç­¾åç§°å·²å­˜åœ¨', 'error');
        return;
      }
      
      // æ›´æ–°æ‰€æœ‰ä½¿ç”¨è¯¥æ ‡ç­¾çš„é¢‘é“
      channels.forEach(channel => {
        if (channel.tags) {
          const channelTags = channel.tags.split(',').map(t => t.trim());
          const index = channelTags.indexOf(currentRenameTag);
          if (index !== -1) {
            channelTags[index] = newName;
            channel.tags = channelTags.join(', ');
          }
        }
      });
      
      await saveChannels();
      await extractTags();
      renderCategoryNav();
      filterTags();
      closeRenameModal();
      
      showMessage(`æ ‡ç­¾å·²é‡å‘½åï¼š${currentRenameTag} â†’ ${newName}`, 'success');
    }

    // ========== åˆ é™¤æ ‡ç­¾ ==========
    
    async function deleteTag(tagName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾"${tagName}"å—ï¼Ÿ\nè¿™å°†ä» ${tags[tagName].count} ä¸ªåšä¸»ä¸­ç§»é™¤æ­¤æ ‡ç­¾ã€‚`)) {
        return;
      }
      
      // ä»æ‰€æœ‰é¢‘é“ä¸­ç§»é™¤è¯¥æ ‡ç­¾
      channels.forEach(channel => {
        if (channel.tags) {
          const channelTags = channel.tags.split(',').map(t => t.trim()).filter(t => t !== tagName);
          channel.tags = channelTags.join(', ');
        }
      });
      
      await saveChannels();
      await deleteTagMetadata(tagName);
      await extractTags();
      renderCategoryNav();
      filterTags();
      
      showMessage(`æ ‡ç­¾"${tagName}"å·²åˆ é™¤`, 'success');
    }

    // ========== æ‰¹é‡æ“ä½œ ==========
    
    function openBatchEditModal() {
      if (selectedTags.size === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„æ ‡ç­¾', 'warning');
        return;
      }
      
      document.getElementById('batchEditCount').textContent = selectedTags.size;
      
      const categorySelect = document.getElementById('batchCategorySelect');
      categorySelect.innerHTML = '<option value="">-- æœªåˆ†ç±» --</option>' +
        categories.map(cat => `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`).join('');
      
      document.getElementById('batchEditModal').style.display = 'block';
    }

    function closeBatchEditModal() {
      document.getElementById('batchEditModal').style.display = 'none';
    }

    async function saveBatchEdit() {
      const categoryId = document.getElementById('batchCategorySelect').value || null;
      
      let updatedCount = 0;
      
      for (const tagName of selectedTags) {
        const tag = tags[tagName];
        tag.categoryId = categoryId;
        
        await saveTagMetadata(tagName, { categoryId });
        updatedCount++;
      }
      
      closeBatchEditModal();
      deselectAll();
      renderCategoryNav();
      renderCurrentView();
      showMessage(`æˆåŠŸæ›´æ–° ${updatedCount} ä¸ªæ ‡ç­¾`, 'success');
    }

    async function batchDeleteTags() {
      if (selectedTags.size === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾', 'warning');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTags.size} ä¸ªæ ‡ç­¾å—ï¼Ÿ\nè¿™å°†ä»æ‰€æœ‰åšä¸»ä¸­ç§»é™¤è¿™äº›æ ‡ç­¾ã€‚`)) {
        return;
      }
      
      // ä»æ‰€æœ‰é¢‘é“ä¸­ç§»é™¤é€‰ä¸­çš„æ ‡ç­¾
      channels.forEach(channel => {
        if (channel.tags) {
          const channelTags = channel.tags.split(',')
            .map(t => t.trim())
            .filter(t => !selectedTags.has(t));
          channel.tags = channelTags.join(', ');
        }
      });
      
      // åˆ é™¤å…ƒæ•°æ®
      for (const tagName of selectedTags) {
        await deleteTagMetadata(tagName);
      }
      
      await saveChannels();
      selectedTags.clear();
      await extractTags();
      renderCategoryNav();
      filterTags();
      updateBatchActionsBar();
      
      showMessage('é€‰ä¸­çš„æ ‡ç­¾å·²åˆ é™¤', 'success');
    }

    function batchMergeTags() {
      if (selectedTags.size < 2) {
        showMessage('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ ‡ç­¾è¿›è¡Œåˆå¹¶', 'warning');
        return;
      }
      
      document.getElementById('selectedTagsList').innerHTML = 
        Array.from(selectedTags).map(tag => `<span style="display: inline-block; padding: 4px 8px; background: var(--primary-100); color: var(--primary-700); border-radius: 4px; margin: 2px;">${escapeHtml(tag)}</span>`).join(' ');
      
      const select = document.getElementById('mergeTargetSelect');
      const availableTags = Object.keys(tags).filter(tag => !selectedTags.has(tag));
      
      select.innerHTML = '<option value="">-- é€‰æ‹©å·²æœ‰æ ‡ç­¾ --</option>' +
        availableTags.map(tag => `<option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>`).join('');
      
      document.getElementById('mergeTargetInput').value = '';
      document.getElementById('mergeModal').style.display = 'block';
    }

    function closeMergeModal() {
      document.getElementById('mergeModal').style.display = 'none';
    }

    function onMergeTargetChange() {
      const select = document.getElementById('mergeTargetSelect');
      const input = document.getElementById('mergeTargetInput');
      
      if (select.value) {
        input.value = '';
        input.disabled = true;
      } else {
        input.disabled = false;
      }
    }

    async function confirmMerge() {
      const selectValue = document.getElementById('mergeTargetSelect').value;
      const inputValue = document.getElementById('mergeTargetInput').value.trim();
      const targetTag = selectValue || inputValue;
      
      if (!targetTag) {
        showMessage('è¯·é€‰æ‹©æˆ–è¾“å…¥ç›®æ ‡æ ‡ç­¾', 'error');
        return;
      }
      
      if (selectedTags.has(targetTag)) {
        showMessage('ç›®æ ‡æ ‡ç­¾ä¸èƒ½æ˜¯é€‰ä¸­çš„æ ‡ç­¾ä¹‹ä¸€', 'error');
        return;
      }
      
      // åˆå¹¶æ ‡ç­¾
      channels.forEach(channel => {
        if (channel.tags) {
          let channelTags = channel.tags.split(',').map(t => t.trim());
          const hasSelectedTag = channelTags.some(t => selectedTags.has(t));
          
          if (hasSelectedTag) {
            channelTags = channelTags.filter(t => !selectedTags.has(t));
            if (!channelTags.includes(targetTag)) {
              channelTags.push(targetTag);
            }
            channel.tags = channelTags.join(', ');
          }
        }
      });
      
      await saveChannels();
      selectedTags.clear();
      await extractTags();
      renderCategoryNav();
      filterTags();
      updateBatchActionsBar();
      closeMergeModal();
      
      showMessage(`æ ‡ç­¾å·²åˆå¹¶ä¸ºï¼š${targetTag}`, 'success');
    }

    // ========== å…¶ä»–åŠŸèƒ½ ==========
    
    function exportTags() {
      if (Object.keys(tags).length === 0) {
        showMessage('æ²¡æœ‰æ ‡ç­¾å¯å¯¼å‡º', 'warning');
        return;
      }
      
      const csvContent = [
        ['æ ‡ç­¾åç§°', 'ä½¿ç”¨æ¬¡æ•°', 'çƒ­åº¦', 'åˆ†ç±»', 'å…³è”åšä¸»'].join(','),
        ...Object.entries(tags).map(([tagName, data]) => {
          const category = getCategoryById(data.categoryId);
          return [
            `"${tagName}"`,
            data.count,
            getHeatLevel(data.count),
            `"${category ? category.name : 'æœªåˆ†ç±»'}"`,
            `"${data.channels.map(ch => ch.name).join('; ')}"`
          ].join(',');
        })
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `tags_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showMessage('æ ‡ç­¾æ•°æ®å·²å¯¼å‡º', 'success');
    }

    async function syncFromChannels() {
      await loadChannels();
      await extractTags();
      renderCategoryNav();
      filterTags();
      showMessage('å·²ä»åšä¸»æ•°æ®åŒæ­¥æ ‡ç­¾', 'success');
    }

    // ========== åˆå§‹åŒ– ==========
    
    function showLoading(show = true) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }
    
    window.onload = async function() {
      showLoading(true);
      
      try {
        console.log('å¼€å§‹åˆå§‹åŒ–...');
        await initDB();
        await loadChannels();
        await loadCategories();
        await extractTags();
        renderCategoryNav();
        sortTags();
        
        // å»¶è¿Ÿä¸€ä¸‹å†éšè—åŠ è½½åŠ¨ç”»ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åŠ è½½å®Œæˆ
        setTimeout(() => {
          showLoading(false);
        }, 500);
        
        console.log(`âœ… åˆå§‹åŒ–æˆåŠŸ: ${channels.length} ä¸ªåšä¸»ï¼Œ${categories.length} ä¸ªåˆ†ç±»ï¼Œ${Object.keys(tags).length} ä¸ªæ ‡ç­¾`);
        
        // æ˜¾ç¤ºæ¬¢è¿æç¤º
        if (Object.keys(tags).length > 0) {
          showMessage(`ğŸ“Š å·²åŠ è½½ ${Object.keys(tags).length} ä¸ªæ ‡ç­¾`, 'success', 2000);
        }
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        showLoading(false);
        showMessage('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error', 15000);
      }
    };

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };

    // ç§»åŠ¨ç«¯å¯¼èˆªèœå•åˆ‡æ¢
    (function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const navMenu = document.querySelector('.nav-menu');
      
      if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          navMenu.classList.toggle('show');
          mobileMenuBtn.setAttribute('aria-expanded', navMenu.classList.contains('show') ? 'true' : 'false');
        });
        
        const navLinks = navMenu.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            navMenu.classList.remove('show');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
          });
        });
      }
    })();
  </script>
</body>
</html>
