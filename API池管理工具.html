<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APIæ± ç®¡ç†å·¥å…· - PHANTOM RADAR</title>
  <link rel="stylesheet" href="youtube-tools-p5-refined.css">
  <style>
    /* é¡µé¢ç‰¹å®šæ ·å¼ */
    
    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--p5-black-card);
      border: 2px solid var(--p5-gray-dark);
      overflow: hidden;
      position: relative;
      z-index: 2;
    }
    
    .page-title {
      padding: 40px 30px;
      text-align: center;
      border-bottom: 2px solid var(--p5-red);
      background: var(--p5-black-panel);
    }
    
    .page-title h1 {
      font-size: 36px;
      margin-bottom: 12px;
      color: var(--p5-white);
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing: 1px;
    }
    
    .page-title h1::before,
    .page-title h1::after {
      display: none;
    }
    
    .page-title p {
      color: var(--p5-gray-lighter);
      font-size: 14px;
    }
    
    .toolbar {
      padding: 30px;
      background: var(--p5-black-panel);
      border-bottom: 2px solid var(--p5-gray-dark);
    }
    
    .toolbar-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .input-group {
      flex: 1;
      min-width: 200px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--p5-white);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    
    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--p5-gray-dark);
      background: var(--p5-black-card);
      color: var(--p5-white);
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .input-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: monospace;
    }
    
    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: var(--p5-red);
      box-shadow: 0 0 10px var(--p5-red-glow);
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary {
      background: var(--p5-red);
      color: var(--p5-white);
      box-shadow: var(--p5-shadow-sm);
    }
    
    .btn-primary:hover {
      background: var(--p5-red-light);
      box-shadow: var(--p5-shadow-md);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--p5-gray-dark);
      color: var(--p5-white);
      border: 2px solid var(--p5-gray-light);
    }
    
    .btn-secondary:hover {
      background: var(--p5-gray);
      border-color: var(--p5-white);
    }
    
    .btn-success {
      background: var(--p5-red);
      color: var(--p5-white);
      box-shadow: var(--p5-shadow-sm);
    }
    
    .btn-success:hover {
      background: var(--p5-red-light);
      box-shadow: var(--p5-shadow-md);
    }
    
    .btn-danger {
      background: var(--p5-red-darker);
      color: var(--p5-white);
      box-shadow: var(--p5-shadow-sm);
    }
    
    .btn-danger:hover {
      background: var(--p5-red-dark);
      box-shadow: var(--p5-shadow-md);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .stats-bar {
      padding: 30px;
      background: var(--p5-black-panel);
      border-bottom: 2px solid var(--p5-gray-dark);
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 30px;
    }
    
    .stat-item {
      text-align: center;
      position: relative;
    }
    
    .stat-number {
      font-size: 42px;
      font-weight: 900;
      color: var(--p5-red);
      text-shadow: 0 0 20px var(--p5-red-glow);
      font-family: var(--p5-font-display);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--p5-gray-lighter);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }
    
    .api-list {
      padding: 30px;
      background: var(--p5-black-card);
    }
    
    .api-card {
      background: var(--p5-black-panel);
      border: 2px solid var(--p5-gray-dark);
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.15s;
      position: relative;
    }
    
    .api-card:hover {
      border-color: var(--p5-red);
      box-shadow: var(--p5-shadow-md);
      transform: translateX(4px);
    }
    
    .api-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .api-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--p5-white);
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .api-status {
      padding: 6px 14px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid;
    }
    
    .status-active {
      background: var(--p5-black-card);
      color: #00ff00;
      border-color: #00ff00;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }
    
    .status-exhausted {
      background: var(--p5-black-card);
      color: var(--p5-yellow);
      border-color: var(--p5-yellow);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    .status-disabled {
      background: var(--p5-black-card);
      color: var(--p5-gray-lighter);
      border-color: var(--p5-gray-light);
    }
    
    .api-key-display {
      font-family: monospace;
      background: var(--p5-black-card);
      padding: 12px;
      font-size: 13px;
      word-break: break-all;
      margin-bottom: 10px;
      color: var(--p5-white);
      border: 2px solid var(--p5-gray-dark);
    }
    
    .api-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .api-card .info-text {
      font-size: 12px;
      color: var(--p5-gray-lighter);
      margin-bottom: 15px;
    }
    
    .message {
      padding: 16px 20px;
      margin: 20px 30px;
      font-size: 14px;
      font-weight: 600;
      border: 2px solid;
      position: relative;
      overflow: hidden;
    }
    
    .message::before {
      content: 'â–¶';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      animation: pulseMessage 1.5s ease-in-out infinite;
    }
    
    @keyframes pulseMessage {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .message.success {
      background: var(--p5-black-panel);
      color: #00ff00;
      border-color: #00ff00;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }
    
    .message.success::before {
      color: #00ff00;
    }
    
    .message.error {
      background: var(--p5-black-panel);
      color: var(--p5-red-light);
      border-color: var(--p5-red);
      box-shadow: 0 0 15px var(--p5-red-glow);
    }
    
    .message.error::before {
      color: var(--p5-red);
    }
    
    .message.warning {
      background: var(--p5-black-panel);
      color: var(--p5-yellow);
      border-color: var(--p5-yellow);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
    }
    
    .message.warning::before {
      color: var(--p5-yellow);
    }
    
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--p5-gray-lighter);
    }
    
    .empty-state h3 {
      color: var(--p5-white);
      margin: 20px 0 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .empty-state-icon {
      font-size: 72px;
      margin-bottom: 20px;
      opacity: 0.3;
      filter: grayscale(100%);
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <div class="logo">
        <a href="01 ä½ç²‰çˆ†æ¬¾æŒ–æ˜.html">PHANTOM RADAR</a>
      </div>
      <div class="nav-menu">
        <ul>
          <li><a href="01 ä½ç²‰çˆ†æ¬¾æŒ–æ˜.html">çˆ†æ¬¾æŒ–æ˜</a></li>
          <li><a href="02 YouTubeåšä¸»ç®¡ç†å·¥å…·.html">åšä¸»ç®¡ç†</a></li>
          <li><a href="03 è§†é¢‘ç›‘æ§å·¥å…·.html">è§†é¢‘ç›‘æ§</a></li>
          <li><a href="04 æ ‡ç­¾ç®¡ç†å·¥å…·.html">æ ‡ç­¾ç®¡ç†</a></li>
          <li><a href="APIæ± ç®¡ç†å·¥å…·.html" class="active">APIç®¡ç†</a></li>
        </ul>
      </div>
      <button class="mobile-menu-btn" aria-label="æ‰“å¼€ä¸»èœå•" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <div class="container">
    <div class="content-wrapper">
      <div class="page-title">
        <h1>ğŸ”‘ APIæ± ç®¡ç†å·¥å…·</h1>
        <p>ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å·¥å…·çš„YouTube API Key | æ”¯æŒæ‰‹åŠ¨æ·»åŠ ã€æ‰¹é‡å¯¼å…¥</p>
      </div>
    
    <div class="toolbar">
      <div class="toolbar-row">
        <div class="input-group">
          <label for="singleApiKey">å•ä¸ªAPI Key</label>
          <input type="text" id="singleApiKey" placeholder="AIzaSy... (ç²˜è´´å•ä¸ªAPI Key)">
        </div>
        <button class="btn btn-primary" onclick="addSingleApi()">â• æ·»åŠ å•ä¸ª</button>
      </div>
      
      <div class="toolbar-row" style="margin-bottom: 0;">
        <div class="input-group">
          <label for="bulkApiKeys">æ‰¹é‡API Keysï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
          <textarea id="bulkApiKeys" placeholder="AIzaSy...&#10;AIzaSy...&#10;AIzaSy..."></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
        <button class="btn btn-success" onclick="addBulkApis()">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
        <button class="btn btn-secondary" onclick="exportApis()">ğŸ“¤ å¯¼å‡ºAPIåˆ—è¡¨</button>
        <button class="btn btn-secondary" onclick="resetAllStatus()">ğŸ”„ é‡ç½®æ‰€æœ‰çŠ¶æ€</button>
        <button class="btn btn-danger" onclick="clearAllApis()">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
      </div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-number" id="totalApis">0</div>
        <div class="stat-label">æ€»APIæ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="activeApis">0</div>
        <div class="stat-label">å¯ç”¨</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="exhaustedApis">0</div>
        <div class="stat-label">å·²ç”¨å°½</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="disabledApis">0</div>
        <div class="stat-label">å·²ç¦ç”¨</div>
      </div>
    </div>
    
    <div id="messageDiv"></div>
    
    <div class="api-list" id="apiList">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ”‘</div>
        <h3>æš‚æ— API Key</h3>
        <p>è¯·åœ¨ä¸Šæ–¹æ·»åŠ YouTube API Key</p>
      </div>
    </div>
    </div><!-- end content-wrapper -->
  </div><!-- end container -->
  
  <script>
    let apiPool = [];
    let db;
    let isInitialized = false; // æ·»åŠ åˆå§‹åŒ–çŠ¶æ€æ ‡è®°
    
    // åˆå§‹åŒ–IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        console.log('ğŸ“‚ å¼€å§‹åˆå§‹åŒ–IndexedDB...');
        const request = indexedDB.open('YouTubeToolDB', 5);
        
        request.onerror = (event) => {
          console.error('âŒ æ•°æ®åº“æ‰“å¼€å¤±è´¥:', event.target.error);
          reject(event.target.error);
        };
        
        request.onblocked = (event) => {
          console.warn('âš ï¸ æ•°æ®åº“è¢«é˜»å¡ï¼Œå¯èƒ½æœ‰å…¶ä»–æ ‡ç­¾é¡µæ­£åœ¨ä½¿ç”¨');
          showMessage('æ•°æ®åº“è¢«é˜»å¡ï¼Œè¯·å…³é—­å…¶ä»–ä½¿ç”¨è¯¥å·¥å…·çš„æ ‡ç­¾é¡µååˆ·æ–°', 'warning', 10000);
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼Œç‰ˆæœ¬:', db.version);
          
          // éªŒè¯å¿…è¦çš„å¯¹è±¡å­˜å‚¨æ˜¯å¦å­˜åœ¨
          const requiredStores = ['apiPool', 'settings', 'channels', 'monitorChannels', 'monitorVideos'];
          const missingStores = requiredStores.filter(store => !db.objectStoreNames.contains(store));
          
          if (missingStores.length > 0) {
            console.warn('âš ï¸ ç¼ºå°‘å¿…è¦çš„å­˜å‚¨:', missingStores.join(', '));
            console.log('å°†è§¦å‘æ•°æ®åº“é‡å»º...');
            db.close();
            
            // åˆ é™¤å¹¶é‡å»ºæ•°æ®åº“
            const deleteRequest = indexedDB.deleteDatabase('YouTubeToolDB');
            deleteRequest.onsuccess = () => {
              console.log('ğŸ”„ æ•°æ®åº“å·²åˆ é™¤ï¼Œæ­£åœ¨é‡æ–°åˆ›å»º...');
              initDB().then(resolve).catch(reject);
            };
            deleteRequest.onerror = () => {
              reject(new Error('æ— æ³•åˆ é™¤æŸåçš„æ•°æ®åº“'));
            };
            return;
          }
          
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          const oldVersion = event.oldVersion;
          const newVersion = event.newVersion;
          console.log(`ğŸ“Š æ•°æ®åº“å‡çº§: v${oldVersion} -> v${newVersion}`);
          
          // settings å­˜å‚¨
          if (!db.objectStoreNames.contains('settings')) {
            console.log('  â• åˆ›å»º settings å­˜å‚¨');
            db.createObjectStore('settings', { keyPath: 'key' });
          }
          
          // apiPool å­˜å‚¨
          if (!db.objectStoreNames.contains('apiPool')) {
            console.log('  â• åˆ›å»º apiPool å­˜å‚¨');
            const apiStore = db.createObjectStore('apiPool', { keyPath: 'id', autoIncrement: true });
            apiStore.createIndex('apiKey', 'apiKey', { unique: true });
            apiStore.createIndex('addedAt', 'addedAt', { unique: false });
          }
          
          // channels å­˜å‚¨ï¼ˆç”¨äºåšä¸»ç®¡ç†å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('channels')) {
            console.log('  â• åˆ›å»º channels å­˜å‚¨');
            const channelStore = db.createObjectStore('channels', { keyPath: 'channelId' });
            channelStore.createIndex('addedAt', 'addedAt', { unique: false });
            channelStore.createIndex('name', 'name', { unique: false });
          }
          
          // monitorChannels å­˜å‚¨ï¼ˆç”¨äºè§†é¢‘ç›‘æ§å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('monitorChannels')) {
            console.log('  â• åˆ›å»º monitorChannels å­˜å‚¨');
            const monitorChannelStore = db.createObjectStore('monitorChannels', { keyPath: 'channelId' });
            monitorChannelStore.createIndex('addedAt', 'addedAt', { unique: false });
          }
          
          // monitorVideos å­˜å‚¨ï¼ˆç”¨äºè§†é¢‘ç›‘æ§å·¥å…·ï¼‰
          if (!db.objectStoreNames.contains('monitorVideos')) {
            console.log('  â• åˆ›å»º monitorVideos å­˜å‚¨');
            const videoStore = db.createObjectStore('monitorVideos', { keyPath: 'videoId' });
            videoStore.createIndex('channelId', 'channelId', { unique: false });
            videoStore.createIndex('publishedAt', 'publishedAt', { unique: false });
          }
          
          // tagGroups å­˜å‚¨ï¼ˆç”¨äºæ‰¹é‡æ ‡ç­¾æœç´¢ï¼‰
          if (!db.objectStoreNames.contains('tagGroups')) {
            console.log('  â• åˆ›å»º tagGroups å­˜å‚¨');
            const tagGroupStore = db.createObjectStore('tagGroups', { keyPath: 'id', autoIncrement: true });
            tagGroupStore.createIndex('name', 'name', { unique: false });
            tagGroupStore.createIndex('createdAt', 'createdAt', { unique: false });
            tagGroupStore.createIndex('lastUsed', 'lastUsed', { unique: false });
          }
          
          console.log('âœ… æ•°æ®åº“ç»“æ„åˆ›å»ºå®Œæˆ');
        };
      });
    }
    
    // ä»IndexedDBè¯»å–APIæ± 
    function loadApiPool() {
      return new Promise((resolve, reject) => {
        try {
          if (!db.objectStoreNames.contains('apiPool')) {
            console.warn('apiPoolå­˜å‚¨ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°çš„ç©ºæ± ');
            apiPool = [];
            resolve();
            return;
          }
          
          const transaction = db.transaction(['apiPool'], 'readonly');
          const store = transaction.objectStore('apiPool');
          const request = store.getAll();
          
          request.onsuccess = () => {
            apiPool = request.result || [];
            console.log('æˆåŠŸåŠ è½½APIæ± :', apiPool.length, 'ä¸ªAPI');
            resolve();
          };
          request.onerror = () => {
            console.error('åŠ è½½APIæ± å¤±è´¥:', request.error);
            reject(request.error);
          };
        } catch (error) {
          console.error('loadApiPoolå¼‚å¸¸:', error);
          apiPool = [];
          resolve(); // å³ä½¿å¤±è´¥ä¹Ÿresolveï¼Œé¿å…é˜»å¡
        }
      });
    }
    
    // ä¿å­˜APIæ± åˆ°IndexedDB
    function saveApiPool() {
      return new Promise(async (resolve, reject) => {
        try {
          if (!db) {
            reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
            return;
          }
          
          const transaction = db.transaction(['apiPool'], 'readwrite');
          const store = transaction.objectStore('apiPool');
          
          // æ¸…ç©ºç°æœ‰æ•°æ®
          await new Promise((res, rej) => {
            const clearRequest = store.clear();
            clearRequest.onsuccess = () => res();
            clearRequest.onerror = () => rej(clearRequest.error);
          });
          
          // æ·»åŠ æ‰€æœ‰APIï¼ˆå»æ‰idå­—æ®µï¼Œè®©æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼‰
          for (const api of apiPool) {
            const apiData = { ...api };
            delete apiData.id; // åˆ é™¤idå­—æ®µï¼Œè®©IndexedDBè‡ªåŠ¨ç”Ÿæˆ
            store.add(apiData);
          }
          
          transaction.oncomplete = () => {
            console.log(`âœ… å·²ä¿å­˜ ${apiPool.length} ä¸ªAPIåˆ°æ•°æ®åº“`);
            resolve();
          };
          transaction.onerror = () => {
            console.error('âŒ ä¿å­˜APIæ± å¤±è´¥:', transaction.error);
            reject(transaction.error);
          };
        } catch (error) {
          console.error('âŒ saveApiPoolé”™è¯¯:', error);
          reject(error);
        }
      });
    }
    
    // éªŒè¯API Keyæ ¼å¼
    function validateApiKey(key) {
      return key.trim().startsWith('AIzaSy') && key.trim().length === 39;
    }
    
    // æ·»åŠ å•ä¸ªAPI
    async function addSingleApi() {
      if (!db) {
        showMessage('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·ç¨å€™...', 'warning');
        // å°è¯•åˆå§‹åŒ–æ•°æ®åº“
        try {
          await initDB();
          await loadApiPool();
          updateStats();
          renderApiList();
        } catch (error) {
          showMessage('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
          return;
        }
      }
      
      const apiKey = document.getElementById('singleApiKey').value.trim();
      
      if (!apiKey) {
        showMessage('è¯·è¾“å…¥API Key', 'error');
        return;
      }
      
      if (!validateApiKey(apiKey)) {
        showMessage('API Keyæ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä»¥AIzaSyå¼€å¤´ï¼Œå…±39ä¸ªå­—ç¬¦ï¼‰', 'error');
        return;
      }
      
      // æ£€æŸ¥é‡å¤
      if (apiPool.some(api => api.apiKey === apiKey)) {
        showMessage('è¯¥API Keyå·²å­˜åœ¨', 'warning');
        return;
      }
      
      const newApi = {
        apiKey: apiKey,
        status: 'active', // active, exhausted, disabled
        addedAt: new Date().toISOString(),
        usageCount: 0,
        lastUsed: null,
        note: ''
      };
      
      apiPool.push(newApi);
      
      try {
        await saveApiPool();
        // é‡æ–°ä»æ•°æ®åº“åŠ è½½ï¼Œç¡®ä¿åŒæ­¥
        await loadApiPool();
        updateStats();
        renderApiList();
        document.getElementById('singleApiKey').value = '';
        showMessage('API Keyå·²æ·»åŠ ', 'success');
        console.log('âœ… APIå·²æˆåŠŸæ·»åŠ å¹¶ä¿å­˜');
      } catch (error) {
        console.error('âŒ ä¿å­˜å¤±è´¥:', error);
        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        // å›æ»š
        apiPool.pop();
      }
    }
    
    // æ‰¹é‡æ·»åŠ API
    async function addBulkApis() {
      if (!db) {
        showMessage('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·ç¨å€™...', 'warning');
        // å°è¯•åˆå§‹åŒ–æ•°æ®åº“
        try {
          await initDB();
          await loadApiPool();
          updateStats();
          renderApiList();
        } catch (error) {
          showMessage('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
          return;
        }
      }
      
      const bulkText = document.getElementById('bulkApiKeys').value.trim();
      
      if (!bulkText) {
        showMessage('è¯·è¾“å…¥API Keys', 'error');
        return;
      }
      
      const lines = bulkText.split('\n').filter(line => line.trim());
      let added = 0;
      let duplicate = 0;
      let invalid = 0;
      
      console.log(`å¼€å§‹æ‰¹é‡å¯¼å…¥ ${lines.length} ä¸ªAPI...`);
      
      for (const line of lines) {
        const apiKey = line.trim();
        
        if (!validateApiKey(apiKey)) {
          console.log(`âŒ æ— æ•ˆçš„API Key: ${apiKey.substring(0, 10)}...`);
          invalid++;
          continue;
        }
        
        if (apiPool.some(api => api.apiKey === apiKey)) {
          console.log(`âš ï¸ é‡å¤çš„API Key: ${apiKey.substring(0, 10)}...`);
          duplicate++;
          continue;
        }
        
        apiPool.push({
          apiKey: apiKey,
          status: 'active',
          addedAt: new Date().toISOString(),
          usageCount: 0,
          lastUsed: null,
          note: ''
        });
        
        console.log(`âœ… æ·»åŠ æˆåŠŸ: ${apiKey.substring(0, 10)}...`);
        added++;
      }
      
      if (added > 0) {
        try {
          await saveApiPool();
          // é‡æ–°ä»æ•°æ®åº“åŠ è½½ï¼Œç¡®ä¿åŒæ­¥
          await loadApiPool();
          updateStats();
          renderApiList();
          document.getElementById('bulkApiKeys').value = '';
          console.log(`âœ… æ‰¹é‡å¯¼å…¥å®Œæˆï¼Œå…±æ·»åŠ  ${added} ä¸ªAPI`);
        } catch (error) {
          console.error('âŒ ä¿å­˜å¤±è´¥:', error);
          showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
          return;
        }
      }
      
      showMessage(
        `å¯¼å…¥å®Œæˆï¼\næˆåŠŸ: ${added}\né‡å¤: ${duplicate}\næ— æ•ˆ: ${invalid}`,
        added > 0 ? 'success' : 'warning'
      );
    }
    
    // åˆ é™¤API
    async function deleteApi(apiKey) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPI Keyå—ï¼Ÿ')) {
        apiPool = apiPool.filter(api => api.apiKey !== apiKey);
        await saveApiPool();
        updateStats();
        renderApiList();
        showMessage('API Keyå·²åˆ é™¤', 'success');
      }
    }
    
    // åˆ‡æ¢APIçŠ¶æ€
    async function toggleApiStatus(apiKey) {
      const api = apiPool.find(a => a.apiKey === apiKey);
      if (!api) return;
      
      const statusCycle = { active: 'disabled', disabled: 'active', exhausted: 'active' };
      api.status = statusCycle[api.status];
      
      await saveApiPool();
      updateStats();
      renderApiList();
      
      const statusText = { active: 'å¯ç”¨', disabled: 'å·²ç¦ç”¨', exhausted: 'å·²ç”¨å°½' };
      showMessage(`çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${statusText[api.status]}`, 'success');
    }
    
    // é‡ç½®æ‰€æœ‰çŠ¶æ€ä¸ºactive
    async function resetAllStatus() {
      if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰APIçŠ¶æ€ä¸º"å¯ç”¨"å—ï¼Ÿ')) {
        apiPool.forEach(api => {
          if (api.status === 'exhausted') {
            api.status = 'active';
          }
        });
        
        await saveApiPool();
        updateStats();
        renderApiList();
        showMessage('æ‰€æœ‰é…é¢å·²é‡ç½®', 'success');
      }
    }
    
    // æ¸…ç©ºå…¨éƒ¨API
    async function clearAllApis() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰API Keyså—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰APIå—ï¼Ÿ')) {
          apiPool = [];
          await saveApiPool();
          updateStats();
          renderApiList();
          showMessage('æ‰€æœ‰APIå·²æ¸…ç©º', 'success');
        }
      }
    }
    
    // å¯¼å‡ºAPIåˆ—è¡¨
    function exportApis() {
      if (apiPool.length === 0) {
        showMessage('æ²¡æœ‰APIå¯å¯¼å‡º', 'warning');
        return;
      }
      
      const content = apiPool.map(api => api.apiKey).join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `api_keys_${new Date().toISOString().split('T')[0]}.txt`;
      link.click();
      
      showMessage(`å·²å¯¼å‡º ${apiPool.length} ä¸ªAPI Keys`, 'success');
    }
    
    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      document.getElementById('totalApis').textContent = apiPool.length;
      document.getElementById('activeApis').textContent = apiPool.filter(a => a.status === 'active').length;
      document.getElementById('exhaustedApis').textContent = apiPool.filter(a => a.status === 'exhausted').length;
      document.getElementById('disabledApis').textContent = apiPool.filter(a => a.status === 'disabled').length;
    }
    
    // æ¸²æŸ“APIåˆ—è¡¨
    function renderApiList() {
      const listDiv = document.getElementById('apiList');
      
      if (apiPool.length === 0) {
        listDiv.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ”‘</div>
            <h3>æš‚æ— API Key</h3>
            <p>è¯·åœ¨ä¸Šæ–¹æ·»åŠ YouTube API Key</p>
          </div>
        `;
        return;
      }
      
      const statusText = {
        active: 'âœ… å¯ç”¨',
        exhausted: 'âš ï¸ é…é¢ç”¨å°½',
        disabled: 'ğŸš« å·²ç¦ç”¨'
      };
      
      const statusClass = {
        active: 'status-active',
        exhausted: 'status-exhausted',
        disabled: 'status-disabled'
      };
      
      listDiv.innerHTML = apiPool.map((api, index) => `
        <div class="api-card">
          <div class="api-card-header">
            <div class="api-title">
              <span>API Key #${index + 1}</span>
              <span class="api-status ${statusClass[api.status]}">${statusText[api.status]}</span>
            </div>
          </div>
          <div class="api-key-display">${api.apiKey}</div>
          <div class="info-text">
            æ·»åŠ æ—¶é—´: ${formatDate(api.addedAt)}
            ${api.lastUsed ? ` | æœ€åä½¿ç”¨: ${formatDate(api.lastUsed)}` : ''}
            ${api.usageCount ? ` | ä½¿ç”¨æ¬¡æ•°: ${api.usageCount}` : ''}
          </div>
          <div class="api-actions">
            <button class="btn btn-sm btn-secondary" onclick="toggleApiStatus('${api.apiKey}')">
              ${api.status === 'active' ? 'ğŸš« ç¦ç”¨' : 'âœ… å¯ç”¨'}
            </button>
            <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${api.apiKey}')">ğŸ“‹ å¤åˆ¶</button>
            <button class="btn btn-sm btn-danger" onclick="deleteApi('${api.apiKey}')">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(err => {
        showMessage('å¤åˆ¶å¤±è´¥', 'error');
      });
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}`;
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type, duration = 3000) {
      const messageDiv = document.getElementById('messageDiv');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = message.replace(/\n/g, '<br>');
      messageDiv.style.display = 'block';
      
      if (window.messageTimer) {
        clearTimeout(window.messageTimer);
      }
      
      if (type !== 'warning') {
        window.messageTimer = setTimeout(() => {
          messageDiv.style.display = 'none';
        }, duration);
      }
    }
    
    // å¼ºåˆ¶é‡ç½®æ•°æ®åº“
    async function forceResetDatabase() {
      if (!confirm('âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆAPIæ± ã€åšä¸»åˆ—è¡¨ã€ç›‘æ§æ•°æ®ç­‰ï¼‰ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ å¼€å§‹å¼ºåˆ¶é‡ç½®æ•°æ®åº“...');
        showMessage('æ­£åœ¨é‡ç½®æ•°æ®åº“...', 'warning', 3000);
        
        // å…³é—­ç°æœ‰è¿æ¥
        if (db) {
          db.close();
          db = null;
        }
        
        // åˆ é™¤æ•°æ®åº“
        await new Promise((resolve, reject) => {
          const deleteRequest = indexedDB.deleteDatabase('YouTubeToolDB');
          deleteRequest.onsuccess = () => {
            console.log('âœ… æ•°æ®åº“å·²åˆ é™¤');
            resolve();
          };
          deleteRequest.onerror = () => {
            console.error('âŒ åˆ é™¤æ•°æ®åº“å¤±è´¥');
            reject(deleteRequest.error);
          };
        });
        
        // ç­‰å¾…ä¸€ä¸‹
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // é‡æ–°åˆå§‹åŒ–
        await initDB();
        await loadApiPool();
        updateStats();
        renderApiList();
        
        isInitialized = true;
        showMessage('âœ… æ•°æ®åº“é‡ç½®æˆåŠŸï¼', 'success', 3000);
        console.log('âœ… æ•°æ®åº“é‡ç½®å®Œæˆ');
        
      } catch (error) {
        console.error('âŒ é‡ç½®å¤±è´¥:', error);
        showMessage('é‡ç½®å¤±è´¥: ' + error.message + '\nè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢', 'error', 10000);
      }
    }
    
    // åˆå§‹åŒ–
    window.onload = async function() {
      let retryCount = 0;
      const maxRetries = 3;
      
      while (retryCount < maxRetries) {
        try {
          console.log(`ğŸ“± å¼€å§‹åˆå§‹åŒ–APIæ± ç®¡ç†å·¥å…·... (å°è¯• ${retryCount + 1}/${maxRetries})`);
          
          await initDB();
          console.log('âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
          
          await loadApiPool();
          console.log(`âœ… APIæ± åŠ è½½å®Œæˆ, å…± ${apiPool.length} ä¸ªAPI`);
          
          updateStats();
          console.log('âœ… ç»Ÿè®¡æ›´æ–°å®Œæˆ');
          
          renderApiList();
          console.log('âœ… åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
          
          // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
          isInitialized = true;
          console.log('ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼');
          
          if (apiPool.length === 0) {
            showMessage('å½“å‰æ²¡æœ‰API Keyï¼Œè¯·æ·»åŠ API Keyå¼€å§‹ä½¿ç”¨', 'warning', 5000);
          } else {
            showMessage(`å·²åŠ è½½ ${apiPool.length} ä¸ªAPI Keys`, 'success', 3000);
          }
          
          return; // æˆåŠŸï¼Œé€€å‡º
          
        } catch (error) {
          retryCount++;
          console.error(`âŒ åˆå§‹åŒ–å¤±è´¥ (å°è¯• ${retryCount}/${maxRetries}):`, error);
          
          if (retryCount >= maxRetries) {
            // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
            isInitialized = false;
            showMessage(
              'âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥\n\n' +
              'å¯èƒ½åŸå› ï¼š\n' +
              '1. æµè§ˆå™¨éšç§æ¨¡å¼é™åˆ¶äº†IndexedDB\n' +
              '2. æ•°æ®åº“æ–‡ä»¶æŸå\n' +
              '3. ç£ç›˜ç©ºé—´ä¸è¶³\n\n' +
              'å»ºè®®ï¼š\n' +
              'â€¢ å…³é—­å…¶ä»–ä½¿ç”¨è¯¥å·¥å…·çš„æ ‡ç­¾é¡µ\n' +
              'â€¢ åˆ·æ–°é¡µé¢é‡è¯•\n' +
              'â€¢ ç‚¹å‡»ä¸‹æ–¹"æ¸…ç©ºå…¨éƒ¨"æŒ‰é’®é‡ç½®æ•°æ®åº“',
              'error',
              15000
            );
            
            // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿå°è¯•æ¸²æŸ“ç•Œé¢
            updateStats();
            renderApiList();
            
            // æ·»åŠ é‡ç½®æŒ‰é’®æç¤º
            const statusDiv = document.querySelector('.api-list');
            if (statusDiv) {
              const resetBtn = document.createElement('div');
              resetBtn.style.cssText = 'padding: 30px; text-align: center;';
              resetBtn.innerHTML = `
                <p style="color: var(--p5-red); margin-bottom: 20px; font-size: 16px;">
                  âš ï¸ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•æ­£å¸¸ä½¿ç”¨
                </p>
                <button class="btn btn-danger" onclick="forceResetDatabase()" style="margin: 0 auto;">
                  ğŸ”„ é‡ç½®æ•°æ®åº“
                </button>
              `;
              statusDiv.insertBefore(resetBtn, statusDiv.firstChild);
            }
          } else {
            // è¿˜æœ‰é‡è¯•æœºä¼šï¼Œç­‰å¾…åé‡è¯•
            console.log(`â³ ç­‰å¾… 1 ç§’åé‡è¯•...`);
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      }
    };
    
    // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
      const navMenu = document.querySelector('.nav-menu');
      
      if (mobileMenuBtn && navMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          navMenu.classList.toggle('show');
          mobileMenuBtn.setAttribute('aria-expanded', navMenu.classList.contains('show') ? 'true' : 'false');
        });
        
        // ç‚¹å‡»å¯¼èˆªé“¾æ¥åå…³é—­èœå•
        const navLinks = navMenu.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', function() {
            navMenu.classList.remove('show');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
          });
        });
      }
    });
  </script>
</body>
</html>

